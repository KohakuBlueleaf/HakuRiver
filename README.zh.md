# HakuRiver - è¿·ä½ è³‡æºèª¿åº¦å™¨

[![License](https://img.shields.io/badge/License-Apache_2.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

![HakuRiver logo svg](image/logo.svg)

***æ­¤å°ˆæ¡ˆç‚ºå¯¦é©—æ€§è³ªï¼Œè«‹è‡ªè¡Œæ‰¿æ“”ä½¿ç”¨é¢¨éšª***

**HakuRiver** æ˜¯ä¸€å€‹è¼•é‡ç´šã€å¯è‡ªè¡Œè¨—ç®¡çš„å¢é›†ç®¡ç†å™¨ï¼Œè¨­è¨ˆç”¨æ–¼å°‡å‘½ä»¤åˆ—ä»»å‹™åˆ†ç™¼åˆ°ä¸åŒçš„è¨ˆç®—ç¯€é»ä¸Šã€‚å®ƒå°ˆæ³¨æ–¼åˆ†é… CPU æ ¸å¿ƒï¼ˆé€é **systemd CPU é…é¡**ï¼‰å’Œè¨˜æ†¶é«”é™åˆ¶ï¼Œç®¡ç†ä»»å‹™ç”Ÿå‘½é€±æœŸï¼Œä¸¦ä¸”ç¾åœ¨æä¾› **NUMA ç¯€é»æŒ‡å®š**å’Œ**å¤šç¯€é»ä»»å‹™æäº¤**åŠŸèƒ½ã€‚

å®ƒåˆ©ç”¨ **systemd** é€²è¡ŒåŸ·è¡Œå’ŒåŸºæœ¬çš„æ²™ç›’åŒ– (`PrivateNetwork`ã€`PrivatePID`)ã€‚HakuRiver éå¸¸é©åˆå°å‹ç ”ç©¶å¢é›†ã€é–‹ç™¼ç’°å¢ƒæˆ–å…§éƒ¨æ‰¹æ¬¡è™•ç†ç³»çµ±ï¼Œåœ¨é€™äº›å ´æ™¯ä¸‹ï¼ŒåŠŸèƒ½å®Œå‚™çš„é«˜æ•ˆèƒ½è¨ˆç®— (HPC) æ’ç¨‹å™¨å¯èƒ½éæ–¼è¤‡é›œï¼Œä½†ä»éœ€è¦ä¸€å®šç¨‹åº¦çš„è³‡æºæ§åˆ¶å’Œåˆ†ç™¼èƒ½åŠ›ã€‚

---

## ğŸ¤” HakuRiver çš„é©ç”¨ç¯„åœï¼ˆèˆ‡ä¸é©ç”¨ç¯„åœï¼‰

| HakuRiver é©ç”¨æ–¼...                                                                                     | HakuRiver ä¸é©ç”¨æ–¼...                                                                                                      |
| :-------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------- |
| âœ… åœ¨å°å‹å¢é›†ï¼ˆä¾‹å¦‚ < 10 å€‹ç¯€é»ï¼‰ä¸­ç®¡ç†å‘½ä»¤åˆ—ä»»å‹™/è…³æœ¬ã€‚                                                    | âŒ åœ¨å¤§å‹å¢é›†ä¸Šå–ä»£åŠŸèƒ½è±å¯Œçš„ HPC æ’ç¨‹å™¨ï¼ˆSlurmã€PBSã€LSFï¼‰ã€‚                                                                  |
| âœ… å°‡ä»»å‹™åˆ†ç™¼åˆ°ç‰¹å®šçš„ **NUMA ç¯€é»** ä»¥é€²è¡Œæ•ˆèƒ½èª¿å„ª (`numactl`)ã€‚                                          | âŒ è¤‡é›œçš„è³‡æºç®¡ç†ï¼Œè¶…å‡º CPU é…é¡ã€è¨˜æ†¶é«”é™åˆ¶å’Œ NUMA ç¶å®šï¼ˆä¾‹å¦‚ GPU æ’ç¨‹ã€ç¶²è·¯é »å¯¬ã€æˆæ¬Šç®¡ç†ï¼‰ã€‚                                |
| âœ… æäº¤å–®ä¸€å‘½ä»¤ï¼Œä½¿å…¶åŒæ™‚åœ¨**å¤šå€‹ç¯€é»æˆ– NUMA ç¯€é»**ä¸Šé‹è¡Œã€‚                                                  | âŒ è¤‡é›œçš„ä»»å‹™ä¾è³´ç®¡ç†æˆ–å·¥ä½œæµç¨‹ç·¨æ’ï¼ˆè«‹ä½¿ç”¨ Airflowã€Prefectã€Snakemakeã€Nextflowï¼‰ã€‚                                      |
| âœ… éœ€è¦æ¯”è¤‡é›œæ’ç¨‹å™¨æ›´ç°¡å–®æ›¿ä»£æ–¹æ¡ˆçš„é–‹ç™¼ã€æ¸¬è©¦æˆ–å°å‹ç ”ç©¶è¨­ç½®ã€‚                                               | âŒ é€²éšçš„æ’ç¨‹ç­–ç•¥ï¼ˆå…¬å¹³åˆ†äº«ã€æ¶ä½”ã€å›å¡«ã€è¤‡é›œå„ªå…ˆç´šï¼‰ã€‚HakuRiver ä½¿ç”¨ç›´æ¥ç”±ä½¿ç”¨è€…æŒ‡å®šç›®æ¨™çš„æ–¹å¼ã€‚                               |
| âœ… åªéœ€è¦åŸºæœ¬çš„ä½œæ¥­æäº¤ã€ç‹€æ…‹æª¢æŸ¥ã€æ—¥èªŒæª¢ç´¢å’Œçµ‚æ­¢åŠŸèƒ½çš„å…§éƒ¨å·¥å…·ã€‚                                           | âŒ éœ€è¦å¼·å¤§å…§å»ºé©—è­‰/æˆæ¬Šï¼ˆè¶…å‡ºç¶²è·¯å¯å­˜å–æ€§ï¼‰çš„é«˜å®‰å…¨æ€§ã€å¤šç§Ÿæˆ¶ç’°å¢ƒã€‚                                                       |
| âœ… ä¸»è¦é‹è¡Œ CPU/è¨˜æ†¶é«”å¯†é›†å‹æ‡‰ç”¨ç¨‹å¼ã€‚                                                                    | âŒ è‡ªå‹•å„ªåŒ– NUMA ä½ˆå±€ â€“ ä½¿ç”¨è€…éœ€æŒ‡å®šç›®æ¨™ã€‚                                                                                  |
| âœ… ä½¿ç”¨å…§é™„çš„ `hakurun` å·¥å…·åœ¨æäº¤åˆ°å¢é›†*ä¹‹å‰*é€²è¡Œæœ¬åœ°åƒæ•¸æƒæã€‚                                          | âŒ ç”¨å¢é›†æäº¤å–ä»£ `hakurun` æœ¬èº« â€“ å®ƒå€‘æœå‹™æ–¼ä¸åŒç›®çš„ï¼ˆæœ¬åœ° vs åˆ†æ•£å¼ï¼‰ã€‚                                                   |

---

## âœ¨ åŠŸèƒ½ç‰¹è‰²

*   **é€é systemd é€²è¡Œ CPU/RAM è³‡æºåˆ†é…ï¼š** ä½œæ¥­è«‹æ±‚ CPU æ ¸å¿ƒï¼ˆå¼·åˆ¶åŸ·è¡Œç‚º **CPU é…é¡ç™¾åˆ†æ¯”**ï¼‰å’Œ**è¨˜æ†¶é«”é™åˆ¶**ï¼Œé€é `systemd-run` æ‡‰ç”¨ã€‚
*   **åŸºæ–¼ Systemd çš„ä»»å‹™åŸ·è¡Œï¼š** ä»»å‹™ä½œç‚ºæš«æ…‹çš„ systemd scope å–®å…ƒé‹è¡Œ (`systemd-run --scope`)ï¼Œä»¥å¯¦ç¾æ›´å¥½çš„ç”Ÿå‘½é€±æœŸç®¡ç†å’Œè³‡æºæ ¸ç®—ã€‚
*   **NUMA ç¯€é»æŒ‡å®šï¼š** å¯é¸æ“‡ä½¿ç”¨ `numactl` å°‡ä»»å‹™ç¶å®šåˆ°ç‰¹å®šçš„ NUMA ç¯€é»ï¼ˆéœ€è¦åœ¨ Runner ä¸Šå®‰è£ `numactl` ä¸¦è¨­å®šè·¯å¾‘ï¼‰ã€‚
*   **å¤šç¯€é»/NUMA ä»»å‹™æäº¤ï¼š** æäº¤å–®ä¸€è«‹æ±‚ï¼Œå³å¯åœ¨å¤šå€‹æŒ‡å®šç¯€é»æˆ–ç¯€é»å…§çš„ç‰¹å®š NUMA ç¯€é»ä¸Šé‹è¡Œç›¸åŒçš„å‘½ä»¤ã€‚
*   **å¯é¸çš„æ²™ç›’åŒ–ï¼š** å¯é‡å°æ¯å€‹ä»»å‹™æ‰¹æ¬¡è¨­å®šåŸºæœ¬çš„ systemd æ²™ç›’åŒ– (`PrivateNetwork=yes`ã€`PrivatePIDs=yes`)ã€‚
*   **æŒä¹…åŒ–çš„ä»»å‹™èˆ‡ç¯€é»è¨˜éŒ„ï¼š** Host ç¶­è­·ä¸€å€‹ SQLite è³‡æ–™åº«ï¼Œè¨˜éŒ„ç¯€é»ï¼ˆåŒ…å«åµæ¸¬åˆ°çš„ NUMA æ‹“æ’²ï¼‰å’Œä»»å‹™ï¼ˆç‹€æ…‹ã€ç›®æ¨™ã€è³‡æºè«‹æ±‚ã€æ—¥èªŒï¼‰ã€‚
*   **ç¯€é»å¥åº·èˆ‡è³‡æºæ„ŸçŸ¥ï¼š** åŸºæœ¬çš„å¿ƒè·³æ©Ÿåˆ¶å¯åµæ¸¬é›¢ç·šçš„ Runnerã€‚Runner å›å ±æ•´é«”çš„ CPU/è¨˜æ†¶é«”ä½¿ç”¨ç‡å’Œ NUMA æ‹“æ’²ã€‚
*   **ç¨ç«‹çš„åƒæ•¸æƒæå·¥å…· (`hakurun`)ï¼š** ç”¨æ–¼åœ¨æäº¤åˆ°å¢é›†å‰é€²è¡Œæœ¬åœ°åƒæ•¸æƒæ (`span:{..}`ã€`span:[]`) çš„å·¥å…·ã€‚æå‡äº†å¹³è¡Œ Python åŸ·è¡Œçš„ç©©å¥æ€§ã€‚
*   **ç¶²é å„€è¡¨æ¿ (å¯¦é©—æ€§)ï¼š** Vue.js å‰ç«¯ï¼Œç”¨æ–¼è¦–è¦ºåŒ–ç›£æ§ã€ä»»å‹™æäº¤ï¼ˆåŒ…å«å¤šç›®æ¨™ï¼‰ã€ç‹€æ…‹æª¢æŸ¥å’Œçµ‚æ­¢ä»»å‹™ã€‚

## ğŸ—ï¸ æ¶æ§‹æ¦‚è§€

```ascii
+-----------------+      HTTP API       +-----------------+      HTTP API       +--------------------+
|  Client (CLI)   |<------------------->|   Host Server   |<------------------->|  Frontend (Web UI) |
| (hakuriver.cli) | (Submit, Status,    | (hakuriver.core)| (Node/Task Data,    | (Vue.js)           |
|                 |  Kill, List, ...)   |  - FastAPI      |  Submit, Kill)      |  - Monitoring      |
|                 |                     |  - Peewee (DB)  |                     |  - Submit Task     |
|                 |                     |  - Scheduling*  |                     |  - Check result    |
+-----------------+                     |  - State Mgmt   |                     +--------------------+
                                        +--------+--------+
                                                 | â–²  â”‚ Registration, Heartbeat, Status Update
                                                 â”‚ â”‚  â–¼ Task Execution Command, Kill Command
                                        +--------â–¼-+-------------+      +------------------------+
                                        | Runner Agent (Node 1)  |      | Runner Agent (Node N)  |
                                        | (hakuriver.core)       |      | (hakuriver.core)       |
                                        |  - FastAPI             |      |  - FastAPI             |
                                        |  - NUMA Detect         |      |  - NUMA Detect         |
                                        |  - systemd-run (+sudo) |      |  - systemd-run (+sudo) |
                                        |  - numactl             |      |  - numactl             |
                                        +------------------------+      +------------------------+
                                                    â”‚                               â”‚
 Shared Filesystem (NFS, etc.)                      â”‚ Access (Scripts, Output)      â”‚ Access (Scripts, Output)
+----------------------------------+                â–¼                               â–¼
| /path/to/shared_dir              |<------------------------------------------------
|  - scripts/                      |                â”‚                               â”‚
|  - task_outputs/ (*.out)         |                â”‚ Access (Temporary data)       â”‚ Access (Temporary data)
|  - task_errors/  (*.err)         |                â–¼                               â–¼
+----------------------------------+    Node 1 Local Filesystem         Node N Local Filesystem
                                       +--------------------------+     +--------------------------+
                                       | /path/to/local_temp_dir  |     | /path/to/local_temp_dir  |
                                       +--------------------------+     +--------------------------+

 Host Local Filesystem
+----------------------------------+
| /path/to/database/cluster.db     |
+----------------------------------+

* Scheduling: Host validates targets & resources but relies on user specification via Client/Frontend.
```

*   **Host (`hakuriver.host`)ï¼š** ä¸­å¤®å”èª¿è€…ã€‚ç®¡ç†ç¯€é»è¨»å†Šï¼ˆåŒ…æ‹¬ NUMA æ‹“æ’²ï¼‰ã€è¿½è¹¤ç¯€é»ç‹€æ…‹/è³‡æºã€å°‡ä»»å‹™è³‡è¨Šå„²å­˜åœ¨è³‡æ–™åº«ä¸­ã€æ¥æ”¶ä»»å‹™æäº¤è«‹æ±‚ï¼ˆåŒ…æ‹¬å¤šç›®æ¨™ï¼‰ã€é©—è­‰ç›®æ¨™ã€ç”¢ç”Ÿå”¯ä¸€çš„ä»»å‹™ IDï¼Œä¸¦å°‡å€‹åˆ¥ä»»å‹™å¯¦ä¾‹åˆ†æ´¾çµ¦é©ç•¶çš„ Runnerã€‚
*   **Runner (`hakuriver.runner`)ï¼š** é‹è¡Œåœ¨æ¯å€‹è¨ˆç®—ç¯€é»ä¸Šçš„ä»£ç†ç¨‹å¼ã€‚åµæ¸¬ NUMA æ‹“æ’²ï¼ˆé€é `numactl`ï¼‰ã€å‘ Host è¨»å†Šï¼ˆå›å ±æ ¸å¿ƒæ•¸ã€RAMã€NUMA è³‡è¨Šã€URLï¼‰ã€‚å®šæœŸç™¼é€å¿ƒè·³ï¼ˆåŒ…å« CPU/è¨˜æ†¶é«”ä½¿ç”¨ç‡ï¼‰ã€‚ä½¿ç”¨ `sudo systemd-run` åŸ·è¡Œè¢«æŒ‡æ´¾çš„ä»»å‹™ï¼Œæ‡‰ç”¨ CPU é…é¡ã€è¨˜æ†¶é«”é™åˆ¶ã€å¯é¸çš„æ²™ç›’åŒ–ä»¥åŠå¯é¸çš„ `numactl` ç¶å®šã€‚å°‡ä»»å‹™ç‹€æ…‹æ›´æ–°å›å ±çµ¦ Hostã€‚**éœ€è¦ç‚º `systemd-run` å’Œ `systemctl` é…ç½®ç„¡å¯†ç¢¼ `sudo`ã€‚**
*   **Client (`hakuriver.client`)ï¼š** å‘½ä»¤åˆ—å·¥å…·ã€‚èˆ‡ Host é€šè¨Šä»¥æäº¤ä»»å‹™ï¼ˆæŒ‡å®šå‘½ä»¤ã€åƒæ•¸ã€ç’°å¢ƒè®Šæ•¸ã€è³‡æºï¼Œä»¥åŠ**ä¸€å€‹æˆ–å¤šå€‹ç›®æ¨™**ï¼Œå¦‚ `host1` æˆ– `host1:0`ï¼‰ã€æŸ¥è©¢ä»»å‹™/ç¯€é»ç‹€æ…‹ï¼ˆåŒ…å« NUMA è³‡è¨Šï¼‰ï¼Œä»¥åŠçµ‚æ­¢ä»»å‹™ã€‚
*   **Frontendï¼š** å¯é¸çš„ç¶²é ä»‹é¢ï¼Œæä¾›é¡ä¼¼æ–¼ Client çš„è¦–è¦ºåŒ–æ¦‚è¦½å’Œäº’å‹•åŠŸèƒ½ã€‚
*   **Databaseï¼š** Host ä½¿ç”¨ SQLiteï¼ˆé€é Peeweeï¼‰ä¾†å„²å­˜ç¯€é»æ¸…å–®ï¼ˆåŒ…å« NUMA æ‹“æ’²ï¼Œä»¥ JSON æ ¼å¼å„²å­˜ï¼‰å’Œä»»å‹™è©³ç´°è³‡è¨Šï¼ˆåŒ…å«ç›®æ¨™ NUMA IDã€æ‰¹æ¬¡ IDï¼‰ã€‚
*   **Storageï¼š**
    *   **Shared (`shared_dir`)ï¼š** åœ¨ Host å’Œæ‰€æœ‰ Runner ä¸Šæ›è¼‰æ–¼ç›¸åŒè·¯å¾‘ã€‚å°æ–¼ä»»å‹™è¼¸å‡ºæ—¥èªŒï¼ˆ`*.out`ã€`*.err`ï¼‰ä»¥åŠå¯èƒ½å…±äº«çš„è…³æœ¬/è³‡æ–™è‡³é—œé‡è¦ã€‚
    *   **Local Temp (`local_temp_dir`)ï¼š** ç¯€é»ç‰¹å®šçš„å¿«é€Ÿå„²å­˜ç©ºé–“ï¼Œå…¶è·¯å¾‘æœƒä½œç‚º `HAKURIVER_LOCAL_TEMP_DIR` ç’°å¢ƒè®Šæ•¸æ³¨å…¥çµ¦ä»»å‹™ä½¿ç”¨ã€‚

---

## ğŸš€ é–‹å§‹ä½¿ç”¨

### å®‰è£

1.  è¤‡è£½å„²å­˜åº«ï¼š
    ```bash
    git clone https://github.com/KohakuBlueleaf/HakuRiver.git
    cd HakuRiver
    ```
2.  å®‰è£å¥—ä»¶ï¼ˆå»ºè­°åœ¨è™›æ“¬ç’°å¢ƒä¸­é€²è¡Œï¼‰ï¼š
    ```bash
    # å®‰è£ hakuriver åŠå…¶ä¾è³´é …
    pip install .
    # æˆ–ç”¨æ–¼é–‹ç™¼ï¼š
    # pip install -e .
    ```

    é€™å°‡ä½¿ `hakurun`ã€`hakuriver.host`ã€`hakuriver.runner` å’Œ `hakuriver.client` å¯ç”¨ã€‚
3.  **(Runner ç¯€é»)** å¦‚æœæ‚¨æ‰“ç®—ä½¿ç”¨ NUMA æŒ‡å®šåŠŸèƒ½ï¼Œè«‹å®‰è£ `numactl`ï¼š
    ```bash
    # Debian/Ubuntu ç¯„ä¾‹
    sudo apt update && sudo apt install numactl
    # CentOS/RHEL ç¯„ä¾‹
    sudo yum install numactl
    ```

---

## `hakurun`ï¼šæœ¬åœ°åƒæ•¸æƒæå·¥å…·

`hakurun` å¯å”åŠ©**åœ¨æœ¬åœ°**é‹è¡Œå¸¶æœ‰å¤šç¨®åƒæ•¸çµ„åˆçš„å‘½ä»¤æˆ– Python è…³æœ¬ï¼Œé€™åœ¨æäº¤åˆ° HakuRiver å¢é›†å‰é€²è¡Œæ¸¬è©¦å¾ˆæœ‰ç”¨ã€‚

*   **åƒæ•¸æƒæï¼š**
    *   `span:{start..end}` -> æ•´æ•¸ï¼ˆä¾‹å¦‚ `span:{1..3}` -> `1`, `2`, `3`ï¼‰
    *   `span:[a,b,c]` -> åˆ—è¡¨é …ç›®ï¼ˆä¾‹å¦‚ `span:[foo,bar]` -> `"foo"`, `"bar"`ï¼‰
*   **åŸ·è¡Œï¼š** é‹è¡Œæ‰€æœ‰æƒæåƒæ•¸çš„ç¬›å¡çˆ¾ç©ã€‚ä½¿ç”¨ `--parallel` é€éå­è™•ç†ç¨‹åºä¸¦è¡Œé‹è¡Œçµ„åˆã€‚
*   **ç›®æ¨™ï¼š** é‹è¡Œ Python æ¨¡çµ„ (`mymod`)ã€å‡½å¼ (`mymod:myfunc`) æˆ–å¯åŸ·è¡Œæª” (`python script.py`, `my_executable`)ã€‚

**ç¯„ä¾‹ (`demo_hakurun.py`)ï¼š**

```python
# demo_hakurun.py
import sys, time, random, os # Added os import
time.sleep(random.random() * 0.1)
print(f"Args: {sys.argv[1:]}, PID: {os.getpid()}")
```

```bash
# åœ¨æœ¬åœ°ä¸¦è¡Œé‹è¡Œ 2 * 1 * 2 = 4 å€‹ä»»å‹™
hakurun --parallel python ./demo_hakurun.py span:{1..2} fixed_arg span:[input_a,input_b]
```

**æ³¨æ„ï¼š** `hakurun` æ˜¯ä¸€å€‹æœ¬åœ°è¼”åŠ©å·¥å…·ã€‚å®ƒ**ä¸æœƒ**èˆ‡ HakuRiver å¢é›†äº’å‹•ã€‚ç”¨å®ƒä¾†ç”¢ç”Ÿæ‚¨ç¨å¾Œå¯èƒ½æœƒä½¿ç”¨ `hakuriver.client` å–®ç¨æˆ–ä½œç‚ºæ‰¹æ¬¡æäº¤çš„å‘½ä»¤ã€‚

---

## ğŸ”§ è¨­å®š - HakuRiver

*   æ‚¨å¯ä»¥ä½¿ç”¨ `hakuriver.init` å»ºç«‹ä¸€å€‹å…¨åŸŸé è¨­è¨­å®šæª”ï¼Œæ­¤å‘½ä»¤æœƒåœ¨ `~/.hakuriver/config.toml` ä¸­å»ºç«‹ä¸€å€‹é è¨­è¨­å®šæª”ï¼Œæ‰€æœ‰å‘½ä»¤é è¨­æœƒä½¿ç”¨æ­¤è¨­å®šæª”ã€‚
*   é è¨­è¨­å®šæª”å…§å®¹ï¼š`src/hakuriver/utils/default_config.toml`ã€‚
*   å°æ–¼ä»»ä½• `hakuriver.*` å‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨ `--config /path/to/custom.toml` ä¾†è¦†è“‹ã€‚
*   **éœ€è¦æª¢è¦–/ç·¨è¼¯çš„é—œéµè¨­å®šï¼š**
    *   `[network] host_reachable_address`ï¼š**å¿…é ˆ**æ˜¯ Runner å’Œ Client å¯é€£ç·šåˆ°çš„ Host çš„ IP/ä¸»æ©Ÿåç¨±ã€‚
    *   `[network] runner_address`ï¼š**å¿…é ˆ**æ˜¯ Host å¯é€£ç·šåˆ°çš„ Runner çš„ IP/ä¸»æ©Ÿåç¨±ã€‚
    *   `[paths] shared_dir`ï¼šå…±äº«å„²å­˜çš„çµ•å°è·¯å¾‘ï¼ˆå¿…é ˆå­˜åœ¨ä¸”åœ¨ Runner ç¯€é»ä¸Šå¯å¯«ï¼Œåœ¨ Host ç¯€é»ä¸Šå¯è®€ï¼‰ã€‚
    *   `[paths] local_temp_dir`ï¼šæœ¬åœ°æš«å­˜å„²å­˜çš„çµ•å°è·¯å¾‘ï¼ˆå¿…é ˆå­˜åœ¨ä¸”åœ¨ Runner ç¯€é»ä¸Šå¯å¯«ï¼‰ã€‚
    *   `[paths] numactl_path`ï¼šRunner ç¯€é»ä¸Š `numactl` å¯åŸ·è¡Œæª”çš„çµ•å°è·¯å¾‘ï¼ˆä¾‹å¦‚ `/usr/bin/numactl`ï¼‰ã€‚å¦‚æœç‚ºç©ºï¼ŒRunner å°‡å˜—è©¦ç›´æ¥ä½¿ç”¨ `numactl`ã€‚
    *   `[database] db_file`ï¼šHost çš„ SQLite è³‡æ–™åº«è·¯å¾‘ã€‚è«‹ç¢ºä¿ç›®éŒ„å­˜åœ¨ã€‚

---

## ğŸ’» ä½¿ç”¨æ–¹å¼ - HakuRiver å¢é›†

**1. åˆå§‹åŒ–è³‡æ–™åº« (åœ¨ Host æ©Ÿå™¨ä¸Šé‹è¡Œä¸€æ¬¡)ï¼š**
   Host æœƒåœ¨å•Ÿå‹•æ™‚å˜—è©¦æ­¤æ“ä½œã€‚ç¢ºä¿ `db_file` çš„ç›®éŒ„å­˜åœ¨ä¸”å¯å¯«ã€‚å¦‚æœå‡ç´šæ™‚æœ‰çµæ§‹è®Šæ›´ï¼Œè«‹åˆªé™¤è³‡æ–™åº«æª”æ¡ˆã€‚

**2. å•Ÿå‹• Host ä¼ºæœå™¨ (åœ¨ç®¡ç†ç¯€é»ä¸Š)ï¼š**

```bash
   hakuriver.host
   # ä½¿ç”¨è‡ªè¨‚è¨­å®šæª”ï¼š
   # hakuriver.host --config /path/to/host_config.toml
```

**3. å•Ÿå‹• Runner ä»£ç†ç¨‹å¼ (åœ¨æ¯å€‹è¨ˆç®—ç¯€é»ä¸Š)ï¼š**

```bash
   # é‡è¦ï¼šä»¥å…·æœ‰ NOPASSWD sudo æ¬Šé™çš„ä½¿ç”¨è€…èº«ä»½é‹è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
   # /usr/bin/systemd-run, /usr/bin/systemctl
   # (ç”¨æ–¼å•Ÿå‹•ä»»å‹™ã€è¨­å®šè³‡æºé™åˆ¶ã€çµ‚æ­¢ä»»å‹™ï¼Œå¦‚æœé€é sudo é‹è¡Œ numactl ä¹Ÿå¯èƒ½éœ€è¦)
   # sudoers ç¯„ä¾‹æ¢ç›®ï¼š
   # your_user ALL=(ALL) NOPASSWD: /usr/bin/systemd-run, /usr/bin/systemctl

   hakuriver.runner
   # ä½¿ç”¨è‡ªè¨‚è¨­å®šæª”ï¼š
   # hakuriver.runner --config /path/to/runner_config.toml
```

   *å¦‚æœæ‰¾åˆ°ä¸¦è¨­å®šäº† `numactl`ï¼ŒRunner å°‡åµæ¸¬ä¸¦å›å ±å…¶ NUMA æ‹“æ’²ã€‚*

**4. Systemd åŸ·è¡Œæ³¨æ„äº‹é …ï¼š**

*   é€é `systemd-run` é‹è¡Œçš„ä»»å‹™*ä¸æœƒ*ç¹¼æ‰¿ Runner çš„å·¥ä½œç›®éŒ„ï¼ˆé€šå¸¸åœ¨ä½¿ç”¨è€…å®¶ç›®éŒ„æˆ– `/` ä¸­å•Ÿå‹•ï¼‰ã€‚è«‹ä½¿ç”¨çµ•å°è·¯å¾‘æˆ–ç’°å¢ƒè®Šæ•¸ (`HAKURIVER_SHARED_DIR`, `HAKURIVER_LOCAL_TEMP_DIR`)ã€‚
*   ä»»å‹™ç’°å¢ƒåŒ…å«é€é `--env` è¨­å®šçš„è®Šæ•¸ã€`HAKURIVER_*` è®Šæ•¸ï¼Œä»¥åŠå¯èƒ½ç”± `systemd --user` å¯¦ä¾‹æˆ–ç³»çµ±å¯¦ä¾‹ç¹¼æ‰¿çš„è®Šæ•¸ï¼Œå…·é«”å–æ±ºæ–¼ `sudo` å¦‚ä½•èª¿ç”¨ `systemd-run`ã€‚
*   å¦‚æœä½¿ç”¨äº† `numactl`ï¼Œå®ƒæœƒåœ¨ systemd scope å…§å°‡ `numactl` å‘½ä»¤åŠ åœ¨ä½¿ç”¨è€…çš„å¯¦éš›å‘½ä»¤ä¹‹å‰ã€‚

**5. ä½¿ç”¨ Client (`hakuriver.client`)ï¼š**

| æ“ä½œ                        | æŒ‡ä»¤ç¯„ä¾‹                                                                                                                                       | å‚™è¨»                                                                         |
| :---------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------- |
| **åˆ—å‡ºç¯€é»**                  | `hakuriver.client --list-nodes`                                                                                                                | é¡¯ç¤ºç‹€æ…‹ã€æ ¸å¿ƒæ•¸ã€NUMA æ‘˜è¦ã€‚                                                |
| **ç¯€é»å¥åº·ç‹€æ³**              | `hakuriver.client --health` <br> `hakuriver.client --health <node-hostname>`                                                               | é¡¯ç¤ºè©³ç´°çµ±è¨ˆè³‡æ–™ï¼Œè‹¥å¯ç”¨å‰‡åŒ…å«å®Œæ•´çš„ NUMA æ‹“æ’²ã€‚                             |
| **æäº¤å–®ä¸€ä»»å‹™**              | `hakuriver.client --target <host1> --cores 1 -- echo "Basic Task"`                                                                               | åœ¨ `<host1>` ä¸Šçš„ä»»ä½•å¯ç”¨æ ¸å¿ƒä¸Šé‹è¡Œã€‚                                        |
| **æäº¤ (NUMA)**               | `hakuriver.client --target <host1>:0 --cores 2 --memory 1G -- ./my_numa_script.sh`                                                               | ç¶å®šåˆ° `<host1>` ä¸Šçš„ NUMA ç¯€é» 0 é‹è¡Œã€‚éœ€è¦åœ¨ Runner ä¸Šå®‰è£ `numactl`ã€‚      |
| **æäº¤ (å¤š NUMA)**            | `hakuriver.client --target <host1>:0 --target <host1>:1 --cores 1 -- ./process_shard.sh`                                                         | åœ¨ `<host1>` ä¸Šé‹è¡Œå…©å€‹ä»»å‹™å¯¦ä¾‹ï¼Œä¸€å€‹åœ¨ NUMA 0ï¼Œä¸€å€‹åœ¨ NUMA 1ã€‚                |
| **æäº¤ (å¤šç¯€é»)**             | `hakuriver.client --target <host1>:0 --target <host2> --cores 4 --env P=1 -- ./parallel_job.sh`                                                  | åœ¨ `<host1>` çš„ NUMA 0 å’Œ `<host2>` çš„ä»»ä½•æ ¸å¿ƒä¸Šé‹è¡Œã€‚                        |
| **æäº¤ (æ²™ç›’åŒ–)**             | `hakuriver.client --target <host1> --cores 1 --private-network --private-pid -- ./isolated_task.sh`                                              | æ‡‰ç”¨ systemd æ²™ç›’åŒ–é¸é …ã€‚                                                    |
| **æª¢æŸ¥ç‹€æ…‹**                  | `hakuriver.client --status <task_id>`                                                                                                            | é¡¯ç¤ºè©³ç´°ç‹€æ…‹ï¼ŒåŒ…å«ç›®æ¨™ NUMAã€æ‰¹æ¬¡ IDã€‚                                       |
| **çµ‚æ­¢ä»»å‹™**                  | `hakuriver.client --kill <task_id>`                                                                                                              | è«‹æ±‚çµ‚æ­¢ç‰¹å®šçš„ä»»å‹™å¯¦ä¾‹ã€‚                                                     |
| **æäº¤ + ç­‰å¾…**               | `hakuriver.client --target <host1>:0 --wait -- sleep 30`                                                                                         | ç­‰å¾…æŒ‡å®šçš„ä»»å‹™å®Œæˆã€‚å°æ–¼å¤šç›®æ¨™æäº¤è«‹è¬¹æ…ä½¿ç”¨ã€‚                               |
| **ä½¿ç”¨è‡ªè¨‚è¨­å®šæª”**            | `hakuriver.client --config client.toml --list-nodes`                                                                                             | è¼‰å…¥å®¢æˆ¶ç«¯è¨­å®šæª”è¦†è“‹ã€‚                                                       |
| **èˆ‡ hakurun çµåˆ (1)**     | `hakurun hakuriver.client --target <host1>:0 --cores 1 -- python script.py span:{1..10}<br>`(æäº¤ 10 å€‹ç¨ç«‹çš„ HakuRiver ä½œæ¥­)                 | ç”¨æ–¼æäº¤è¨±å¤šç›¸ä¼¼çš„*ç¨ç«‹*å¢é›†ä½œæ¥­ã€‚                                             |
| **èˆ‡ hakurun çµåˆ (2)**     | `hakuriver.client --target <host1>:0 --cores 4 -- hakurun --parallel python process.py span:{A..Z}<br>`(æäº¤ 1 å€‹é‹è¡Œ hakurun çš„ HakuRiver ä½œæ¥­) | ç”¨æ–¼å°‡è¨±å¤šå°å‹ç›¸é—œæ­¥é©Ÿåˆ†çµ„åˆ°*ä¸€å€‹*å¢é›†ä½œæ¥­ä¸­ã€‚                                 |

   **`--target` èªæ³•ï¼š**

| æ ¼å¼               | æè¿°                               |
| :------------------- | :--------------------------------- |
| `my-node`          | æŒ‡å®šç‰©ç†ç¯€é» `my-node`ã€‚           |
| `my-node:0`        | æŒ‡å®š `my-node` ä¸Šçš„ NUMA ç¯€é» 0ã€‚  |
| `another-node:1`   | æŒ‡å®š `another-node` ä¸Šçš„ NUMA ç¯€é» 1ã€‚ |

---

## ğŸŒ ä½¿ç”¨æ–¹å¼ - å‰ç«¯ç¶²é ä»‹é¢ (å¯¦é©—æ€§)

| æ¦‚è¦½                                           | ç¯€é»åˆ—è¡¨å’Œä»»å‹™åˆ—è¡¨                                                                          | å¾ç®¡ç†ä»‹é¢æäº¤ä»»å‹™                           |
| ---------------------------------------------- | ------------------------------------------------------------------------------------------- | ---------------------------------------------- |
| ![1744643963836](image/README/1744643963836.png) | ![1744643981874](image/README/1744643981874.png) ![1744643997740](image/README/1744643997740.png) | ![1744644009190](image/README/1744644009190.png) |

HakuRiver åŒ…å«ä¸€å€‹å¯é¸çš„ Vue.js å„€è¡¨æ¿ï¼Œç”¨æ–¼è¦–è¦ºåŒ–ç›£æ§å’Œç®¡ç†ã€‚

**å…ˆæ±ºæ¢ä»¶ï¼š**

*   Node.js å’Œ npm/yarn/pnpmã€‚
*   é‹è¡Œçš„ HakuRiver Hostï¼Œä¸¦ä¸”å¯ä»¥å¾æ‚¨é‹è¡Œå‰ç«¯é–‹ç™¼ä¼ºæœå™¨çš„åœ°æ–¹å­˜å–ã€‚

**è¨­å®šï¼š**

```bash
cd frontend
npm install
```

**é‹è¡Œ (é–‹ç™¼æ¨¡å¼)ï¼š**

1.  ç¢ºä¿ Host æ­£åœ¨é‹è¡Œ (ä¾‹å¦‚ `http://127.0.0.1:8000`)ã€‚
2.  å•Ÿå‹• Vite é–‹ç™¼ä¼ºæœå™¨ï¼š
    ```bash
    npm run dev
    ```
3.  é–‹å•Ÿæä¾›çš„ URL (ä¾‹å¦‚ `http://localhost:5173`)ã€‚
4.  é–‹ç™¼ä¼ºæœå™¨æœƒå°‡ `/api` è«‹æ±‚ä»£ç†åˆ° Host (è«‹åƒé–± `vite.config.js`)ã€‚
5.  **åŠŸèƒ½ï¼š**
    *   æŸ¥çœ‹ç¯€é»åˆ—è¡¨ã€ç‹€æ…‹ã€è³‡æºå’Œ **NUMA æ‹“æ’²**ã€‚
    *   æŸ¥çœ‹ä»»å‹™åˆ—è¡¨ã€è©³ç´°è³‡è¨Šï¼ˆåŒ…å«æ‰¹æ¬¡ IDã€ç›®æ¨™ NUMAï¼‰ã€æ—¥èªŒã€‚
    *   ä½¿ç”¨è¡¨å–®æäº¤æ–°ä»»å‹™ï¼Œè¡¨å–®åŒ…å«ä¸€å€‹**å¤šç›®æ¨™é¸æ“‡å™¨**ï¼Œå…è¨±é¸æ“‡ç¯€é»ç¯„åœæˆ–ç‰¹å®šçš„ NUMA ç¯€é»ã€‚
    *   çµ‚æ­¢é‹è¡Œä¸­çš„ä»»å‹™ã€‚

**å»ºç½® (ç”Ÿç”¢ç’°å¢ƒ)ï¼š**

1.  å»ºç½®éœæ…‹æª”æ¡ˆï¼š
    ```bash
    npm run build
    ```
2.  ä½¿ç”¨ä»»ä½•éœæ…‹ç¶²é ä¼ºæœå™¨ (Nginxã€Apache ç­‰) æä¾› `frontend/dist` ç›®éŒ„çš„å…§å®¹ã€‚
3.  **é‡è¦ï¼š** è¨­å®šæ‚¨çš„ç”Ÿç”¢ç¶²é ä¼ºæœå™¨ä»¥ä»£ç† API è«‹æ±‚ (ä¾‹å¦‚ï¼Œå° `/api/*` çš„è«‹æ±‚) åˆ°å¯¦éš›é‹è¡Œçš„ HakuRiver Host ä½å€å’ŒåŸ è™Ÿï¼Œé¡ä¼¼æ–¼ Vite é–‹ç™¼ä¼ºæœå™¨çš„ä»£ç†è¨­å®šï¼Œæˆ–è€…åœ¨å»ºç½®å‰ä¿®æ”¹ `src/services/api.js` ä»¥ä½¿ç”¨ Host çš„çµ•å° URLã€‚

## åŠŸèƒ½è©³æƒ…

### NUMA æ„ŸçŸ¥

ç¾ä»£çš„å¤šæ’æ§½æˆ–é«˜æ ¸å¿ƒæ•¸ CPU é€šå¸¸å…·æœ‰éå‡å‹»è¨˜æ†¶é«”å­˜å– (NUMA) æ¶æ§‹ã€‚å­˜å–èˆ‡é‹è¡Œä¸­ CPU æ ¸å¿ƒ*ç›¸åŒ* NUMA ç¯€é»ï¼ˆæ’æ§½ï¼‰ç›¸é€£çš„è¨˜æ†¶é«”ï¼Œæœƒæ¯”å­˜å–é€£æ¥åˆ°*ä¸åŒ* NUMA ç¯€é»çš„è¨˜æ†¶é«”æ›´å¿«ã€‚

```ascii
+------------------------------- Node: my-compute-01 ------------------------------+
| +------------- NUMA Node-------------+       +--------- NUMA Node 1 -----------+ |
| |  +--- Memory Bank 0 (64 GiB) ---+  |       | +--- Memory Bank 1 (64GiB) ---+ | â”‚
| |  |                              |  |       | |                             | | â”‚
| |  +------------------------------+  |       | +-----------------------------+ | â”‚
| |        â–²                           |       |       â–²                         | â”‚
| |        â”‚ Fast Access               â”‚       |       â”‚ Fast Access             | â”‚
| |  +-----â–¼------------------------+  |       | +-----â–¼-----------------------+ | â”‚
| |  | CPU Cores [0, 1, 2, ... 15] <-Interconnect-> CPU Cores [16..31]         | | â”‚
| |  +------------------------------+  |       | +-----------------------------+ | â”‚
| +------------------------------------+       +---------------------------------+ â”‚
+----------------------------------------------------------------------------------+

Example Task Binding:
  Task A --> Bound to NUMA Node 0 (Uses Cores 0-15, Prefers Memory Bank 0) via `numactl --cpunodebind=0 --membind=0 ...`
  Task B --> Bound to NUMA Node 1 (Uses Cores 16-31, Prefers Memory Bank 1) via `numactl --cpunodebind=1 --membind=1 ...`
```

*   **åµæ¸¬ï¼š** Runner ä½¿ç”¨ `numactl --hardware`ï¼ˆå¦‚æœå¯ç”¨ä¸”é€é `numactl_path` è¨­å®šï¼‰ä¾†åµæ¸¬å…¶ NUMA é…ç½®ï¼ˆç¯€é»ã€æ¯å€‹ç¯€é»çš„æ ¸å¿ƒã€æ¯å€‹ç¯€é»çš„è¨˜æ†¶é«”ï¼‰ã€‚
*   **å›å ±ï¼š** Runner åœ¨è¨»å†ŠæœŸé–“å°‡æ­¤æ‹“æ’²è³‡è¨Šç™¼é€çµ¦ Hostã€‚
*   **æŒ‡å®šï¼š** ä½¿ç”¨è€…å¯ä»¥é€é Client æˆ– Frontend æŒ‡å®šåƒ `my-compute-01:0` é€™æ¨£çš„ç›®æ¨™ï¼Œä»¥è«‹æ±‚ä»»å‹™ç‰¹åˆ¥åœ¨è©²ä¸»æ©Ÿçš„ NUMA ç¯€é» 0 ä¸Šé‹è¡Œã€‚
*   **åŸ·è¡Œï¼š** Runner åœ¨ `systemd-run` scope å…§ï¼Œå°‡ `numactl --cpunodebind=<id> --membind=<id>` å‘½ä»¤åŠ åœ¨ä½¿ç”¨è€…çš„ä»»å‹™å‘½ä»¤ä¹‹å‰ï¼Œå¼·åˆ¶åŸ·è¡Œç¶å®šã€‚

### å¤šç¯€é» / å¤š NUMA ä»»å‹™æäº¤

ä½¿ç”¨è€…ç¾åœ¨å¯ä»¥æäº¤å–®ä¸€è«‹æ±‚ï¼ŒHakuRiver æœƒå°‡å…¶è¤‡è£½åˆ°å¤šå€‹æŒ‡å®šçš„ç›®æ¨™ä¸Šã€‚

```ascii
+-----------------+       +----------------------------------------------------+
|  Client/        | ----> | Host Server                                        |
|  Frontend       |       | Receives:                                          |
|                 |       |  - Command: `my_script.sh --input {i}`             |
| Request:        |       |  - Cores: 2                                        |
|  Run my_script  |       |  - Targets: ["node1:0", "node1:1", "node2"]        |
|  on node1:0,    |       +----------------------------------------------------+
|  node1:1, node2 |        â”‚                        â”‚                        â”‚                       
+-----------------+        â”‚ Dispatch Task          â”‚ Dispatch Task          â”‚ Dispatch Task         
                           â”‚ (ID: 101, Target: 1:0) â”‚ (ID: 102, Target: 1:1) â”‚ (ID: 103, Target: 2)
                 +---------â–¼----------+   +---------â–¼----------+   +---------â–¼----------+
                 | Runner (Node 1)    |   | Runner (Node 1)    |   | Runner (Node 2)    |
                 | Executes Task 101  |   | Executes Task 102  |   | Executes Task 103  |
                 | (numactl bind 0)   |   | (numactl bind 1)   |   | (no numactl)       |
                 +--------------------+   +--------------------+   +--------------------+
```

*   **è«‹æ±‚ï¼š** Client/Frontend ç™¼é€ä¸€å€‹åŒ…å« `targets` åˆ—è¡¨ï¼ˆä¾‹å¦‚ `["node1:0", "node1:1", "node2"]`ï¼‰çš„ `/submit` è«‹æ±‚ã€‚
*   **Host è™•ç†ï¼š** Host è¿­ä»£è™•ç†ç›®æ¨™åˆ—è¡¨ã€‚å°æ–¼æ¯å€‹æœ‰æ•ˆä¸”å¯ç”¨çš„ç›®æ¨™ï¼Œå®ƒæœƒï¼š
    *   ç”¢ç”Ÿä¸€å€‹å”¯ä¸€çš„ä»»å‹™ IDï¼ˆä¾‹å¦‚ 101ã€102ã€103ï¼‰ã€‚
    *   ç‚ºè©²ä»»å‹™å¯¦ä¾‹å»ºç«‹ä¸€å€‹ç¨ç«‹çš„è³‡æ–™åº«è¨˜éŒ„ï¼Œå°‡å…¶é€£çµåˆ°ç›®æ¨™ç¯€é»/NUMA IDï¼Œä¸¦å¯èƒ½é€£çµåˆ°ä¸€å€‹å…±åŒçš„æ‰¹æ¬¡ IDã€‚
    *   å°‡ä»»å‹™å¯¦ä¾‹åˆ†æ´¾çµ¦é©ç•¶çš„ Runnerï¼Œå¦‚æœé©ç”¨ï¼Œå‰‡åŒ…å«ç‰¹å®šçš„ `target_numa_node_id`ã€‚
*   **å›æ‡‰ï¼š** Host å›æ‡‰ä¸€å€‹æˆåŠŸå»ºç«‹ä¸¦åˆ†æ´¾çš„ä»»å‹™ ID åˆ—è¡¨ã€‚

---

## ğŸ™ è‡´è¬

*   Gemini 2.5 proï¼šåŸºæœ¬å¯¦ä½œå’Œåˆå§‹ README ç”¢ç”Ÿã€‚
*   Claude 3.7 Sonnetï¼šå®Œå–„ logo SVG ç¨‹å¼ç¢¼ã€‚