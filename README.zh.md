# HakuRiver - è¿·ä½ è³‡æºå”èª¿å™¨

[![License](https://img.shields.io/badge/License-Apache_2.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

![HakuRiver logo svg](image/logo.svg)

***æ­¤å°ˆæ¡ˆç‚ºå¯¦é©—æ€§è³ªï¼Œä½¿ç”¨é¢¨éšªè‡ªè² ***

**HakuRiver** æ˜¯ä¸€å€‹è¼•é‡ç´šã€è‡ªè¨—ç®¡çš„å¢é›†ç®¡ç†å™¨ï¼Œå°ˆç‚ºåœ¨è¨ˆç®—ç¯€é»é–“åˆ†é…å‘½ä»¤åˆ—ä»»å‹™è€Œè¨­è¨ˆã€‚å®ƒå°ˆæ³¨æ–¼åˆ†é… CPU æ ¸å¿ƒï¼ˆé€é **systemd CPU é…é¡**ï¼‰å’Œè¨˜æ†¶é«”é™åˆ¶ã€ç®¡ç†ä»»å‹™ç”Ÿå‘½é€±æœŸï¼Œç¾åœ¨é‚„æä¾› **NUMA ç¯€é»å®šä½**å’Œ**å¤šç¯€é»ä»»å‹™æäº¤**ã€‚

HakuRiver éå¸¸é©åˆå°å‹ç ”ç©¶å¢é›†ã€é–‹ç™¼ç’°å¢ƒæˆ–å…§éƒ¨æ‰¹æ¬¡è™•ç†ç³»çµ±ï¼Œé€™äº›ç’°å¢ƒä¸­å®Œæ•´åŠŸèƒ½çš„ HPC æ’ç¨‹å™¨å¯èƒ½éæ–¼è¤‡é›œï¼Œä½†ä»éœ€è¦ä¸€å®šç¨‹åº¦çš„è³‡æºæ§åˆ¶å’Œåˆ†é…ã€‚

---

## ğŸ¤” HakuRiver çš„é©ç”¨å ´æ™¯ï¼ˆå’Œä¸é©ç”¨å ´æ™¯ï¼‰

| HakuRiver é©ç”¨æ–¼...                                                                                                  | HakuRiver ä¸é©ç”¨æ–¼...                                                                                                                 |
| :------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------- |
| âœ… åœ¨å°å‹å¢é›†ï¼ˆä¾‹å¦‚ < 10 å€‹ç¯€é»ï¼‰ä¸Šç®¡ç†å‘½ä»¤åˆ—ä»»å‹™/è…³æœ¬ã€‚                                                              | âŒ åœ¨å¤§å‹å¢é›†ä¸Šå–ä»£åŠŸèƒ½è±å¯Œçš„ HPC æ’ç¨‹å™¨ï¼ˆSlurmã€PBSã€LSFï¼‰ã€‚                                                                          |
| âœ… å°‡ä»»å‹™åˆ†é…åˆ°ç‰¹å®šçš„ **NUMA ç¯€é»**é€²è¡Œæ•ˆèƒ½èª¿æ•´ï¼ˆ`numactl`ï¼‰ã€‚                                                        | âŒ è¶…å‡º CPU é…é¡ã€è¨˜æ†¶é«”é™åˆ¶å’Œ NUMA ç¶å®šä¹‹å¤–çš„è¤‡é›œè³‡æºç®¡ç†ï¼ˆä¾‹å¦‚ GPU èª¿åº¦ã€ç¶²è·¯é »å¯¬ã€æˆæ¬Šï¼‰ã€‚                                      |
| âœ… æäº¤å–®ä¸€å‘½ä»¤ä»¥åŒæ™‚åœ¨**å¤šå€‹ç¯€é»æˆ– NUMA ç¯€é»**ä¸Šé‹è¡Œã€‚                                                               | âŒ è¤‡é›œçš„ä»»å‹™ä¾è³´ç®¡ç†æˆ–å·¥ä½œæµç¨‹å”èª¿ï¼ˆè«‹ä½¿ç”¨ Airflowã€Prefectã€Snakemakeã€Nextflowï¼‰ã€‚                                                   |
| âœ… é–‹ç™¼ã€æ¸¬è©¦æˆ–å°å‹ç ”ç©¶è¨­ç½®ï¼Œéœ€è¦æ¯”è¤‡é›œæ’ç¨‹å™¨æ›´ç°¡å–®çš„æ›¿ä»£æ–¹æ¡ˆã€‚                                                       | âŒ é€²éšæ’ç¨‹ç­–ç•¥ï¼ˆå…¬å¹³å…±äº«ã€æ¶å ã€å›å¡«ã€è¤‡é›œå„ªå…ˆç´šï¼‰ã€‚HakuRiver ä½¿ç”¨ç›´æ¥çš„ç”¨æˆ¶å®šä½ã€‚                                                   |
| âœ… åŸºæœ¬ä»»å‹™æäº¤ã€ç‹€æ…‹æª¢æŸ¥ã€æ—¥èªŒæª¢ç´¢å’Œçµ‚æ­¢åŠŸèƒ½è¶³å¤ çš„å…§éƒ¨å·¥å…·ã€‚                                                         | âŒ éœ€è¦è¶…å‡ºç¶²è·¯å¯è¨ªå•æ€§ä¹‹å¤–çš„å¼·å¤§å…§å»ºèº«ä»½é©—è­‰/æˆæ¬Šçš„é«˜å®‰å…¨æ€§ã€å¤šç§Ÿæˆ¶ç’°å¢ƒã€‚                                                           |
| âœ… ä¸»è¦é‹è¡Œ CPU/è¨˜æ†¶é«”å¯†é›†å‹æ‡‰ç”¨ç¨‹å¼ã€‚                                                                               | âŒ è‡ªå‹•å„ªåŒ– NUMA æ”¾ç½® â€“ ç”¨æˆ¶æŒ‡å®šç›®æ¨™ã€‚                                                                                                 |
| âœ… åœ¨å¢é›†æäº¤*ä¹‹å‰*ä½¿ç”¨åŒ…å«çš„ `hakurun` å·¥å…·é€²è¡Œæœ¬åœ°åƒæ•¸æƒæã€‚                                                        | âŒ ç”¨å¢é›†æäº¤æ›¿ä»£ `hakurun` æœ¬èº« â€“ å®ƒå€‘æœå‹™æ–¼ä¸åŒç›®çš„ï¼ˆæœ¬åœ°èˆ‡åˆ†æ•£å¼ï¼‰ã€‚                                                                |

---

## âœ¨ åŠŸèƒ½

* **é€šé systemd é€²è¡Œ CPU/RAM è³‡æºåˆ†é…ï¼š** ä»»å‹™è«‹æ±‚ CPU æ ¸å¿ƒï¼ˆä»¥ **CPU é…é¡ç™¾åˆ†æ¯”**åŸ·è¡Œï¼‰å’Œ**è¨˜æ†¶é«”é™åˆ¶**ï¼Œé€šé `systemd-run` æ‡‰ç”¨ã€‚
* **åŸºæ–¼ Systemd çš„ä»»å‹™åŸ·è¡Œï¼š** ä»»å‹™ä»¥è‡¨æ™‚ systemd ç¯„åœå–®å…ƒï¼ˆ`systemd-run --scope`ï¼‰é‹è¡Œï¼Œä»¥ç²å¾—æ›´å¥½çš„ç”Ÿå‘½é€±æœŸç®¡ç†å’Œè³‡æºè¨˜å¸³ã€‚
* **NUMA ç¯€é»å®šä½ï¼š** å¯é¸åœ°ä½¿ç”¨ `numactl` å°‡ä»»å‹™ç¶å®šåˆ°ç‰¹å®š NUMA ç¯€é»ï¼ˆéœ€è¦åœ¨é‹è¡Œå™¨ä¸Šå®‰è£ `numactl` ä¸¦é…ç½®è·¯å¾‘ï¼‰ã€‚
* **å¤šç¯€é»/NUMA ä»»å‹™æäº¤ï¼š** æäº¤å–®ä¸€è«‹æ±‚ä»¥åœ¨å¤šå€‹æŒ‡å®šç¯€é»æˆ–ç¯€é»å…§çš„ç‰¹å®š NUMA ç¯€é»ä¸Šé‹è¡Œç›¸åŒå‘½ä»¤ã€‚
* **æŒä¹…çš„ä»»å‹™å’Œç¯€é»è¨˜éŒ„ï¼š** ä¸»æ©Ÿç¶­è­· SQLite æ•¸æ“šåº«ï¼ŒåŒ…å«ç¯€é»ï¼ˆåŒ…æ‹¬æª¢æ¸¬åˆ°çš„ NUMA æ‹“æ’²ï¼‰å’Œä»»å‹™ï¼ˆç‹€æ…‹ã€ç›®æ¨™ã€è³‡æºè«‹æ±‚ã€æ—¥èªŒï¼‰ã€‚
* **ç¯€é»å¥åº·å’Œè³‡æºæ„ŸçŸ¥ï¼š** åŸºæœ¬å¿ƒè·³æª¢æ¸¬é›¢ç·šé‹è¡Œå™¨ã€‚é‹è¡Œå™¨å ±å‘Šæ•´é«” CPU/è¨˜æ†¶é«”ä½¿ç”¨æƒ…æ³å’Œ NUMA æ‹“æ’²ã€‚
* **ç¨ç«‹åƒæ•¸æ“´å±•ï¼ˆ`hakurun`ï¼‰ï¼š** ç”¨æ–¼åœ¨æäº¤åˆ°å¢é›†ä¹‹å‰é€²è¡Œæœ¬åœ°åƒæ•¸æƒæï¼ˆ`span:{..}`ã€`span:[]`ï¼‰çš„å·¥å…·ã€‚æ”¹å–„ä¸¦è¡Œ Python åŸ·è¡Œç©©å¥æ€§ã€‚
* **Web å„€è¡¨æ¿ï¼ˆå¯¦é©—æ€§ï¼‰ï¼š** Vue.js å‰ç«¯ï¼Œç”¨æ–¼è¦–è¦ºåŒ–ç›£æ§ã€ä»»å‹™æäº¤ï¼ˆåŒ…æ‹¬å¤šç›®æ¨™ï¼‰ã€ç‹€æ…‹æª¢æŸ¥å’Œçµ‚æ­¢ä»»å‹™ã€‚

## ğŸ—ï¸ æ¶æ§‹æ¦‚è¿°
![](image/README/HakuRiverArch.jpg)

* **ä¸»æ©Ÿï¼ˆ`hakuriver.host`ï¼‰ï¼š** ä¸­å¤®å”èª¿å™¨ã€‚ç®¡ç†ç¯€é»è¨»å†Šï¼ˆåŒ…æ‹¬ NUMA æ‹“æ’²ï¼‰ï¼Œè¿½è¹¤ç¯€é»ç‹€æ…‹/è³‡æºï¼Œåœ¨æ•¸æ“šåº«ä¸­å­˜å„²ä»»å‹™ä¿¡æ¯ï¼Œæ¥æ”¶ä»»å‹™æäº¤è«‹æ±‚ï¼ˆåŒ…æ‹¬å¤šç›®æ¨™ï¼‰ï¼Œé©—è­‰ç›®æ¨™ï¼Œç”Ÿæˆå”¯ä¸€ä»»å‹™ IDï¼Œä¸¦å°‡å–®å€‹ä»»å‹™å¯¦ä¾‹åˆ†æ´¾åˆ°é©ç•¶çš„é‹è¡Œå™¨ã€‚
* **é‹è¡Œå™¨ï¼ˆ`hakuriver.runner`ï¼‰ï¼š** æ¯å€‹è¨ˆç®—ç¯€é»ä¸Šçš„ä»£ç†ã€‚æª¢æ¸¬ NUMA æ‹“æ’²ï¼ˆé€šé `numactl`ï¼‰ï¼Œå‘ä¸»æ©Ÿè¨»å†Šï¼ˆå ±å‘Šæ ¸å¿ƒã€RAMã€NUMA ä¿¡æ¯ã€URLï¼‰ã€‚å®šæœŸç™¼é€å¿ƒè·³ï¼ˆåŒ…æ‹¬ CPU/è¨˜æ†¶é«”ä½¿ç”¨æƒ…æ³ï¼‰ã€‚ä½¿ç”¨ `sudo systemd-run` åŸ·è¡Œåˆ†é…çš„ä»»å‹™ï¼Œæ‡‰ç”¨ CPU é…é¡ã€è¨˜æ†¶é«”é™åˆ¶å’Œå¯é¸çš„ `numactl` ç¶å®šã€‚å°‡ä»»å‹™ç‹€æ…‹æ›´æ–°å ±å‘Šå›ä¸»æ©Ÿã€‚**éœ€è¦ `systemd-run` å’Œ `systemctl` çš„ç„¡å¯†ç¢¼ `sudo`ã€‚**
* **å®¢æˆ¶ç«¯ï¼ˆ`hakuriver.client`ï¼‰ï¼š** CLI å·¥å…·ã€‚èˆ‡ä¸»æ©Ÿé€šä¿¡ä»¥æäº¤ä»»å‹™ï¼ˆæŒ‡å®šå‘½ä»¤ã€åƒæ•¸ã€ç’°å¢ƒã€è³‡æºå’Œ**ä¸€å€‹æˆ–å¤šå€‹ç›®æ¨™**ï¼Œå¦‚ `host1` æˆ– `host1:0`ï¼‰ï¼ŒæŸ¥è©¢ä»»å‹™/ç¯€é»ç‹€æ…‹ï¼ˆåŒ…æ‹¬ NUMA ä¿¡æ¯ï¼‰ï¼Œä¸¦çµ‚æ­¢ä»»å‹™ã€‚
* **å‰ç«¯ï¼š** å¯é¸çš„ Web UIï¼Œæä¾›é¡ä¼¼æ–¼å®¢æˆ¶ç«¯çš„è¦–è¦ºåŒ–æ¦‚è¦½å’Œäº¤äº’åŠŸèƒ½ã€‚
* **æ•¸æ“šåº«ï¼š** ä¸»æ©Ÿé€šé Peewee ä½¿ç”¨ SQLite å­˜å„²ç¯€é»æ¸…å–®ï¼ˆåŒ…æ‹¬ä½œç‚º JSON çš„ NUMA æ‹“æ’²ï¼‰å’Œä»»å‹™è©³æƒ…ï¼ˆåŒ…æ‹¬ç›®æ¨™ NUMA IDã€æ‰¹æ¬¡ IDï¼‰ã€‚
* **å­˜å„²ï¼š**
  * **å…±äº«ï¼ˆ`shared_dir`ï¼‰ï¼š** åœ¨ä¸»æ©Ÿå’Œæ‰€æœ‰é‹è¡Œå™¨ä¸Šä»¥ç›¸åŒè·¯å¾‘æ›è¼‰ã€‚å°æ–¼ä»»å‹™è¼¸å‡ºæ—¥èªŒï¼ˆ`*.out`ã€`*.err`ï¼‰å’Œæ½›åœ¨çš„å…±äº«è…³æœ¬/æ•¸æ“šè‡³é—œé‡è¦ã€‚
  * **æœ¬åœ°è‡¨æ™‚ï¼ˆ`local_temp_dir`ï¼‰ï¼š** ç¯€é»ç‰¹å®šçš„å¿«é€Ÿå­˜å„²ï¼Œè·¯å¾‘ä½œç‚º `HAKURIVER_LOCAL_TEMP_DIR` ç’°å¢ƒè®Šé‡æ³¨å…¥ä»»å‹™ã€‚


HakuRiver çš„é€šä¿¡æµç¨‹åœ–ï¼š
![](image/README/HakuRiverFlow.jpg)

---

## ğŸš€ é–‹å§‹ä½¿ç”¨

### å®‰è£

1. è¤‡è£½å„²å­˜åº«ï¼š
   ```bash
   git clone https://github.com/KohakuBlueleaf/HakuRiver.git
   cd HakuRiver
   ```
2. å®‰è£åŒ…ï¼ˆæœ€å¥½åœ¨è™›æ“¬ç’°å¢ƒä¸­ï¼‰ï¼š
   ```bash
   # å®‰è£ hakuriver åŠå…¶ä¾è³´é …
   pip install .
   # æˆ–ç”¨æ–¼é–‹ç™¼ï¼š
   # pip install -e .
   ```

   é€™æ¨£å³å¯ä½¿ç”¨ `hakurun`ã€`hakuriver.host`ã€`hakuriver.runner` å’Œ `hakuriver.client`ã€‚
3. **ï¼ˆé‹è¡Œå™¨ç¯€é»ï¼‰** å¦‚æœæ‰“ç®—ä½¿ç”¨ NUMA å®šä½ï¼Œè«‹å®‰è£ `numactl`ï¼š
   ```bash
   # Debian/Ubuntu ç¤ºä¾‹
   sudo apt update && sudo apt install numactl
   # CentOS/RHEL ç¤ºä¾‹
   sudo yum install numactl
   ```

---

## `hakurun`ï¼šæœ¬åœ°åƒæ•¸æ“´å±•å·¥å…·

`hakurun` å¹«åŠ©*æœ¬åœ°*é‹è¡Œå¸¶æœ‰å¤šå€‹åƒæ•¸çµ„åˆçš„å‘½ä»¤æˆ– Python è…³æœ¬ï¼Œåœ¨æäº¤åˆ° HakuRiver å¢é›†ä¹‹å‰é€²è¡Œæ¸¬è©¦éå¸¸æœ‰ç”¨ã€‚

* **åƒæ•¸æ“´å±•ï¼š**
  * `span:{start..end}` -> æ•´æ•¸ï¼ˆä¾‹å¦‚ï¼Œ`span:{1..3}` -> `1`ã€`2`ã€`3`ï¼‰
  * `span:[a,b,c]` -> åˆ—è¡¨é …ç›®ï¼ˆä¾‹å¦‚ï¼Œ`span:[foo,bar]` -> `"foo"`ã€`"bar"`ï¼‰
* **åŸ·è¡Œï¼š** é‹è¡Œæ‰€æœ‰æ“´å±•åƒæ•¸çš„ç¬›å¡çˆ¾ç©ã€‚ä½¿ç”¨ `--parallel` é€šéå­é€²ç¨‹ä¸¦è¡Œé‹è¡Œçµ„åˆã€‚
* **ç›®æ¨™ï¼š** é‹è¡Œ Python æ¨¡å¡Šï¼ˆ`mymod`ï¼‰ã€å‡½æ•¸ï¼ˆ`mymod:myfunc`ï¼‰æˆ–å¯åŸ·è¡Œæ–‡ä»¶ï¼ˆ`python script.py`ã€`my_executable`ï¼‰ã€‚

**ç¤ºä¾‹ï¼ˆ`demo_hakurun.py`ï¼‰ï¼š**

```python
# demo_hakurun.py
import sys, time, random
time.sleep(random.random() * 0.1)
print(f"Args: {sys.argv[1:]}, PID: {os.getpid()}")
```

```bash
# æœ¬åœ°ä¸¦è¡Œé‹è¡Œ 2 * 1 * 2 = 4 å€‹ä»»å‹™
hakurun --parallel python ./demo_hakurun.py span:{1..2} fixed_arg span:[input_a,input_b]
```

**æ³¨æ„ï¼š** `hakurun` æ˜¯æœ¬åœ°è¼”åŠ©å·¥å…·ã€‚å®ƒ**ä¸**èˆ‡ HakuRiver å¢é›†äº¤äº’ã€‚ä½¿ç”¨å®ƒç”Ÿæˆä»¥å¾Œå¯èƒ½å–®ç¨æˆ–ä½œç‚ºæ‰¹æ¬¡ä½¿ç”¨ `hakuriver.client` æäº¤çš„å‘½ä»¤ã€‚

---

## ğŸ”§ é…ç½® - HakuRiver

* æ‚¨å¯ä»¥ä½¿ç”¨ `hakuriver.init` å‰µå»ºå…¨å±€é»˜èªé…ç½®ï¼Œæ­¤å‘½ä»¤å°‡åœ¨ `~/.hakuriver/config.toml` ä¸­å‰µå»ºé»˜èªé…ç½®æ–‡ä»¶ï¼Œæ‰€æœ‰å‘½ä»¤é»˜èªå°‡ä½¿ç”¨æ­¤é…ç½®ã€‚
* é»˜èªé…ç½®å…§å®¹ï¼š`src/hakuriver/utils/default_config.toml`ã€‚
* å°ä»»ä½• `hakuriver.*` å‘½ä»¤ä½¿ç”¨ `--config /path/to/custom.toml` é€²è¡Œè¦†è“‹ã€‚
* **éœ€è¦å¯©æŸ¥/ç·¨è¼¯çš„é—œéµè¨­ç½®ï¼š**
  * `[network] host_reachable_address`ï¼š**å¿…é ˆ**æ˜¯é‹è¡Œå™¨å’Œå®¢æˆ¶ç«¯å¯è¨ªå•çš„ä¸»æ©Ÿ IP/ä¸»æ©Ÿåã€‚
  * `[network] runner_address`ï¼š**å¿…é ˆ**æ˜¯ä¸»æ©Ÿå¯è¨ªå•çš„é‹è¡Œå™¨ IP/ä¸»æ©Ÿåã€‚
  * `[paths] shared_dir`ï¼šå…±äº«å­˜å„²çš„çµ•å°è·¯å¾‘ï¼ˆå¿…é ˆåœ¨é‹è¡Œå™¨ç¯€é»ä¸Šå­˜åœ¨ä¸”å¯å¯«ï¼Œåœ¨ä¸»æ©Ÿç¯€é»ä¸Šå¯è®€ï¼‰ã€‚
  * `[paths] local_temp_dir`ï¼šæœ¬åœ°è‡¨æ™‚å­˜å„²çš„çµ•å°è·¯å¾‘ï¼ˆå¿…é ˆåœ¨é‹è¡Œå™¨ç¯€é»ä¸Šå­˜åœ¨ä¸”å¯å¯«ï¼‰ã€‚
  * `[paths] numactl_path`ï¼šé‹è¡Œå™¨ç¯€é»ä¸Š `numactl` å¯åŸ·è¡Œæ–‡ä»¶çš„çµ•å°è·¯å¾‘ï¼ˆä¾‹å¦‚ï¼Œ`/usr/bin/numactl`ï¼‰ã€‚å¦‚æœç‚ºç©ºï¼Œé‹è¡Œå™¨å°‡å˜—è©¦ç›´æ¥ä½¿ç”¨ `numactl`ã€‚
  * `[database] db_file`ï¼šä¸»æ©Ÿ SQLite æ•¸æ“šåº«çš„è·¯å¾‘ã€‚ç¢ºä¿ç›®éŒ„å­˜åœ¨ã€‚

---

## ğŸ’» ä½¿ç”¨ - HakuRiver å¢é›†

**1. åˆå§‹åŒ–é…ç½®ï¼š**
åœ¨æ¯å€‹ç¯€é»ï¼ˆä¸»æ©Ÿå’Œé‹è¡Œå™¨ï¼‰ä¸Šä½¿ç”¨ `hakuriver.init` å‘½ä»¤åœ¨ ~/.hakuriver/config.toml å‰µå»ºé…ç½®æ–‡ä»¶ã€‚
ç„¶å¾Œæ‚¨å¯ä»¥æ ¹æ“šæ‚¨çš„è¨­ç½®ä¿®æ”¹é…ç½®ã€‚
```bash
hakuriver.init
vim ~/.hakuriver/config.toml
```

**2. å•Ÿå‹•ä¸»æ©Ÿæœå‹™å™¨ï¼ˆåœ¨ç®¡ç†ç¯€é»ä¸Šï¼‰ï¼š**

```bash
   hakuriver.host
   # ä½¿ç”¨è‡ªå®šç¾©é…ç½®ï¼š
   # hakuriver.host --config /path/to/host_config.toml
```

æˆ–è€…æ‚¨å¯ä»¥åœ¨ç³»çµ±ä¸­å‰µå»ºæœå‹™ï¼š
```bash
   hakuriver.init service --host
   # ä½¿ç”¨è‡ªå®šç¾©é…ç½®ï¼š
   # hakuriver.init service --host --config /path/to/host_config.toml
   systemctl restart hakuriver-host
   systemctl enable hakuriver-host
   # æª¢æŸ¥é‹è¡Œç‹€æ…‹
   # systemctl status hakuriver-host
```

**3. å•Ÿå‹•é‹è¡Œå™¨ä»£ç†ï¼ˆåœ¨æ¯å€‹è¨ˆç®—ç¯€é»ä¸Šï¼‰ï¼š**

```bash
   # é‡è¦ï¼šä»¥å…·æœ‰ä»¥ä¸‹å‘½ä»¤ NOPASSWD sudo è¨ªå•æ¬Šé™çš„ç”¨æˆ¶èº«ä»½é‹è¡Œï¼š
   # /usr/bin/systemd-run, /usr/bin/systemctl
   # ï¼ˆéœ€è¦ç”¨æ–¼ä»»å‹™å•Ÿå‹•ã€è³‡æºé™åˆ¶ã€çµ‚æ­¢ä»»å‹™ï¼Œå¦‚æœé€šé sudo é‹è¡Œå¯èƒ½é‚„éœ€è¦ numactlï¼‰
   # sudoers æ¢ç›®ç¤ºä¾‹ï¼š
   # your_user ALL=(ALL) NOPASSWD: /usr/bin/systemd-run, /usr/bin/systemctl

   hakuriver.runner
   # ä½¿ç”¨è‡ªå®šç¾©é…ç½®ï¼š
   # hakuriver.runner --config /path/to/runner_config.toml
```

æˆ–è€…æ‚¨å¯ä»¥åœ¨ç³»çµ±ä¸­å‰µå»ºæœå‹™ï¼š
```bash
   hakuriver.init service --runner
   # ä½¿ç”¨è‡ªå®šç¾©é…ç½®ï¼š
   # hakuriver.init service --runner --config /path/to/runner_config.toml
   systemctl restart hakuriver-runner
   systemctl enable hakuriver-runner
   # æª¢æŸ¥é‹è¡Œç‹€æ…‹
   # systemctl status hakuriver-runner
```

**4. Systemd åŸ·è¡Œèªªæ˜ï¼š**
* `systemd-run` å’Œ `systemctl` ç”¨æ–¼ä»»å‹™åŸ·è¡Œå’Œç®¡ç†ã€‚é€™äº›å‘½ä»¤é€šé `sudo` é‹è¡Œä»¥ç¢ºä¿é©ç•¶çš„æ¬Šé™ã€‚æ‚¨æ‡‰è©²æ“æœ‰é€™äº›å‘½ä»¤çš„ç„¡å¯†ç¢¼ sudo è¨ªå•æ¬Šé™ã€‚
* é€šé `systemd-run` é‹è¡Œçš„ä»»å‹™å°‡ç¹¼æ‰¿é‹è¡Œå™¨çš„å·¥ä½œç›®éŒ„ï¼ˆé€šå¸¸åœ¨ç”¨æˆ¶çš„ä¸»ç›®éŒ„æˆ– `/` ä¸­å•Ÿå‹•ï¼‰ã€‚ä½¿ç”¨çµ•å°è·¯å¾‘æˆ–ç’°å¢ƒè®Šé‡ï¼ˆ`HAKURIVER_SHARED_DIR`ã€`HAKURIVER_LOCAL_TEMP_DIR`ï¼‰ã€‚
* ä»»å‹™ç’°å¢ƒåŒ…æ‹¬é€šé `--env` è¨­ç½®çš„è®Šé‡ã€`HAKURIVER_*` è®Šé‡ï¼Œä»¥åŠå¯èƒ½ç”± `systemd --user` å¯¦ä¾‹æˆ–ç³»çµ±å¯¦ä¾‹ç¹¼æ‰¿çš„è®Šé‡ï¼Œå–æ±ºæ–¼ `systemd-run` å¦‚ä½•è¢« sudo èª¿ç”¨ã€‚

**5. ä½¿ç”¨å®¢æˆ¶ç«¯ï¼ˆ`hakuriver.client`ï¼‰ï¼š**

| æ“ä½œ                         | å‘½ä»¤ç¤ºä¾‹                                                                                                                                            | å‚™è¨»                                                                         |
| :--------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------- |
| **åˆ—å‡ºç¯€é»**                 | `hakuriver.client --list-nodes`                                                                                                                     | é¡¯ç¤ºç‹€æ…‹ã€æ ¸å¿ƒã€NUMA æ‘˜è¦ã€‚                                                   |
| **ç¯€é»å¥åº·ç‹€æ³**             | `hakuriver.client --health` <br> `hakuriver.client --health <node-hostname>`                                                                        | é¡¯ç¤ºè©³ç´°çµ±è¨ˆä¿¡æ¯ï¼ŒåŒ…æ‹¬å®Œæ•´ NUMA æ‹“æ’²ï¼ˆå¦‚æœå¯ç”¨ï¼‰ã€‚                            |
| **æäº¤å–®ä¸€ä»»å‹™**             | `hakuriver.client --target <host1> --cores 1 -- echo "Basic Task"`                                                                                  | åœ¨ `<host1>` çš„ä»»ä½•å¯ç”¨æ ¸å¿ƒä¸Šé‹è¡Œã€‚                                         |
| **æäº¤ï¼ˆNUMAï¼‰**             | `hakuriver.client --target <host1>:0 --cores 2 --memory 1G -- ./my_numa_script.sh`                                                                  | ç¶å®šåœ¨ `<host1>` çš„ NUMA ç¯€é» 0 ä¸Šé‹è¡Œã€‚éœ€è¦é‹è¡Œå™¨ä¸Šæœ‰ `numactl`ã€‚         |
| **æäº¤ï¼ˆå¤š NUMAï¼‰**          | `hakuriver.client --target <host1>:0 --target <host1>:1 --cores 1 -- ./process_shard.sh`                                                            | åœ¨ `<host1>` ä¸Šé‹è¡Œå…©å€‹ä»»å‹™å¯¦ä¾‹ï¼Œä¸€å€‹åœ¨ NUMA 0ï¼Œä¸€å€‹åœ¨ NUMA 1ã€‚           |
| **æäº¤ï¼ˆå¤šç¯€é»ï¼‰**           | `hakuriver.client --target <host1>:0 --target <host2> --cores 4 --env P=1 -- ./parallel_job.sh`                                                     | åœ¨ `<host1>` çš„ NUMA 0 å’Œ `<host2>` çš„ä»»ä½•æ ¸å¿ƒä¸Šé‹è¡Œã€‚                     |
| **æª¢æŸ¥ç‹€æ…‹**                 | `hakuriver.client --status <task_id>`                                                                                                               | é¡¯ç¤ºè©³ç´°ç‹€æ…‹ï¼ŒåŒ…æ‹¬ç›®æ¨™ NUMAã€æ‰¹æ¬¡ IDã€‚                                        |
| **çµ‚æ­¢ä»»å‹™**                 | `hakuriver.client --kill <task_id>`                                                                                                                 | è«‹æ±‚çµ‚æ­¢ç‰¹å®šä»»å‹™å¯¦ä¾‹ã€‚                                                       |
| **æäº¤ + ç­‰å¾…**              | `hakuriver.client --target <host1>:0 --wait -- sleep 30`                                                                                            | ç­‰å¾…æŒ‡å®šä»»å‹™å®Œæˆã€‚èˆ‡å¤šç›®æ¨™ä¸€èµ·ä½¿ç”¨æ™‚è¦è¬¹æ…ã€‚                                  |
| **ä½¿ç”¨è‡ªå®šç¾©é…ç½®**           | `hakuriver.client --config client.toml --list-nodes`                                                                                                | åŠ è¼‰å®¢æˆ¶ç«¯é…ç½®è¦†è“‹ã€‚                                                         |
| **èˆ‡ hakurun çµåˆ**          | `hakurun hakuriver.client --target <host1>:0 --cores 1 -- python script.py span:{1..10}` <br>ï¼ˆæäº¤ 10 å€‹ç¨ç«‹çš„ HakuRiver ä»»å‹™ï¼‰                   | é©ç”¨æ–¼æäº¤å¤šå€‹é¡ä¼¼*ç¨ç«‹*å¢é›†ä»»å‹™ã€‚                                          |
| **èˆ‡ hakurun çµåˆ**          | `hakuriver.client --target <host1>:0 --cores 4 -- hakurun --parallel python process.py span:{A..Z}` <br>ï¼ˆæäº¤ 1 å€‹é‹è¡Œ hakurun çš„ HakuRiver ä»»å‹™ï¼‰ | é©ç”¨æ–¼å°‡å¤šå€‹å°å‹ã€ç›¸é—œæ­¥é©Ÿåˆ†çµ„ç‚º*ä¸€å€‹*å¢é›†ä»»å‹™ã€‚                            |

   **`--target` èªæ³•ï¼š**

| æ ¼å¼                | æè¿°                                      |
| :------------------ | :---------------------------------------- |
| `my-node`         | ç›®æ¨™ç‰©ç†ç¯€é» `my-node`ã€‚                |
| `my-node:0`       | ç›®æ¨™ `my-node` ä¸Šçš„ NUMA ç¯€é» 0ã€‚       |
| `another-node:1`  | ç›®æ¨™ `another-node` ä¸Šçš„ NUMA ç¯€é» 1ã€‚   |

---

## ğŸŒ ä½¿ç”¨ - å‰ç«¯ Web UIï¼ˆå¯¦é©—æ€§ï¼‰

| æ¦‚è¿°                                               | ç¯€é»åˆ—è¡¨å’Œä»»å‹™åˆ—è¡¨                                                                                  | å¾ç®¡ç†å™¨ UI æäº¤ä»»å‹™                             |
| -------------------------------------------------- | --------------------------------------------------------------------------------------------------- | ------------------------------------------------ |
| ![1744643963836](image/README/1744643963836.png) | ![1744643981874](image/README/1744643981874.png) ![1744643997740](image/README/1744643997740.png) | ![1744644009190](image/README/1744644009190.png) |

HakuRiver åŒ…å«ä¸€å€‹å¯é¸çš„ Vue.js å„€è¡¨æ¿ï¼Œç”¨æ–¼è¦–è¦ºåŒ–ç›£æ§å’Œç®¡ç†ã€‚

**å…ˆæ±ºæ¢ä»¶ï¼š**

* Node.js å’Œ npm/yarn/pnpmã€‚
* å¾æ‚¨é‹è¡Œå‰ç«¯é–‹ç™¼æœå‹™å™¨çš„ä½ç½®å¯è¨ªå•çš„é‹è¡Œä¸­ HakuRiver ä¸»æ©Ÿã€‚

**è¨­ç½®ï¼š**

```bash
cd frontend
npm install
```

**é‹è¡Œï¼ˆé–‹ç™¼ï¼‰ï¼š**

1. ç¢ºä¿ä¸»æ©Ÿæ­£åœ¨é‹è¡Œï¼ˆä¾‹å¦‚ï¼Œ`http://127.0.0.1:8000`ï¼‰ã€‚
2. å•Ÿå‹• Vite é–‹ç™¼æœå‹™å™¨ï¼š
   ```bash
   npm run dev
   ```
3. æ‰“é–‹æä¾›çš„ URLï¼ˆä¾‹å¦‚ï¼Œ`http://localhost:5173`ï¼‰ã€‚
4. é–‹ç™¼æœå‹™å™¨å°‡ `/api` è«‹æ±‚ä»£ç†åˆ°ä¸»æ©Ÿï¼ˆè¦‹ `vite.config.js`ï¼‰ã€‚
5. **åŠŸèƒ½ï¼š**
   * æŸ¥çœ‹ç¯€é»åˆ—è¡¨ã€ç‹€æ…‹ã€è³‡æºå’Œ **NUMA æ‹“æ’²**ã€‚
   * æŸ¥çœ‹ä»»å‹™åˆ—è¡¨ã€è©³æƒ…ï¼ˆåŒ…æ‹¬æ‰¹æ¬¡ IDã€ç›®æ¨™ NUMAï¼‰ã€æ—¥èªŒã€‚
   * ä½¿ç”¨è¡¨å–®æäº¤æ–°ä»»å‹™ï¼Œè©²è¡¨å–®åŒ…æ‹¬**å¤šç›®æ¨™é¸æ“‡å™¨**ï¼Œå…è¨±é¸æ“‡æ•´å€‹ç¯€é»æˆ–ç‰¹å®š NUMA ç¯€é»ã€‚
   * çµ‚æ­¢æ­£åœ¨é‹è¡Œçš„ä»»å‹™ã€‚

**æ§‹å»ºï¼ˆç”Ÿç”¢ï¼‰ï¼š**

1. æ§‹å»ºéœæ…‹æ–‡ä»¶ï¼š
   ```bash
   npm run build
   ```
2. ä½¿ç”¨ä»»ä½•éœæ…‹ Web æœå‹™å™¨ï¼ˆNginxã€Apache ç­‰ï¼‰æä¾› `frontend/dist` çš„å…§å®¹ã€‚
3. **é‡è¦ï¼š** é…ç½®æ‚¨çš„ç”Ÿç”¢ Web æœå‹™å™¨ä»¥ä»£ç† API è«‹æ±‚ï¼ˆä¾‹å¦‚ï¼Œå° `/api/*` çš„è«‹æ±‚ï¼‰åˆ°å¯¦éš›é‹è¡Œçš„ HakuRiver ä¸»æ©Ÿåœ°å€å’Œç«¯å£ï¼Œé¡ä¼¼æ–¼ Vite é–‹ç™¼æœå‹™å™¨ä»£ç†ï¼Œæˆ–è€…åœ¨æ§‹å»ºå‰ä¿®æ”¹ `src/services/api.js` ä»¥ä½¿ç”¨ä¸»æ©Ÿçš„çµ•å° URLã€‚


## ğŸ™ è‡´è¬

* Gemini 2.5 proï¼šåŸºæœ¬å¯¦ç¾å’Œåˆå§‹ README ç”Ÿæˆã€‚
* Claude 3.7 Sonnetï¼šå®Œå–„ logo SVG ä»£ç¢¼ã€‚