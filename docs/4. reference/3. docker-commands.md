# Docker Management Command Reference

HakuRiver provides tools to manage the Docker environments used for tasks. These commands interact with the Host server's Docker management API.

## `hakuriver.docker`

This command manages persistent containers on the Host and the distributable tarballs stored in shared storage.

**Usage:**

```bash
hakuriver.docker [OPTIONS] COMMAND [ARGS...]
```

### Options

*   `--config PATH`
    *   Specify the path to a custom TOML configuration file.

### Commands

*   `list-containers`
    *   Lists persistent Docker containers managed by HakuRiver on the **Host** machine. Shows name, image, status, etc.
    *   **Usage:** `hakuriver.docker list-containers`
    *   **Example Output (JSON):**
        ```json
        [
          {
            "id": "a1b2c3d4e5f6",
            "name": "my-python-env",
            "image": "python:3.11-slim",
            "status": "Up 5 hours"
          },
          {
            "id": "f6e5d4c3b2a1",
            "name": "old-env",
            "image": "ubuntu:20.04",
            "status": "Exited (0) 2 days ago"
          }
        ]
        ```

*   `create-container <image_name> <container_name>`
    *   Creates a new, persistent, long-running (via `sleep infinity`) container on the **Host** from a specified public Docker image. This container can then be customized using `hakuriver.docker-shell`.
    *   **Arguments:**
        *   `image_name`: The public Docker image (e.g., `ubuntu:22.04`, `python:3.11-slim`).
        *   `container_name`: The name you want to assign to this HakuRiver environment (e.g., `my-ubuntu-env`).
    *   **Usage:** `hakuriver.docker create-container python:3.11-slim my-py311-env`

*   `delete-container <container_name>`
    *   Stops (if running) and removes a persistent container from the **Host** machine. This does *not* delete associated tarballs from shared storage.
    *   **Arguments:**
        *   `container_name`: The name of the container to delete.
    *   **Usage:** `hakuriver.docker delete-container old-env`

*   `stop-container <container_name>`
    *   Stops a running persistent container on the **Host**.
    *   **Arguments:**
        *   `container_name`: The name of the container to stop.
    *   **Usage:** `hakuriver.docker stop-container my-py311-env`

*   `start-container <container_name>`
    *   Starts a stopped persistent container on the **Host**.
    *   **Arguments:**
        *   `container_name`: The name of the container to start.
    *   **Usage:** `hakuriver.docker start-container my-py311-env`

*   `list-tars`
    *   Lists the available HakuRiver environment tarballs found in the configured shared storage directory (`<shared_dir>/<container_dir>`). Groups versions by container name and shows the latest.
    *   **Usage:** `hakuriver.docker list-tars`
    *   **Example Output (JSON):**
        ```json
        {
          "my-py311-env": {
            "latest_timestamp": 1678886400,
            "latest_tarball": "my-py311-env-1678886400.tar",
            "all_versions": [
              {
                "timestamp": 1678886400,
                "tarball": "my-py311-env-1678886400.tar"
              },
              {
                "timestamp": 1678880000,
                "tarball": "my-py311-env-1678880000.tar"
              }
            ]
          },
          "my-ubuntu-env": {
             // ...
          }
        }
        ```

*   `create-tar <container_name>`
    *   Creates a distributable `.tar` file from the current state of a persistent container on the **Host**.
    *   It stops the container, commits it to a temporary image (`hakuriver/<container_name>:base`), saves that image to a timestamped tarball in shared storage, cleans up older tarballs for the same environment, and removes the temporary image.
    *   **Arguments:**
        *   `container_name`: The name of the persistent Host container to package.
    *   **Usage:** `hakuriver.docker create-tar my-py311-env`

## `hakuriver.docker-shell`

This command provides an interactive terminal session inside a running persistent container on the **Host** machine, allowing you to install software or configure the environment before creating a tarball.

**Usage:**

```bash
hakuriver.docker-shell [OPTIONS] <container_name>
```

### Options

*   `--config PATH`
    *   Specify the path to a custom TOML configuration file.

### Arguments

*   `<container_name>` (**Required**)
    *   The name of the running persistent container on the Host to connect to.

### How it Works

1.  The client establishes a WebSocket connection to the Host server's terminal endpoint (`/docker/host/containers/{container_name}/terminal`).
2.  The Host server uses the Docker API to execute an interactive shell (`/bin/bash` or `/bin/sh`) inside the specified container.
3.  Input/output is relayed between your local terminal and the container shell via the WebSocket.
4.  Type `exit` or press `Ctrl+D` in the shell to terminate the session.

**Example:**

```bash
# Start the container if it's stopped
hakuriver.docker start-container my-py311-env

# Get an interactive shell
hakuriver.docker-shell my-py311-env

# --- Inside the container shell ---
# root@hostname:/# apt update && apt install -y vim curl git
# root@hostname:/# pip install numpy pandas
# root@hostname:/# exit
# --- Back in local terminal ---

# Now create the tarball with the installed packages
hakuriver.docker create-tar my-py311-env
```