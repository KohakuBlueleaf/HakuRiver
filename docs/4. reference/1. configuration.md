# Configuration Reference

KohakuRiver uses Python-based configuration files via [KohakuEngine](https://github.com/KohakuBlueleaf/KohakuEngine). Configuration is defined as module-level variables with a `config_gen()` function.

## Default Configuration Paths

| Component | Default Path |
|-----------|--------------|
| Host | `~/.kohakuriver/host_config.py` |
| Runner | `~/.kohakuriver/runner_config.py` |
| CLI | Environment variables or command-line options |

## Generating Configuration Files

```bash
# Generate both configs
kohakuriver init config --generate

# Generate specific config
kohakuriver init config --host
kohakuriver init config --runner

# Custom output directory
kohakuriver init config -g -o /etc/kohakuriver/
```

## Configuration Loading

### Automatic Loading

When no `--config` flag is specified:
- `kohakuriver.host` loads `~/.kohakuriver/host_config.py` if it exists
- `kohakuriver.runner` loads `~/.kohakuriver/runner_config.py` if it exists
- Falls back to built-in defaults if no config file found

### Manual Loading

```bash
kohakuriver.host --config /path/to/host_config.py
kohakuriver.runner --config /path/to/runner_config.py
```

---

## Host Configuration Options

File: `~/.kohakuriver/host_config.py`

### Network Settings

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `HOST_BIND_IP` | str | `"0.0.0.0"` | IP address the Host server binds to |
| `HOST_PORT` | int | `8000` | API server port |
| `HOST_SSH_PROXY_PORT` | int | `8002` | SSH proxy port for VPS access |
| `HOST_REACHABLE_ADDRESS` | str | `"127.0.0.1"` | **CRITICAL**: IP/hostname runners use to reach Host |

### Path Settings

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `SHARED_DIR` | str | `"/mnt/cluster-share"` | Shared storage path (must match on all nodes) |
| `DB_FILE` | str | `"/var/lib/kohakuriver/kohakuriver.db"` | SQLite database path |
| `CONTAINER_DIR` | str | `""` | Container tarball directory (default: `SHARED_DIR/kohakuriver-containers`) |
| `HOST_LOG_FILE` | str | `""` | Log file path (empty = console only) |

### Timing Settings

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `HEARTBEAT_INTERVAL_SECONDS` | int | `5` | Expected heartbeat interval from runners |
| `HEARTBEAT_TIMEOUT_FACTOR` | int | `6` | Runner offline after `interval * factor` seconds |
| `CLEANUP_CHECK_INTERVAL_SECONDS` | int | `10` | Interval to check for offline runners |

### Docker Settings

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `DEFAULT_CONTAINER_NAME` | str | `"kohakuriver-base"` | Default environment for tasks |
| `INITIAL_BASE_IMAGE` | str | `"python:3.12-alpine"` | Base image if default tarball doesn't exist |
| `TASKS_PRIVILEGED` | bool | `False` | Default --privileged flag for tasks |
| `ADDITIONAL_MOUNTS` | list[str] | `[]` | Default mounts for all tasks |
| `DEFAULT_WORKING_DIR` | str | `"/shared"` | Default working directory in containers |

### Logging Settings

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `LOG_LEVEL` | LogLevel | `LogLevel.INFO` | Logging verbosity: `FULL`, `DEBUG`, `INFO`, `WARNING` |

### Example Host Configuration

```python
"""
KohakuRiver Host Configuration
"""
from kohakuengine import Config
from kohakuriver.models.enums import LogLevel

# Network
HOST_BIND_IP: str = "0.0.0.0"
HOST_PORT: int = 8000
HOST_SSH_PROXY_PORT: int = 8002
HOST_REACHABLE_ADDRESS: str = "192.168.1.100"  # CHANGE THIS!

# Paths
SHARED_DIR: str = "/mnt/cluster-share"
DB_FILE: str = "/var/lib/kohakuriver/kohakuriver.db"
CONTAINER_DIR: str = ""
HOST_LOG_FILE: str = ""

# Timing
HEARTBEAT_INTERVAL_SECONDS: int = 5
HEARTBEAT_TIMEOUT_FACTOR: int = 6
CLEANUP_CHECK_INTERVAL_SECONDS: int = 10

# Docker
DEFAULT_CONTAINER_NAME: str = "kohakuriver-base"
INITIAL_BASE_IMAGE: str = "python:3.12-alpine"
TASKS_PRIVILEGED: bool = False
ADDITIONAL_MOUNTS: list[str] = []
DEFAULT_WORKING_DIR: str = "/shared"

# Logging
LOG_LEVEL: LogLevel = LogLevel.INFO

def config_gen():
    return Config.from_globals()
```

---

## Runner Configuration Options

File: `~/.kohakuriver/runner_config.py`

### Network Settings

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `RUNNER_BIND_IP` | str | `"0.0.0.0"` | IP address the Runner binds to |
| `RUNNER_PORT` | int | `8001` | Runner API port |
| `HOST_ADDRESS` | str | `"127.0.0.1"` | **CRITICAL**: Host server address |
| `HOST_PORT` | int | `8000` | Host server port |

### Path Settings

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `SHARED_DIR` | str | `"/mnt/cluster-share"` | Shared storage path (must match Host) |
| `LOCAL_TEMP_DIR` | str | `"/tmp/kohakuriver"` | Local temporary storage |
| `CONTAINER_TAR_DIR` | str | `""` | Tarball directory (default: `SHARED_DIR/kohakuriver-containers`) |
| `NUMACTL_PATH` | str | `""` | Path to numactl binary |
| `RUNNER_LOG_FILE` | str | `""` | Log file path (empty = console only) |

### Timing Settings

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `HEARTBEAT_INTERVAL_SECONDS` | int | `5` | Heartbeat interval to Host |
| `RESOURCE_CHECK_INTERVAL_SECONDS` | int | `1` | Resource monitoring interval |

### Execution Settings

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `RUNNER_USER` | str | `""` | User to run tasks as (empty = current user) |
| `DEFAULT_WORKING_DIR` | str | `"/shared"` | Default working directory in containers |

### Docker Settings

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `TASKS_PRIVILEGED` | bool | `False` | Default --privileged flag |
| `ADDITIONAL_MOUNTS` | list[str] | `[]` | Default additional mounts |
| `DOCKER_IMAGE_SYNC_TIMEOUT` | int | `600` | Tarball sync timeout (seconds) |

### Logging Settings

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `LOG_LEVEL` | LogLevel | `LogLevel.INFO` | Logging verbosity |

### Example Runner Configuration

```python
"""
KohakuRiver Runner Configuration
"""
from kohakuengine import Config
from kohakuriver.models.enums import LogLevel

# Network
RUNNER_BIND_IP: str = "0.0.0.0"
RUNNER_PORT: int = 8001
HOST_ADDRESS: str = "192.168.1.100"  # CHANGE THIS!
HOST_PORT: int = 8000

# Paths
SHARED_DIR: str = "/mnt/cluster-share"
LOCAL_TEMP_DIR: str = "/tmp/kohakuriver"
CONTAINER_TAR_DIR: str = ""
NUMACTL_PATH: str = ""
RUNNER_LOG_FILE: str = ""

# Timing
HEARTBEAT_INTERVAL_SECONDS: int = 5
RESOURCE_CHECK_INTERVAL_SECONDS: int = 1

# Execution
RUNNER_USER: str = ""
DEFAULT_WORKING_DIR: str = "/shared"

# Docker
TASKS_PRIVILEGED: bool = False
ADDITIONAL_MOUNTS: list[str] = []
DOCKER_IMAGE_SYNC_TIMEOUT: int = 600

# Logging
LOG_LEVEL: LogLevel = LogLevel.INFO

def config_gen():
    return Config.from_globals()
```

---

## CLI Configuration

The CLI uses environment variables for connection settings:

| Variable | Description | Default |
|----------|-------------|---------|
| `KOHAKURIVER_HOST` | Host server address | `localhost` |
| `KOHAKURIVER_PORT` | Host server port | `8000` |
| `KOHAKURIVER_SSH_PROXY_PORT` | SSH proxy port | `8002` |
| `KOHAKURIVER_SHARED_DIR` | Shared storage path | `/mnt/cluster-share` |

Or use command-line options:

```bash
kohakuriver --host 192.168.1.100 --port 8000 task list
```

---

## Directory Layout

### Shared Storage

```
/mnt/cluster-share/              # SHARED_DIR
├── kohakuriver-containers/      # Container tarballs
│   ├── myenv-1705312800.tar
│   └── cuda-env-1705398000.tar
├── shared_data/                 # Mounted as /shared in containers
│   ├── scripts/
│   ├── data/
│   └── results/
└── logs/                        # Task stdout/stderr (optional)
```

### Local Paths

```
~/.kohakuriver/                  # User config directory
├── host_config.py              # Host configuration
└── runner_config.py            # Runner configuration

/var/lib/kohakuriver/           # System data (Host)
└── kohakuriver.db              # SQLite database

/tmp/kohakuriver/               # LOCAL_TEMP_DIR (Runner)
├── .kohakuriver/               # Hidden runner state directory
│   └── runner-state.db         # Runner state (KohakuVault)
└── task-*/                     # Task temporary files
```

---

## Critical Configuration Notes

### HOST_REACHABLE_ADDRESS

This must be set to an IP/hostname that:
- Runners can reach to register and send heartbeats
- Clients can reach to submit tasks and access the SSH proxy

For LAN clusters, use the host's LAN IP (e.g., `192.168.1.100`).

### SHARED_DIR

Must be:
- The **same physical filesystem** accessible from Host and all Runners
- The **same logical path** on all nodes (e.g., `/mnt/cluster-share`)
- Readable and writable by the KohakuRiver user

### Docker Permissions

The user running KohakuRiver needs Docker access:

```bash
# Add user to docker group
sudo usermod -aG docker $USER

# Log out and back in for group change to take effect
```

### Database Directory

Ensure the database directory exists and is writable:

```bash
sudo mkdir -p /var/lib/kohakuriver
sudo chown $USER:$USER /var/lib/kohakuriver
```
