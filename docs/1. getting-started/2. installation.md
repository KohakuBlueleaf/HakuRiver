# Installation Guide

This guide walks you through the process of installing KohakuRiver on your host machine, runner nodes, and client machines.

## Prerequisites

Before installing KohakuRiver, ensure your infrastructure meets these requirements:

### Hardware Requirements
- **Host Node**: Any machine capable of running Python and Docker. Needs sufficient disk space for the software, database, Host-side Docker containers, and access to shared storage.
- **Runner Nodes**: Compute machines with sufficient CPU, RAM, and potentially GPU resources for your tasks. Needs disk space for the Runner software, Docker images, and access to shared storage.
- **Shared Storage**: A filesystem accessible from all nodes (Host and Runners) at a consistent logical path.
- **Network**: All nodes must be able to communicate with each other. Clients must be able to reach the Host API port (default 8000) and the Host SSH proxy port (default 8002).

### Software Requirements
- **Python**: Version 3.10 or newer on all machines.
- **Docker Engine**: Installed and running on both the Host and all Runner nodes. Ensure the user running KohakuRiver components has permission to interact with the Docker daemon (usually via the `docker` group).
- **Shared Filesystem**: NFS, Samba, GlusterFS, or any other shared filesystem solution mounted on all nodes.
- **`numactl`**: Optional on Runner nodes. Required for NUMA binding features.
- **NVIDIA Drivers & `nvidia-ml-py`**: Optional on Runner nodes. Required for GPU reporting and allocation features.
- **SSH Client**: Required on client machines for accessing VPS tasks using `kohakuriver vps connect`.

### Docker Configuration
KohakuRiver uses Docker's default configuration. Verify:
1. Docker daemon is running on Host and Runners.
2. The user running KohakuRiver can use Docker commands. Test with `docker run hello-world`.
3. Ensure Docker's data-root has sufficient space for images.

## Installation from Source

Install KohakuRiver on the **Host, all Runner nodes, and Client machines**.

```bash
# Clone the repository
git clone https://github.com/KohakuBlueleaf/KohakuRiver.git
cd KohakuRiver

# Install
pip install .

# With GPU monitoring support (requires NVIDIA drivers)
pip install ".[gpu]"
```

## Post-Installation Configuration

After installing KohakuRiver, generate configuration files:

```bash
# Generate both host and runner configs
kohakuriver init config --all

# Or generate specific configs
kohakuriver init config --client    # Client only
kohakuriver init config --host      # Host only
kohakuriver init config --runner    # Runner only
```

This creates configuration files at:
- `~/.kohakuriver/host_config.py`
- `~/.kohakuriver/runner_config.py`

### Critical Configuration Settings

Edit the configuration files to match your environment:

**Host Configuration** (`~/.kohakuriver/host_config.py`):
```python
# IMPORTANT: Set to actual IP/hostname reachable by runners and clients
HOST_REACHABLE_ADDRESS: str = "192.168.1.100"

# Shared storage path (must match on all nodes)
SHARED_DIR: str = "/mnt/cluster-share"

# Database file path
DB_FILE: str = "/var/lib/kohakuriver/kohakuriver.db"

# Ports
HOST_PORT: int = 8000
HOST_SSH_PROXY_PORT: int = 8002
```

**Runner Configuration** (`~/.kohakuriver/runner_config.py`):
```python
# Host server address (how runner reaches the host)
HOST_ADDRESS: str = "192.168.1.100"
HOST_PORT: int = 8000

# Shared storage path (must match on all nodes)
SHARED_DIR: str = "/mnt/cluster-share"

# Local temp storage
LOCAL_TEMP_DIR: str = "/tmp/kohakuriver"

# Runner port
RUNNER_PORT: int = 8001
```

See the [Configuration Reference](../4.%20reference/1.%20configuration.md) for all settings.

## Installation Testing

Verify KohakuRiver CLI is accessible:

```bash
kohakuriver --help
kohakuriver task --help
kohakuriver vps --help
kohakuriver docker --help
```

## Setting Up Systemd Services

For production use, run KohakuRiver as systemd services:

```bash
# Create and register both services (requires sudo)
kohakuriver init service --all

# Or create specific services
kohakuriver init service --host
kohakuriver init service --runner
```

This automatically:
1. Creates service files
2. Copies them to `/etc/systemd/system/`
3. Reloads the systemd daemon

Then start and enable the services:

**On Host machine:**
```bash
sudo systemctl start kohakuriver-host
sudo systemctl enable kohakuriver-host
sudo systemctl status kohakuriver-host
```

**On Runner nodes:**
```bash
sudo systemctl start kohakuriver-runner
sudo systemctl enable kohakuriver-runner
sudo systemctl status kohakuriver-runner
```

View logs:
```bash
journalctl -u kohakuriver-host -f
journalctl -u kohakuriver-runner -f
```

See the [Systemd Integration Guide](../2.%20admin-guides/4.%20systemd-integration.md) for more details.

## Environment Variables

You can also configure the CLI via environment variables:

| Variable | Description |
|----------|-------------|
| `KOHAKURIVER_HOST` | Host server address |
| `KOHAKURIVER_PORT` | Host server port |
| `KOHAKURIVER_SHARED_DIR` | Shared storage path |

## Next Steps

Proceed to the [Quick Start Guide](3.%20quick-start.md) to learn how to:
1. Start the Host and Runner services
2. Create a Docker environment
3. Submit your first task
4. Create a VPS instance

## Troubleshooting

If you encounter issues during installation:

1. **Verify Python version**: `python --version` (should be 3.10+)
2. **Verify Docker**: `docker info`, `docker run hello-world`
3. **Check shared directory**:
   ```bash
   ls -la /mnt/cluster-share
   touch /mnt/cluster-share/testfile && rm /mnt/cluster-share/testfile
   ```
4. **Test network connectivity**:
   ```bash
   # From runner to host
   curl http://HOST_IP:8000/health

   # From client to host
   curl http://HOST_IP:8000/nodes
   ```
5. **Check logs**:
   ```bash
   journalctl -u kohakuriver-host -f
   journalctl -u kohakuriver-runner -f
   ```

For more help, see the [Troubleshooting Guide](../5.%20troubleshooting/1.%20troubleshooting.md).
