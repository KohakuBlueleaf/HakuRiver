# Shared Storage Guide

Shared storage is a **mandatory** component of KohakuRiver. It enables container tarballs to be distributed to Runners and provides a common location for task data.

---

## Overview

### What Shared Storage Provides

| Purpose | Directory | Access |
|---------|-----------|--------|
| Container tarballs | `kohakuriver-containers/` | Host writes, Runners read |
| Task data | `shared_data/` | Tasks read/write (mounted as `/shared`) |

### Key Concept

The **physical storage** must be the same across all nodes, but the **mount paths** can differ:

```
Host:     SHARED_DIR = "/mnt/nfs/kohakuriver"
Runner 1: SHARED_DIR = "/mnt/cluster-share"
Runner 2: SHARED_DIR = "/data/shared"
```

As long as all paths point to the same physical storage, KohakuRiver works correctly.

---

## Requirements

| Requirement | Specification |
|-------------|---------------|
| **Size** | 20GB+ (depends on container images and data) |
| **Access** | Read/write for KohakuRiver user on all nodes |
| **Performance** | Moderate (large tarballs, concurrent access) |
| **Availability** | Must be accessible when tasks run |

---

## Storage Options

### NFS (Recommended)

Most common choice for Linux clusters.

**Server Setup (Ubuntu/Debian):**

```bash
# Install NFS server
sudo apt update
sudo apt install -y nfs-kernel-server

# Create export directory
sudo mkdir -p /export/kohakuriver
sudo chown nobody:nogroup /export/kohakuriver
sudo chmod 777 /export/kohakuriver

# Configure export
echo '/export/kohakuriver *(rw,sync,no_subtree_check,no_root_squash)' | sudo tee -a /etc/exports

# Apply and restart
sudo exportfs -a
sudo systemctl restart nfs-kernel-server
```

**Client Setup (Host and all Runners):**

```bash
# Install NFS client
sudo apt install -y nfs-common

# Create mount point
sudo mkdir -p /mnt/cluster-share

# Mount
sudo mount -t nfs nfs-server:/export/kohakuriver /mnt/cluster-share

# Add to /etc/fstab for persistence
echo 'nfs-server:/export/kohakuriver /mnt/cluster-share nfs defaults 0 0' | sudo tee -a /etc/fstab
```

### GlusterFS

For distributed, replicated storage across multiple servers.

**Server Setup:**

```bash
# Install on all storage nodes
sudo apt install -y glusterfs-server
sudo systemctl start glusterd
sudo systemctl enable glusterd

# Create trusted pool (on first node)
sudo gluster peer probe storage-node2
sudo gluster peer probe storage-node3

# Create brick directories
sudo mkdir -p /gluster/brick1/kohakuriver

# Create replicated volume
sudo gluster volume create kohakuriver-vol replica 3 \
  storage-node1:/gluster/brick1/kohakuriver \
  storage-node2:/gluster/brick1/kohakuriver \
  storage-node3:/gluster/brick1/kohakuriver force

sudo gluster volume start kohakuriver-vol
```

**Client Setup:**

```bash
sudo apt install -y glusterfs-client
sudo mkdir -p /mnt/cluster-share
sudo mount -t glusterfs storage-node1:/kohakuriver-vol /mnt/cluster-share

echo 'storage-node1:/kohakuriver-vol /mnt/cluster-share glusterfs defaults,_netdev 0 0' | sudo tee -a /etc/fstab
```

### Samba/CIFS

Useful for mixed Windows/Linux environments.

```bash
# Client setup
sudo apt install -y cifs-utils
sudo mkdir -p /mnt/cluster-share
sudo mount -t cifs //server/kohakuriver /mnt/cluster-share -o username=user,password=pass
```

### Other Options

- **Ceph** - Highly scalable software-defined storage
- **Amazon EFS** - AWS managed NFS
- **Azure Files** - Azure managed file share
- **Google Cloud Filestore** - GCP managed NFS

---

## Directory Structure

Create the following structure within your shared storage:

```bash
mkdir -p /mnt/cluster-share/kohakuriver-containers
mkdir -p /mnt/cluster-share/shared_data
```

**Result:**

```
/mnt/cluster-share/
├── kohakuriver-containers/    # Docker tarballs (auto-managed)
└── shared_data/               # Mounted as /shared in containers
    ├── scripts/               # Your scripts
    ├── data/                  # Input data
    └── results/               # Output data
```

---

## Configuration

### Host Configuration

```python
# ~/.kohakuriver/host_config.py
SHARED_DIR: str = "/mnt/cluster-share"
```

### Runner Configuration

```python
# ~/.kohakuriver/runner_config.py
SHARED_DIR: str = "/mnt/cluster-share"  # Must point to same physical storage
```

---

## Verification

### Test on Host

```bash
# Create test file
echo "test from host" > /mnt/cluster-share/test.txt
cat /mnt/cluster-share/test.txt
```

### Test on Runner

```bash
# Should see same file
cat /mnt/cluster-share/test.txt

# Create file from runner
echo "test from runner" > /mnt/cluster-share/runner-test.txt
```

### Verify Cross-Node Access

```bash
# Back on Host
cat /mnt/cluster-share/runner-test.txt

# Cleanup
rm /mnt/cluster-share/test.txt /mnt/cluster-share/runner-test.txt
```

---

## Performance Tuning

### NFS Mount Options

```bash
# High-performance mount options
nfs-server:/export/kohakuriver /mnt/cluster-share nfs rw,hard,intr,rsize=131072,wsize=131072,noatime 0 0
```

| Option | Description |
|--------|-------------|
| `rsize=131072` | Read buffer size (128KB) |
| `wsize=131072` | Write buffer size (128KB) |
| `noatime` | Don't update access times |
| `hard` | Retry on timeout |
| `intr` | Allow interrupt during retry |

### Network Considerations

- Use 1Gbps+ network between nodes
- Consider dedicated storage network/VLAN
- Monitor network utilization

---

## Maintenance

### Monitor Disk Usage

```bash
df -h /mnt/cluster-share
du -sh /mnt/cluster-share/*
```

### Cleanup Old Tarballs

KohakuRiver automatically prunes old tarballs when creating new ones. Manual cleanup may be needed for orphaned environments:

```bash
ls -la /mnt/cluster-share/kohakuriver-containers/
# Remove old/unused tarballs
```

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Mount fails | Check NFS server status, firewall, network |
| Permission denied | Verify user permissions, NFS exports |
| Stale file handle | Remount: `sudo umount /mnt/cluster-share && sudo mount /mnt/cluster-share` |
| Slow performance | Check network, tune mount options |
| Tarball not found | Verify SHARED_DIR matches on all nodes |

### Debug Commands

```bash
# Check mount status
mount | grep cluster-share

# Check NFS exports (on server)
showmount -e localhost

# Test NFS connectivity
showmount -e nfs-server

# Check permissions
ls -la /mnt/cluster-share/
```

---

## Next Steps

1. [Set up Host](1.%20host-setup.md) with shared storage access
2. [Set up Runners](2.%20runner-setup.md) with shared storage access
3. [Configure systemd services](4.%20systemd-integration.md)
4. [Review security](5.%20security.md) for storage access
