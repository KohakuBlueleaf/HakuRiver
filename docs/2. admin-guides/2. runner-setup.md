# Runner Setup Guide

This guide provides detailed instructions for setting up KohakuRiver Runner nodes. Runners execute tasks distributed by the Host server within Docker containers.

---

## Prerequisites

### Hardware Requirements

| Workload Type | CPU | RAM | Disk | GPU |
|--------------|-----|-----|------|-----|
| Minimum | 2+ cores | 4GB+ | 20GB+ | - |
| Compute-intensive | 8+ cores | 16GB+ | Fast SSD | Optional |
| ML/Training | 8+ cores | 32GB+ | NVMe SSD | NVIDIA GPU |

**Note:** Runners need access to shared storage for container tarballs.

### Software Requirements

| Software | Version | Purpose |
|----------|---------|---------|
| Python | 3.10+ | KohakuRiver runtime |
| Docker Engine | Latest | Task execution |
| numactl | Latest | NUMA binding (optional) |
| nvidia-ml-py | Latest | GPU monitoring (optional) |

### Supported Operating Systems

- Ubuntu 20.04/22.04/24.04 LTS
- Debian 10/11/12
- CentOS 7/8/Stream
- RHEL 7/8/9
- Any Linux with Python 3.10+ and Docker

---

## Installation

### Step 1: Install Python

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y python3 python3-pip python3-venv

# Verify version (must be 3.10+)
python3 --version
```

### Step 2: Install Docker

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io

# Add user to docker group
sudo usermod -aG docker $USER

# Start Docker
sudo systemctl start docker
sudo systemctl enable docker

# Log out and back in, then verify
docker run hello-world
```

### Step 3: Install Optional Dependencies

```bash
# NUMA support
sudo apt install -y numactl

# GPU support (requires NVIDIA drivers already installed)
pip install nvidia-ml-py
```

### Step 4: Install KohakuRiver

```bash
# Clone repository
git clone https://github.com/KohakuBlueleaf/KohakuRiver.git
cd KohakuRiver

# Create virtual environment
python3 -m venv .venv
source .venv/bin/activate

# Install (with optional GPU support)
pip install .
# Or with GPU: pip install ".[gpu]"
```

---

## Configuration

### Generate Configuration File

```bash
kohakuriver init config --runner
```

This creates `~/.kohakuriver/runner_config.py`.

### Edit Configuration

```bash
vim ~/.kohakuriver/runner_config.py
```

### Critical Settings

```python
# =============================================================================
# Network Configuration - MUST CHANGE
# =============================================================================

# Host server address (how this runner reaches the host)
HOST_ADDRESS: str = "192.168.1.100"  # CHANGE to Host IP
HOST_PORT: int = 8000

# =============================================================================
# Path Configuration - MUST CHANGE
# =============================================================================

# Shared storage path (must match Host's SHARED_DIR)
SHARED_DIR: str = "/mnt/cluster-share"

# Local temporary storage
LOCAL_TEMP_DIR: str = "/tmp/kohakuriver"
```

### Complete Configuration Reference

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| **Network** ||||
| `RUNNER_BIND_IP` | str | `"0.0.0.0"` | IP to bind runner |
| `RUNNER_PORT` | int | `8001` | Runner API port |
| `HOST_ADDRESS` | str | `"127.0.0.1"` | Host server address |
| `HOST_PORT` | int | `8000` | Host server port |
| **Paths** ||||
| `SHARED_DIR` | str | `"/mnt/cluster-share"` | Shared storage path |
| `LOCAL_TEMP_DIR` | str | `"/tmp/kohakuriver"` | Local temp storage |
| `CONTAINER_TAR_DIR` | str | `""` | Tarball dir (default: SHARED_DIR/kohakuriver-containers) |
| `NUMACTL_PATH` | str | `""` | Path to numactl binary |
| `RUNNER_LOG_FILE` | str | `""` | Log file (empty = console) |
| **Timing** ||||
| `HEARTBEAT_INTERVAL_SECONDS` | int | `5` | Heartbeat interval to Host |
| `RESOURCE_CHECK_INTERVAL_SECONDS` | int | `1` | Resource monitoring interval |
| **Execution** ||||
| `RUNNER_USER` | str | `""` | User to run tasks as |
| `DEFAULT_WORKING_DIR` | str | `"/shared"` | Container working dir |
| **Docker** ||||
| `TASKS_PRIVILEGED` | bool | `False` | Default privileged flag |
| `ADDITIONAL_MOUNTS` | list | `[]` | Extra mounts for tasks |
| `DOCKER_IMAGE_SYNC_TIMEOUT` | int | `600` | Tarball sync timeout (seconds) |
| **Logging** ||||
| `LOG_LEVEL` | LogLevel | `LogLevel.INFO` | Verbosity level |

---

## Directory Setup

### Create Required Directories

```bash
# Local temp directory
mkdir -p /tmp/kohakuriver

# Verify shared storage access
ls -la /mnt/cluster-share/kohakuriver-containers/
```

### Verify Shared Storage

```bash
# Test read access to tarballs
ls /mnt/cluster-share/kohakuriver-containers/

# Test write access to shared_data
echo "test" > /mnt/cluster-share/shared_data/test.txt
rm /mnt/cluster-share/shared_data/test.txt
```

---

## Starting the Runner

### Manual Start (Testing)

```bash
# Activate virtual environment
source /path/to/kohakuriver/.venv/bin/activate

# Start runner
kohakuriver.runner

# Or with specific config
kohakuriver.runner --config /path/to/runner_config.py
```

### Systemd Service (Production)

```bash
# Create and register service
kohakuriver init service --runner

# Start service
sudo systemctl start kohakuriver-runner

# Enable on boot
sudo systemctl enable kohakuriver-runner

# Check status
sudo systemctl status kohakuriver-runner

# View logs
journalctl -u kohakuriver-runner -f
```

---

## Verification

### Check Runner is Running

```bash
# Check service status
sudo systemctl status kohakuriver-runner

# Check Runner API
curl http://localhost:8001/health
```

### Verify Registration with Host

From any machine with CLI access:

```bash
kohakuriver node list
```

The runner should appear with status "online".

---

## GPU Setup (Optional)

### Prerequisites

1. NVIDIA drivers installed
2. NVIDIA Container Toolkit installed
3. nvidia-ml-py Python package

### Install NVIDIA Container Toolkit

```bash
# Ubuntu/Debian
distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list

sudo apt update
sudo apt install -y nvidia-container-toolkit
sudo systemctl restart docker
```

### Verify GPU Access

```bash
# Test Docker GPU access
docker run --rm --gpus all nvidia/cuda:11.8.0-base-ubuntu22.04 nvidia-smi
```

### Runner GPU Detection

When the Runner starts, it automatically detects GPUs if nvidia-ml-py is installed. Check Host logs or `kohakuriver node list` to verify GPU info is reported.

---

## NUMA Configuration (Optional)

For compute-intensive workloads on NUMA systems:

```bash
# Install numactl
sudo apt install -y numactl

# Verify NUMA topology
numactl --hardware

# Set path in config (if not in system PATH)
NUMACTL_PATH: str = "/usr/bin/numactl"
```

Tasks can then target specific NUMA nodes:
```bash
kohakuriver task submit -t node1:0 -- ./compute_task.sh
```

---

## Firewall Configuration

```bash
# Ubuntu/Debian with UFW
sudo ufw allow from <host_ip> to any port 8001/tcp   # Runner API
sudo ufw enable
```

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Registration failure | Check HOST_ADDRESS, HOST_PORT, network connectivity |
| Docker errors | Verify Docker running, user in docker group |
| Shared storage errors | Check mount, permissions, SHARED_DIR config |
| GPU not detected | Install nvidia-ml-py, check NVIDIA drivers |
| Task failures | Check task logs, tarball exists, Docker space |

### Check Logs

```bash
# Systemd logs
journalctl -u kohakuriver-runner -f

# Or if using log file
tail -f /path/to/runner.log
```

### Common Commands

```bash
# Restart runner
sudo systemctl restart kohakuriver-runner

# Check Docker images
docker images | grep kohakuriver

# Check disk space
df -h /var/lib/docker
df -h /mnt/cluster-share
```

---

## Next Steps

1. [Configure shared storage](3.%20shared-storage.md)
2. [Set up systemd services](4.%20systemd-integration.md)
3. [Review security considerations](5.%20security.md)
4. Test task submission from a client
