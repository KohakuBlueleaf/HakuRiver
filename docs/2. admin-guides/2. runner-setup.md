# Runner Setup Guide

This guide provides detailed instructions for setting up and configuring HakuRiver Runner nodes. Runners execute tasks distributed by the Host server, so proper setup is essential for reliable operation.

## Hardware Requirements

Runner hardware requirements depend on the workloads you plan to run:

### Minimum Requirements
- **CPU**: 2+ cores
- **RAM**: 4GB+
- **Disk**:
  - 20GB+ for the Runner software and Docker
  - Local temporary storage for task processing
  - Access to shared storage for container tarballs and logs

### Recommended for Compute-Intensive Workloads
- **CPU**: 8+ cores
- **RAM**: 16GB+
- **Disk**: Fast local SSD for temporary files
- **Network**: 1Gbps+ connectivity to the Host and shared storage

## Operating System Requirements

HakuRiver Runner has been tested on:
- Ubuntu 20.04/22.04/24.04 LTS
- Should works on any Linux distribution with Python 3.10+ and Docker

## Software Prerequisites

### Python Installation

HakuRiver requires Python 3.10 or newer:

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3 python3-pip python3-venv

# CentOS/RHEL 8
sudo dnf install python3 python3-pip

# Check version
python3 --version
```

If your distribution doesn't provide Python 3.10+, consider using pyenv:

```bash
# Install pyenv prerequisites
sudo apt install -y build-essential libssl-dev zlib1g-dev libbz2-dev \
libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
xz-utils tk-dev libffi-dev liblzma-dev python3-openssl git

# Install pyenv
curl https://pyenv.run | bash

# Add to shell config
echo 'export PATH="$HOME/.pyenv/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(pyenv init --path)"' >> ~/.bashrc
echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.bashrc
source ~/.bashrc

# Install Python 3.10
pyenv install 3.10.0
pyenv global 3.10.0
```

### Docker Installation

Runners require Docker for task execution:

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io

# CentOS/RHEL 8
sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo dnf install docker-ce docker-ce-cli containerd.io

# Add current user to docker group
sudo usermod -aG docker $USER
# Log out and back in to apply group change

# Start and enable Docker service
sudo systemctl start docker
sudo systemctl enable docker

# Check Docker installation
docker run hello-world
```

#### Docker Configuration

Considerations for `data-root`:
- Choose a location with sufficient disk space
- Prefer SSD for better performance
- Set consistent data-root path across all nodes if possible

For storage-driver:
- `overlay2` is recommended for most Linux distributions
- `btrfs` can be used if your filesystem supports it
- `devicemapper` may be needed on older systems

Verify Docker configuration:
```bash
docker info | grep -E 'Storage Driver|Docker Root Dir'
```

### NUMA and Systemd Tools Installation

For NUMA support and systemd fallback functionality:

```bash
# Ubuntu/Debian
sudo apt install -y numactl systemd-container

# CentOS/RHEL
sudo dnf install -y numactl systemd
```

## HakuRiver Installation

### Option 1: Install via pip

```bash
# Create a virtual environment (recommended)
python3 -m venv ~/.venv/hakuriver
source ~/.venv/hakuriver/bin/activate

# Install HakuRiver
pip install hakuriver
```

### Option 2: Install from Source

```bash
# Clone repository
git clone https://github.com/KohakuBlueleaf/HakuRiver.git
cd HakuRiver

# Create and activate virtual environment
python3 -m venv .venv
source .venv/bin/activate

# Install
pip install -e .
```

## Runner Configuration

### Create Configuration Directory

```bash
# Initialize config
hakuriver.init config
```

This creates a default configuration at `~/.hakuriver/config.toml`.

### Edit Configuration

```bash
vim ~/.hakuriver/config.toml
```

#### Critical Runner Configuration Settings

```toml
[network]
# Address of the Host server (accessible from this Runner)
host_reachable_address = "192.168.1.100"

# Port the Host is listening on
host_port = 8000

# Address of this Runner (accessible from the Host)
# IMPORTANT: Must be the actual IP or hostname of this machine
runner_address = "192.168.1.101"

# Port this Runner will listen on
runner_port = 8001

[paths]
# Path to shared storage
# This must point to the same physical storage as on the Host, but the path can be different
shared_dir = "/mnt/shared"

# Path to local temporary storage
local_temp_dir = "/tmp/hakuriver-temp"

# Path to numactl executable (for NUMA support)
numactl_path = "/usr/bin/numactl"

[environment]
# User to run tasks as (default: current user)
runner_user = ""
```

### Create Directories

Ensure all necessary directories exist:

```bash
# Create local temp directory
sudo mkdir -p /tmp/hakuriver-temp
sudo chown $USER:$USER /tmp/hakuriver-temp

# Create shared directory mount point (if not already mounted)
sudo mkdir -p /mnt/shared
```

## Shared Storage Setup

The Runner needs access to shared storage for:
- Container tarballs
- Task output logs
- Input/output data for tasks

The path can be different from the Host, but it must point to the same physical storage.

See [Shared Storage](shared-storage.md) for detailed setup instructions.

### Mounting Shared Storage on Runners

Example mount commands:

```bash
# For NFS
sudo mount -t nfs host-server:/export/hakuriver /mnt/shared

# For CIFS/SMB
sudo mount -t cifs //server/share /mnt/shared -o username=user,password=pass

# For GlusterFS
sudo mount -t glusterfs host-server:/volume /mnt/shared
```

Add to /etc/fstab for persistence:

```
host-server:/export/hakuriver /mnt/shared nfs defaults 0 0
```

### Testing Shared Storage

Verify shared storage works correctly:

```bash
# Check for test file created by Host
cat /mnt/shared/test-file.txt

# Create a new file
echo "runner test" > /mnt/shared/runner-test.txt

# Verify it's visible from other nodes
ssh other-node "cat /mnt/shared/runner-test.txt"
```

## Systemd Permissions

The Runner may need to execute tasks using systemd-run. Configure sudo permissions:

```bash
# Edit sudoers file
sudo visudo

# Add the following lines, replacing 'username' with your Runner user
username ALL=(ALL) NOPASSWD: /usr/bin/systemd-run, /usr/bin/systemctl
```

## Starting the Runner Agent

### Running Manually

For testing or debugging:

```bash
# Start in foreground
hakuriver.runner

# Start with specific config
hakuriver.runner --config /path/to/custom-config.toml
```

### Running as Systemd Service

For production use:

```bash
# Create systemd service
hakuriver.init service --runner

# Start and enable service
sudo systemctl start hakuriver-runner.service
sudo systemctl enable hakuriver-runner.service

# Check status
sudo systemctl status hakuriver-runner.service
```

See [Systemd Integration](systemd-integration.md) for more details.

## Verifying Runner Registration

After starting the Runner, verify it has registered with the Host:

```bash
# On the Host machine or any client
hakuriver.client --list-nodes
```

The Runner should appear in the list with status "online".

## NUMA Configuration

For servers with NUMA architecture:

### Detecting NUMA Topology

```bash
# Check NUMA topology
numactl --hardware
```

### Configuring for NUMA Support

Ensure `numactl_path` is set correctly in the configuration:

```toml
[paths]
numactl_path = "/usr/bin/numactl"
```

Tasks can then be submitted with NUMA targeting:

```bash
hakuriver.client --target node1:0 --container NULL -- command
```

## Multiple Runners on the Same Machine

For testing or special use cases, you may want to run multiple Runners on the same machine:

```bash
# Create separate config files
cp ~/.hakuriver/config.toml ~/.hakuriver/runner1.toml
cp ~/.hakuriver/config.toml ~/.hakuriver/runner2.toml

# Edit runner-specific settings (especially runner_port)
vim ~/.hakuriver/runner1.toml
vim ~/.hakuriver/runner2.toml

# Start runners with different configs
hakuriver.runner --config ~/.hakuriver/runner1.toml
hakuriver.runner --config ~/.hakuriver/runner2.toml
```

## Firewall Configuration

Configure the firewall to allow necessary traffic:

```bash
# Ubuntu/Debian with UFW
sudo ufw allow 8001/tcp  # Runner API (adjust if using a different port)

# CentOS/RHEL with firewalld
sudo firewall-cmd --permanent --add-port=8001/tcp
sudo firewall-cmd --reload
```

## Runner Management

### Checking Runner Status

```bash
# Check service status
sudo systemctl status hakuriver-runner.service

# Check logs
sudo journalctl -u hakuriver-runner.service

# Check if API is responding
curl http://localhost:8001/health
```

### Restarting Runner

```bash
sudo systemctl restart hakuriver-runner.service
```

## Troubleshooting

### Common Issues

#### Registration Failure

```
ERROR: Failed to register with host at http://host-server:8000
```

Solution:
- Verify Host is running and accessible
- Check network connectivity: `ping host-server`
- Verify Host and Runner ports in configuration
- Check firewall rules

#### Docker-related Errors

```
ERROR: Cannot connect to Docker daemon
```

Solution:
- Ensure Docker is running: `systemctl status docker`
- Check user is in docker group: `groups $USER`
- Verify Docker socket permissions: `ls -l /var/run/docker.sock`

#### Shared Storage Access Problems

```
ERROR: Cannot access shared directory
```

Solution:
- Verify shared storage is mounted: `df -h /mnt/shared`
- Check mount permissions: `ls -la /mnt/shared`
- Ensure `shared_dir` is correctly set in configuration

#### Systemd Permission Issues

```
ERROR: Permission denied when executing systemd-run
```

Solution:
- Check sudo configuration: `sudo -l | grep systemd-run`
- Add necessary permissions in sudoers file

#### Task Execution Failures

```
ERROR: Task failed to start
```

Solution:
- Check container tarball exists in shared storage
- Verify Docker has sufficient disk space: `df -h /var/lib/docker`
- Check task output logs for specific errors

## Performance Optimization

### Docker Image Caching

Pre-pull frequently used base images:

```bash
docker pull python:3.11-slim
docker pull ubuntu:22.04
```

### Local Temp Directory

Use fast storage for the local temp directory:

```toml
[paths]
local_temp_dir = "/mnt/nvme/hakuriver-temp"
```

### NUMA Binding

For compute-intensive workloads, use NUMA targeting to improve memory access performance:

```bash
hakuriver.client --target node1:0 -- command
```

## Next Steps

After setting up Runner nodes:

1. [Configure shared storage](shared-storage.md) for all nodes
2. [Set up systemd services](systemd-integration.md) for reliable operation
3. [Implement security measures](security.md) to protect your cluster
4. Test the cluster with a simple task submission