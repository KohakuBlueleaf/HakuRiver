# Security Guide

This guide covers security considerations for deploying KohakuRiver. While designed for trusted research environments, implementing appropriate security measures is still important.

---

## Security Model

### Trust Assumptions

| Component | Trust Level |
|-----------|-------------|
| **Host** | Central authority, fully trusted |
| **Runners** | Trusted agents executing Host commands |
| **Clients** | Trusted users with network access |
| **Storage** | Shared among all components |

### Key Points

- Authentication between components is minimal by default
- Security relies primarily on network access control
- Designed for research labs, small teams, and home labs
- All nodes should be under unified administrative control

---

## Network Security

### Recommended Network Topology

| Network | Purpose | Access |
|---------|---------|--------|
| **Management** | Host-Runner API | Host and Runner IPs only |
| **Storage** | Shared filesystem | Cluster nodes only |
| **Client** | User access to Host | Internal network |

### Firewall Configuration

**Host Node:**

```bash
# Ubuntu/Debian with UFW
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Allow Host API (from Runners and Clients)
sudo ufw allow from <runner_network> to any port 8000 proto tcp
sudo ufw allow from <client_network> to any port 8000 proto tcp

# Allow SSH Proxy (from Clients)
sudo ufw allow from <client_network> to any port 8002 proto tcp

# Allow SSH for administration
sudo ufw allow ssh

sudo ufw enable
```

**Runner Nodes:**

```bash
# Only allow connections from Host
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Allow Runner API (from Host only)
sudo ufw allow from <host_ip> to any port 8001 proto tcp

# Allow SSH for administration
sudo ufw allow ssh

sudo ufw enable
```

### Port Summary

| Port | Service | Access From |
|------|---------|-------------|
| `8000` | Host API | Runners, Clients |
| `8001` | Runner API | Host only |
| `8002` | SSH Proxy | Clients |

---

## Authentication

### Current State

KohakuRiver has minimal built-in authentication:

- API endpoints are unprotected by default
- Relies on network access control
- Anyone with network access can submit tasks

### Recommendations

| Environment | Recommendation |
|-------------|----------------|
| **Isolated network** | Default configuration is acceptable |
| **Shared network** | Place behind VPN or authenticated proxy |
| **Web dashboard** | Always add authentication (see below) |

### Securing the Web Dashboard

Never expose the dashboard directly to the internet:

```nginx
# Nginx example with basic auth
server {
    listen 443 ssl;
    server_name kohakuriver.internal;

    auth_basic "KohakuRiver Dashboard";
    auth_basic_user_file /etc/nginx/.htpasswd;

    location / {
        proxy_pass http://localhost:8080;
    }

    location /api {
        proxy_pass http://localhost:8000;
    }
}
```

---

## Docker Security

### Container Privileges

| Setting | Default | Description |
|---------|---------|-------------|
| `TASKS_PRIVILEGED` | `False` | Run containers with `--privileged` |

**Never enable privileged mode unless absolutely necessary.** Privileged containers have nearly unlimited host access.

### Docker Socket Protection

The Docker socket grants root-level access:

```bash
# Verify docker group membership
groups $USER | grep docker

# Only the runner user should be in docker group
```

### Image Security Best Practices

| Practice | Description |
|----------|-------------|
| **Trusted sources** | Use official Docker Hub images |
| **Minimal images** | Prefer Alpine or slim variants |
| **Regular updates** | Rebuild images with security patches |
| **Scan images** | Use Trivy, Clair, or Docker Scout |

### Resource Limits

Always specify limits for tasks:

```bash
kohakuriver task submit --cores 4 --memory 8G ...
```

This prevents:
- Resource exhaustion attacks
- Runaway processes consuming all resources
- Denial of service from misbehaving tasks

---

## Storage Security

### Shared Storage Permissions

| Directory | Permissions | Access |
|-----------|-------------|--------|
| `kohakuriver-containers/` | `755` | Host writes, Runners read |
| `shared_data/` | `777` or per-user | Tasks read/write |

### Secure Setup

```bash
# Set ownership
sudo chown -R kohakuriver:kohakuriver /mnt/cluster-share/

# Container directory (Host writes)
chmod 755 /mnt/cluster-share/kohakuriver-containers/

# Shared data (adjust based on needs)
chmod 1777 /mnt/cluster-share/shared_data/  # Sticky bit
```

### NFS Security

For NFSv4 with security:

```bash
# /etc/exports (server)
/export/kohakuriver *(rw,sync,no_subtree_check,sec=krb5p)
```

---

## User and Service Security

### Dedicated System Users

Create unprivileged users for services:

```bash
# Host user
sudo useradd --system --no-create-home kohakuriver-host

# Runner user (needs docker access)
sudo useradd --system --no-create-home kohakuriver-runner
sudo usermod -aG docker kohakuriver-runner
```

### Least Privilege

**For Runner users requiring sudo:**

```bash
# /etc/sudoers.d/kohakuriver
kohakuriver-runner ALL=(ALL) NOPASSWD: /usr/bin/docker
```

Never use `NOPASSWD: ALL`.

### Systemd Hardening

Add to service files:

```ini
[Service]
# Filesystem restrictions
PrivateTmp=true
ProtectHome=read-only
ProtectSystem=strict
ReadWritePaths=/var/lib/kohakuriver /mnt/cluster-share

# Execution restrictions
NoNewPrivileges=true
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectControlGroups=true
```

---

## VPS Task Security

VPS tasks provide interactive shell access and require extra attention.

### SSH Security

| Setting | Recommendation |
|---------|----------------|
| **Authentication** | Public key only, never password |
| **Root access** | Consider non-root user if possible |
| **SSH config** | Harden `/etc/ssh/sshd_config` in images |

### Container Hardening for VPS

When building VPS-capable images:

```dockerfile
# Minimal SSH server configuration
RUN sed -i 's/#PermitEmptyPasswords no/PermitEmptyPasswords no/' /etc/ssh/sshd_config
RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
```

### Resource Limits for VPS

Always set limits to prevent resource exhaustion:

```bash
kohakuriver vps create node1 --cores 2 --memory 4G
```

---

## Monitoring and Audit

### Log Monitoring

```bash
# Forward logs to central server
# /etc/systemd/journald.conf
[Journal]
ForwardToSyslog=yes
```

Watch for:
- Failed connection attempts
- Unusual task submissions
- Resource exhaustion events
- Service restarts

### System Monitoring

| Tool | Purpose |
|------|---------|
| `htop` | Real-time process monitoring |
| `netstat`/`ss` | Network connections |
| `auditd` | System audit logging |
| `AIDE` | File integrity monitoring |

---

## Security Checklist

### Network

- [ ] Firewall enabled on all nodes
- [ ] Host API accessible only from trusted networks
- [ ] Runner API accessible only from Host
- [ ] SSH Proxy accessible only from client network
- [ ] Web dashboard behind authenticated proxy

### Docker

- [ ] `TASKS_PRIVILEGED = False`
- [ ] Docker group limited to runner user only
- [ ] Base images from trusted sources
- [ ] Regular image updates scheduled

### Storage

- [ ] Proper permissions on shared directories
- [ ] No sensitive data in shared storage
- [ ] Secure mount options for NFS

### Services

- [ ] Dedicated system users for services
- [ ] Minimal sudo permissions
- [ ] Systemd hardening applied
- [ ] Log monitoring configured

### VPS

- [ ] SSH key authentication only
- [ ] Resource limits enforced
- [ ] Session monitoring in place

---

## What KohakuRiver Does NOT Provide

| Feature | Status |
|---------|--------|
| Multi-tenant isolation | Not designed for this |
| API authentication | None by default |
| Encrypted inter-node communication | Not implemented |
| User quotas | Not implemented |
| Audit logging | Basic only |

For environments requiring these features, consider Kubernetes with RBAC or a full HPC scheduler like Slurm.

---

## Next Steps

1. Apply firewall rules to all nodes
2. Secure web dashboard with authentication
3. Create dedicated service users
4. Set up log monitoring
5. Establish image update schedule
