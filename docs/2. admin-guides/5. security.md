# Security Guide

This guide covers security considerations and recommendations for deploying HakuRiver in a secure environment. While HakuRiver is designed for small to medium research clusters rather than multi-tenant production environments, implementing appropriate security measures is still important.

## Security Model Overview

HakuRiver operates on a trust-based model where:

- The Host coordinates and distributes tasks
- Runners execute tasks within Docker containers or via systemd
- All components share a common storage system
- Authentication between components is minimal by default

This model is appropriate for research labs and teams where all nodes are under unified administrative control. For more sensitive environments, additional security measures should be implemented.

## Network Security

### Network Topology

Consider implementing a tiered network structure:

1. **Management Network**: For Host-Runner communication
2. **Storage Network**: For shared storage access
3. **External Network**: For user access to the Host API and dashboard

This separation provides defense-in-depth and limits exposure.

### Firewall Configuration

Restrict network access to only necessary services:

**Host Node**:
```bash
# Ubuntu/Debian with UFW
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 8000/tcp  # Host API
sudo ufw allow 80/tcp    # Web dashboard HTTP (if used)
sudo ufw allow 443/tcp   # Web dashboard HTTPS (if used)
sudo ufw enable

# CentOS/RHEL with firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-port=8000/tcp
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload
```

**Runner Nodes**:
```bash
# Ubuntu/Debian with UFW
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 8001/tcp  # Runner API (only from Host network)
sudo ufw enable

# CentOS/RHEL with firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-port=8001/tcp
sudo firewall-cmd --reload
```

### Network Access Control

Restrict Runner API access to only the Host:

```bash
# IP-based restriction in UFW
sudo ufw allow from host-ip to any port 8001 proto tcp

# In firewalld
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="host-ip" port port="8001" protocol="tcp" accept'
sudo firewall-cmd --reload
```

## Authentication and Authorization

### Web Dashboard Security

Secure the web dashboard with:

1. **HTTPS**:
   ```nginx
   server {
       listen 443 ssl;
       server_name hakuriver.example.com;
       
       ssl_certificate /etc/letsencrypt/live/hakuriver.example.com/fullchain.pem;
       ssl_certificate_key /etc/letsencrypt/live/hakuriver.example.com/privkey.pem;
       
       # Modern SSL configuration
       ssl_protocols TLSv1.2 TLSv1.3;
       ssl_prefer_server_ciphers on;
       ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
       ssl_session_timeout 1d;
       ssl_session_cache shared:SSL:10m;
       
       location / {
           root /var/www/hakuriver;
           index index.html;
           try_files $uri $uri/ /index.html;
       }
       
       location /api/ {
           proxy_pass http://localhost:8000/;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection "upgrade";
           proxy_set_header Host $host;
       }
   }
   ```

2. **Authentication**:
   - Add HTTP Basic Authentication
   - Implement OAuth or LDAP integration
   - Use a VPN or IP restrictions for access

## Docker Security

HakuRiver uses Docker for task execution, which introduces several security considerations:

### Container Privilege Controls

By default, HakuRiver containers run without privileged mode. Maintain this restriction:

```toml
# In config.toml
[docker]
tasks_privileged = false
```

When using the client, avoid the `--privileged` flag unless absolutely necessary:

```bash
# Avoid unless needed
hakuriver.client --target node1 --privileged -- command
```

### Docker Socket Protection

The Docker socket is a sensitive resource. Protect it:

```bash
# Check socket permissions
ls -la /var/run/docker.sock
# Should be: srw-rw---- 1 root docker

# Ensure only necessary users are in the docker group
getent group docker
```

### Image Security

1. **Scan container images** for vulnerabilities:
   ```bash
   # Install trivy
   sudo apt install trivy
   
   # Scan an image
   trivy image python:3.11-slim
   ```

2. **Use trusted base images** from official repositories

3. **Keep base images updated**:
   ```bash
   # Update base images regularly
   docker pull python:3.11-slim
   docker pull ubuntu:22.04
   ```

### Container Resource Limits

Always set resource limits on containers to prevent denial-of-service:

```bash
hakuriver.client --target node1 --cores 2 --memory 4G -- command
```

These translate to Docker's `--cpus` and `--memory` flags.

## File and Storage Security

### Shared Storage Permissions

Configure appropriate permissions on shared storage:

```bash
# Create directory structure with proper permissions
sudo mkdir -p /mnt/hakuriver-shared/hakuriver-containers
sudo mkdir -p /mnt/hakuriver-shared/task_outputs
sudo mkdir -p /mnt/hakuriver-shared/task_errors
sudo mkdir -p /mnt/hakuriver-shared/shared_data

# Set ownership (adjust user/group as needed)
sudo chown -R hakuriver_user:hakuriver_group /mnt/hakuriver-shared

# Set restrictive permissions
sudo chmod 750 /mnt/hakuriver-shared
sudo chmod 750 /mnt/hakuriver-shared/hakuriver-containers
sudo chmod 770 /mnt/hakuriver-shared/task_outputs
sudo chmod 770 /mnt/hakuriver-shared/task_errors
sudo chmod 770 /mnt/hakuriver-shared/shared_data
```

## User and Service Security

### Dedicated Service Users

Create dedicated users for HakuRiver services:

```bash
# Create a dedicated user
sudo useradd -r -m -d /opt/hakuriver hakuriver_user
sudo usermod -aG docker hakuriver_user

# Update service files to use this user
sudo systemctl edit hakuriver-host.service
# Add: User=hakuriver_user
```

### Least Privilege Principle

Apply the principle of least privilege:

1. **Systemd Permissions**:
   
   Restrict sudo permissions to only what's needed:
   ```bash
   # In /etc/sudoers
   hakuriver_user ALL=(ALL) NOPASSWD: /usr/bin/systemd-run, /usr/bin/systemctl status hakuriver-*
   ```

2. **Docker Group**:
   
   Be cautious with docker group membership as it's equivalent to root access:
   ```bash
   # Consider using rootless Docker where possible
   sudo apt install uidmap
   dockerd-rootless-setuptool.sh install
   ```

### Systemd Service Hardening

Harden systemd services with security directives:

```ini
[Service]
# Filesystem access restrictions
ProtectSystem=strict
ProtectHome=read-only
ReadWritePaths=/mnt/hakuriver-shared /var/log/hakuriver
PrivateTmp=true

# Execution environment restrictions
NoNewPrivileges=true
CapabilityBoundingSet=
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectControlGroups=true

# System call restrictions
SystemCallFilter=@system-service
SystemCallErrorNumber=EPERM
```

## Monitoring and Audit

### Logging and Audit

Configure comprehensive logging:

1. **Centralized Logging**:
   
   Set up rsyslog to forward logs to a central server:
   ```bash
   # In /etc/rsyslog.d/hakuriver.conf
   if $programname == 'hakuriver-host' or $programname == 'hakuriver-runner' then @logserver.example.com:514
   ```

2. **Log Monitoring**:
   
   Use tools like Fail2ban to monitor for suspicious activity:
   ```bash
   # Example Fail2ban filter for repeated authentication failures
   sudo tee /etc/fail2ban/filter.d/hakuriver.conf << EOF
   [INCLUDES]
   before = common.conf
   
   [Definition]
   failregex = Authentication failure for user .* from <HOST>
   ignoreregex =
   EOF
   ```

### System Monitoring

Monitor system components for security issues:

1. **File Integrity Monitoring**:
   ```bash
   # Install AIDE
   sudo apt install aide
   
   # Configure monitoring for HakuRiver directories
   sudo tee -a /etc/aide/aide.conf << EOF
   
   # HakuRiver specific rules
   /opt/hakuriver/ NORMAL
   /etc/hakuriver/ NORMAL
   EOF
   
   # Initialize database
   sudo aideinit
   ```

2. **Process Monitoring**:
   ```bash
   # Check for unexpected processes
   ps aux | grep hakuriver
   ```

## Task Execution Security

### Script Validation

Implement checks for tasks before execution:

```python
# Example validation function
def validate_task(command, args):
    # Disallow certain commands
    forbidden_cmds = ['rm', 'dd', 'mkfs', 'format']
    if any(cmd in command for cmd in forbidden_cmds):
        return False
    # Check arguments
    for arg in args:
        if arg.startswith('--dangerous'):
            return False
    return True
```

### Container Isolation

Enhance container isolation:

```bash
# Add security flags to Docker run commands
docker run --security-opt=no-new-privileges --cap-drop=ALL --cap-add=NET_BIND_SERVICE ...
```

### Resource Limits

Implement system-wide resource limits:

```bash
# In /etc/security/limits.conf
hakuriver_user soft nproc 1024
hakuriver_user hard nproc 2048
hakuriver_user soft nofile 4096
hakuriver_user hard nofile 8192
```