# Host Setup Guide

This guide provides detailed instructions for setting up the KohakuRiver Host server - the central component responsible for managing tasks, tracking nodes, handling Docker environments, and running the SSH proxy for VPS tasks.

---

## Prerequisites

### Hardware Requirements

| Cluster Size | CPU | RAM | Disk |
|-------------|-----|-----|------|
| Small (3-10 nodes) | 2+ cores | 4GB+ | 40GB+ |
| Medium (10-20 nodes) | 4+ cores | 8GB+ | 40GB+ |

**Note:** Host also needs access to shared storage for container tarballs.

### Software Requirements

| Software | Version | Purpose |
|----------|---------|---------|
| Python | 3.10+ | KohakuRiver runtime |
| Docker Engine | Latest | Environment management |
| Shared Filesystem | NFS/GlusterFS | Tarball distribution |

### Supported Operating Systems

- Ubuntu 20.04/22.04 LTS
- Debian 10/11/12
- CentOS 7/8/Stream
- RHEL 7/8/9
- Any Linux with Python 3.10+ and Docker

---

## Installation

### Step 1: Install Python

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y python3 python3-pip python3-venv

# Verify version (must be 3.10+)
python3 --version
```

### Step 2: Install Docker

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io

# Add user to docker group
sudo usermod -aG docker $USER

# Log out and back in, then verify
docker run hello-world
```

### Step 3: Install KohakuRiver

```bash
# Clone repository
git clone https://github.com/KohakuBlueleaf/KohakuRiver.git
cd KohakuRiver

# Create virtual environment (recommended)
python3 -m venv .venv
source .venv/bin/activate

# Install
pip install .
```

---

## Configuration

### Generate Configuration File

```bash
kohakuriver init config --host
```

This creates `~/.kohakuriver/host_config.py`.

### Edit Configuration

```bash
vim ~/.kohakuriver/host_config.py
```

### Critical Settings

```python
# =============================================================================
# Network Configuration - MUST CHANGE
# =============================================================================

# Address that runners/clients use to reach this host
# CHANGE THIS to actual IP accessible over network
HOST_REACHABLE_ADDRESS: str = "192.168.1.100"

# =============================================================================
# Path Configuration - MUST CHANGE
# =============================================================================

# Shared storage path (must match on all nodes)
SHARED_DIR: str = "/mnt/cluster-share"

# Database file path
DB_FILE: str = "/var/lib/kohakuriver/kohakuriver.db"
```

### Complete Configuration Reference

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| **Network** ||||
| `HOST_BIND_IP` | str | `"0.0.0.0"` | IP to bind server |
| `HOST_PORT` | int | `8000` | API port |
| `HOST_SSH_PROXY_PORT` | int | `8002` | SSH proxy port |
| `HOST_REACHABLE_ADDRESS` | str | `"127.0.0.1"` | Address for runners/clients |
| **Paths** ||||
| `SHARED_DIR` | str | `"/mnt/cluster-share"` | Shared storage path |
| `DB_FILE` | str | See default | SQLite database path |
| `CONTAINER_DIR` | str | `""` | Tarball dir (default: SHARED_DIR/kohakuriver-containers) |
| `HOST_LOG_FILE` | str | `""` | Log file (empty = console) |
| **Timing** ||||
| `HEARTBEAT_INTERVAL_SECONDS` | int | `5` | Expected heartbeat interval |
| `HEARTBEAT_TIMEOUT_FACTOR` | int | `6` | Offline after interval Ã— factor |
| `CLEANUP_CHECK_INTERVAL_SECONDS` | int | `10` | Dead runner check interval |
| **Docker** ||||
| `DEFAULT_CONTAINER_NAME` | str | `"kohakuriver-base"` | Default environment |
| `INITIAL_BASE_IMAGE` | str | `"python:3.12-alpine"` | Initial base image |
| `TASKS_PRIVILEGED` | bool | `False` | Default privileged flag |
| `ADDITIONAL_MOUNTS` | list | `[]` | Extra mounts for tasks |
| `DEFAULT_WORKING_DIR` | str | `"/shared"` | Container working dir |
| **Logging** ||||
| `LOG_LEVEL` | LogLevel | `LogLevel.INFO` | Verbosity level |

---

## Directory Setup

### Create Required Directories

```bash
# Database directory
sudo mkdir -p /var/lib/kohakuriver
sudo chown $USER:$USER /var/lib/kohakuriver

# Shared storage directories (if Host has access)
mkdir -p /mnt/cluster-share/kohakuriver-containers
mkdir -p /mnt/cluster-share/shared_data
```

### Verify Shared Storage

```bash
# Test write access
echo "test" > /mnt/cluster-share/test.txt
cat /mnt/cluster-share/test.txt
rm /mnt/cluster-share/test.txt
```

---

## Starting the Host

### Manual Start (Testing)

```bash
# Activate virtual environment
source /path/to/kohakuriver/.venv/bin/activate

# Start host
kohakuriver.host

# Or with specific config
kohakuriver.host --config /path/to/host_config.py
```

### Systemd Service (Production)

```bash
# Create and register service
kohakuriver init service --host

# Start service
sudo systemctl start kohakuriver-host

# Enable on boot
sudo systemctl enable kohakuriver-host

# Check status
sudo systemctl status kohakuriver-host

# View logs
journalctl -u kohakuriver-host -f
```

---

## Verification

### Check Host is Running

```bash
# Check service status
sudo systemctl status kohakuriver-host

# Test API endpoint
curl http://localhost:8000/health

# List nodes (should be empty initially)
curl http://localhost:8000/nodes
```

### Verify Default Container

On first startup, Host creates the default container tarball:

```bash
ls -la /mnt/cluster-share/kohakuriver-containers/
# Should show: kohakuriver-base-<timestamp>.tar
```

---

## Firewall Configuration

```bash
# Ubuntu/Debian with UFW
sudo ufw allow 8000/tcp   # Host API
sudo ufw allow 8002/tcp   # SSH Proxy
sudo ufw enable
```

---

## Web Dashboard (Optional)

The web dashboard is a separate Vue.js application:

```bash
cd src/kohakuriver-manager
npm install
npm run dev      # Development
npm run build    # Production build
```

For production, serve the built files with a web server (Nginx, Caddy) and proxy API requests to the Host.

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Cannot connect to Host | Check firewall, `HOST_BIND_IP`, `HOST_PORT`, service status |
| Database errors | Verify directory exists and is writable |
| Docker errors | Check Docker is running, user is in docker group |
| Shared storage errors | Verify mount and permissions |

### Check Logs

```bash
# Systemd logs
journalctl -u kohakuriver-host -f

# Or if using log file
tail -f /path/to/host.log
```

---

## Next Steps

1. [Set up Runner nodes](2.%20runner-setup.md)
2. [Configure shared storage](3.%20shared-storage.md)
3. [Set up systemd services](4.%20systemd-integration.md)
4. [Review security considerations](5.%20security.md)
