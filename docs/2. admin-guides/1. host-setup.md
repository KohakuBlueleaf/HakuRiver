# Host Setup Guide

This guide provides detailed instructions for setting up and configuring the HakuRiver Host server. The Host is the central component of the HakuRiver system, responsible for managing tasks, tracking nodes, and handling Docker environments.

## Hardware Requirements

For a typical small to medium cluster (3-10 nodes):

- **CPU**: 2+ cores
- **RAM**: 4GB+ (more for larger clusters)
- **Disk**: 
  - 40GB+ for the Host software, database and docker containers
  - Access to shared storage for tarballs and task logs

For larger clusters (10+ nodes):

- **CPU**: 4+ cores
- **RAM**: 8GB+
- **Disk**: 40GB+ plus shared storage

## Operating System Requirements

HakuRiver Host has been tested on:

- Ubuntu 20.04/22.04 LTS
- Debian 10/11
- CentOS 7/8
- RHEL 7/8
- Any Linux distribution with Python 3.10+ and Docker

## Software Prerequisites

### Python Installation

HakuRiver requires Python 3.10 or newer:

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3 python3-pip python3-venv

# Check version
python3 --version
```

If your distribution doesn't provide Python 3.10+, consider using pyenv:

```bash
# Install pyenv prerequisites
sudo apt install -y build-essential libssl-dev zlib1g-dev libbz2-dev \
libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
xz-utils tk-dev libffi-dev liblzma-dev python3-openssl git

# Install pyenv
curl https://pyenv.run | bash

# Add to shell config
echo 'export PATH="$HOME/.pyenv/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(pyenv init --path)"' >> ~/.bashrc
echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.bashrc
source ~/.bashrc

# Install Python 3.10
pyenv install 3.10.0
pyenv global 3.10.0
```

### Docker Installation

The Host requires Docker for managing container environments:

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io

# Add current user to docker group
sudo usermod -aG docker $USER
# Log out and back in to apply group change

# Check Docker installation
docker run hello-world
```

#### Docker Configuration

Considerations for `data-root`:
- Choose a location with sufficient disk space
- Prefer SSD for better performance
- Set consistent data-root path across all nodes if possible

For storage-driver:
- `overlay2` is recommended for most Linux distributions
- `btrfs` can be used if your filesystem supports it
- `devicemapper` may be needed on older systems

## HakuRiver Installation

### Option 1: Install via pip

```bash
# Create a virtual environment (recommended)
python3 -m venv ~/.venv/hakuriver
source ~/.venv/hakuriver/bin/activate

# Install HakuRiver
pip install hakuriver
```

### Option 2: Install from Source

```bash
# Clone repository
git clone https://github.com/KohakuBlueleaf/HakuRiver.git
cd HakuRiver

# Create and activate virtual environment
python3 -m venv .venv
source .venv/bin/activate

# Install
pip install -e .
```

## Host Configuration

### Create Configuration Directory

```bash
# Initialize config
hakuriver.init config
```

This creates a default configuration at `~/.hakuriver/config.toml`.

### Edit Configuration

```bash
vim ~/.hakuriver/config.toml
```

#### Critical Host Configuration Settings

```toml
[network]
# IP that the Host binds to (use 0.0.0.0 to listen on all interfaces)
host_bind_ip = "0.0.0.0"

# Port for the Host API server
host_port = 8000

# Address that other components use to reach this Host
# IMPORTANT: Must be the actual IP or hostname of this machine
host_reachable_address = "192.168.1.100"

[paths]
# Path to shared storage
# This must be accessible by all nodes, but path can differ on each node
shared_dir = "/mnt/hakuriver-shared"

[database]
# Path to the SQLite database file
db_file = "/opt/hakuriver/cluster_management.db"

[docker]
# Relative path to container tarballs (under shared_dir)
container_dir = "hakuriver-containers"

# Default container for tasks
default_container_name = "hakuriver-base"

# Image to use for default container if none exists
initial_base_image = "python:3.12.10-alpine3.21"

# Whether tasks should use privileged containers (use with caution)
tasks_privileged = false

# Additional directory mounts for all containers
# Format: ["host_path:container_path", ...]
additional_mounts = []
```

### Create Directories

Ensure all necessary directories exist:

```bash
# Create database directory
sudo mkdir -p /opt/hakuriver
sudo chown $USER:$USER /opt/hakuriver

# Create shared directory (if it's on the Host machine)
sudo mkdir -p /mnt/hakuriver-shared
sudo chown $USER:$USER /mnt/hakuriver-shared

# Create container and log directories
mkdir -p /mnt/hakuriver-shared/hakuriver-containers
mkdir -p /mnt/hakuriver-shared/task_outputs
mkdir -p /mnt/hakuriver-shared/task_errors
```

## Shared Storage Setup

The Host needs access to shared storage for:
- Container tarballs
- Task output logs
- Input/output data for tasks

See [Shared Storage](shared-storage.md) for detailed setup instructions.

### Verifying Shared Storage

Test that shared storage is working properly:

```bash
# Create a test file
echo "test" > /mnt/hakuriver-shared/test-file.txt

# Verify file exists from another node
ssh runner-node "cat /mnt/hakuriver-shared/test-file.txt"
```

## Starting the Host Server

### Running Manually

For testing or debugging:

```bash
# Start in foreground
hakuriver.host

# Start with specific config
hakuriver.host --config /path/to/custom-config.toml
```

### Running as Systemd Service

For production use:

```bash
# Create systemd service
hakuriver.init service --host

# Start and enable service
sudo systemctl start hakuriver-host.service
sudo systemctl enable hakuriver-host.service

# Check status
sudo systemctl status hakuriver-host.service
```

See [Systemd Integration](systemd-integration.md) for more details.

## Host Management

### Checking Host Status

```bash
# Check service status
sudo systemctl status hakuriver-host.service

# Check logs
sudo journalctl -u hakuriver-host.service

# Check if API is responding
curl http://localhost:8000/health
```

### Default Container Creation

On first startup, the Host creates a default container tarball. Verify its creation:

```bash
ls -la /mnt/hakuriver-shared/hakuriver-containers/
```

## Web Dashboard Setup (Optional)

To enable the web dashboard:

```bash
# Install Node.js and npm
sudo apt install -y nodejs npm

# Navigate to the frontend directory
cd HakuRiver/frontend

# Install dependencies
npm install

# Build production files
npm run build

# Serve with Nginx (example)
sudo apt install -y nginx
sudo cp -r dist/* /var/www/html/
```

Configure Nginx to proxy API requests to the Host server:

```nginx
server {
    listen 80;
    server_name hakuriver.example.com;

    root /var/www/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://localhost:8000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}
```

For more details, see [Web Dashboard Guide](../user-guides/web-dashboard.md).

## Advanced Host Configuration

### TLS/SSL Configuration

For secure connections, set up TLS:

```bash
# Generate self-signed certificate (for testing)
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /opt/hakuriver/server.key -out /opt/hakuriver/server.crt

# Update Nginx configuration for HTTPS
```

### Backup & Recovery

Set up database backups:

```bash
# Create backup script
cat > /opt/hakuriver/backup.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d-%H%M%S)
cp /opt/hakuriver/cluster_management.db /opt/hakuriver/backups/db-$DATE.bak
find /opt/hakuriver/backups/ -name "db-*.bak" -mtime +30 -delete
EOF
chmod +x /opt/hakuriver/backup.sh

# Set up cron job
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/hakuriver/backup.sh") | crontab -
```

### Firewall Configuration

Configure firewall to allow necessary traffic:

```bash
# Ubuntu/Debian with UFW
sudo ufw allow 8000/tcp  # Host API
sudo ufw allow 80/tcp    # Web dashboard (if using)
sudo ufw allow 443/tcp   # HTTPS (if configured)
```

## Troubleshooting

### Common Issues

#### Database Access Problems

```
ERROR: Unable to connect to database: unable to open database file
```

Solution:
- Check database directory exists and is writable
- Verify database path in configuration
- Check disk space

#### Docker Connection Errors

```
ERROR: Cannot connect to Docker daemon
```

Solution:
- Ensure Docker is running: `systemctl status docker`
- Check user is in docker group: `groups $USER`
- Verify Docker socket permissions: `ls -l /var/run/docker.sock`

#### Web Dashboard Connection Issues

```
ERROR: Failed to connect to host API
```

Solution:
- Verify Host is running: `systemctl status hakuriver-host.service`
- Check Host API is accessible: `curl http://localhost:8000/health`
- Verify proxy configuration in web server

## Next Steps

After setting up the Host server:

1. [Set up Runner nodes](runner-setup.md)
2. [Configure shared storage](shared-storage.md)
3. [Set up systemd services](systemd-integration.md)
4. [Implement security measures](security.md)