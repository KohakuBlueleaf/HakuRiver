# Systemd Integration Guide

This guide explains how to integrate HakuRiver components with systemd to ensure reliable operation, automatic startup on boot, and proper service management. Running HakuRiver components as system services is recommended for production environments.

## Introduction to systemd

systemd is the standard service manager for most modern Linux distributions. It provides:

- Automatic service startup on boot
- Dependency management
- Service monitoring and restart
- Logging via journald
- Resource control

HakuRiver provides built-in tools to generate systemd service files for both Host and Runner components.

## Creating Service Files

HakuRiver includes a helper command to create systemd service files:

```bash
hakuriver.init service [--host] [--runner] [--config PATH] [--output-dir DIR]
```

### Options:

- `--host`: Create service file for the Host component
- `--runner`: Create service file for the Runner component 
- `--all`: Create service files for both Host and Runner
- `--config PATH`: Specify a custom configuration file
- `--host-config PATH`: Specify a custom configuration file for the Host
- `--runner-config PATH`: Specify a custom configuration file for the Runner
- `--output-dir DIR`: Directory to write service files (default: current directory)

## Setting Up the Host Service

### Creating the Host Service File

```bash
# Generate service file
hakuriver.init service --host

# Review the created file
cat hakuriver-host.service

# Install service file
sudo cp hakuriver-host.service /etc/systemd/system/
sudo systemctl daemon-reload
```

### Host Service Content

The generated service file contains:

```ini
[Unit]
Description=HakuRiver Host Server
After=network.target

[Service]
Type=simple
User=<current_user>
Group=<current_user>
WorkingDirectory=<shared_dir>
ExecStart=<python_path> -m hakuriver.cli.host --config <config_path>
Restart=on-failure
RestartSec=5
Environment="PATH=<env_path>"

[Install]
WantedBy=multi-user.target
```

### Customizing the Host Service

You may want to modify the service file for your specific environment:

```bash
sudo systemctl edit hakuriver-host.service
```

Common customizations include:

- Adding dependencies (`After=docker.service`)
- Configuring resource limits
- Setting environment variables
- Adjusting restart policy

For example:

```ini
[Service]
# Resource limits
CPUQuota=200%
MemoryMax=4G

# Additional environment variables
Environment="PYTHONUNBUFFERED=1"

# More aggressive restart
Restart=always
RestartSec=10
```

## Setting Up Runner Services

### Creating the Runner Service File

```bash
# Generate service file
hakuriver.init service --runner

# Review the created file
cat hakuriver-runner.service

# Install service file
sudo cp hakuriver-runner.service /etc/systemd/system/
sudo systemctl daemon-reload
```

### Runner Service Content

The generated service file contains:

```ini
[Unit]
Description=HakuRiver Runner Agent
After=network.target

[Service]
Type=simple
User=<current_user>
Group=<current_user>
WorkingDirectory=<shared_dir>
ExecStart=<python_path> -m hakuriver.cli.runner --config <config_path>
Restart=on-failure
RestartSec=5
Environment="PATH=<env_path>"

[Install]
WantedBy=multi-user.target
```

### Customizing the Runner Service

Common customizations for the Runner service:

```bash
sudo systemctl edit hakuriver-runner.service
```

Example additions:

```ini
[Unit]
# Add dependencies
After=network.target docker.service
Requires=docker.service

[Service]
# Resource limits
CPUQuota=800%
MemoryMax=16G

# Environment variables
Environment="PYTHONUNBUFFERED=1"

# Increase timeout for potentially slow operations
TimeoutStartSec=120
TimeoutStopSec=120
```

## Managing Services

### Starting and Enabling Services

To start services immediately and enable them to start on boot:

```bash
# Host service
sudo systemctl start hakuriver-host.service
sudo systemctl enable hakuriver-host.service

# Runner service
sudo systemctl start hakuriver-runner.service
sudo systemctl enable hakuriver-runner.service
```

### Checking Service Status

```bash
# Check host status
sudo systemctl status hakuriver-host.service

# Check runner status
sudo systemctl status hakuriver-runner.service
```

### Restarting Services

```bash
# Restart host
sudo systemctl restart hakuriver-host.service

# Restart runner
sudo systemctl restart hakuriver-runner.service
```

### Stopping Services

```bash
# Stop host
sudo systemctl stop hakuriver-host.service

# Stop runner
sudo systemctl stop hakuriver-runner.service
```

## Viewing Logs

systemd logs service output to the journal:

```bash
# View host logs
sudo journalctl -u hakuriver-host.service

# View runner logs
sudo journalctl -u hakuriver-runner.service

# Follow logs in real-time
sudo journalctl -u hakuriver-runner.service -f

# Show logs since the last service start
sudo journalctl -u hakuriver-host.service --since "service hakuriver-host start"

# Show logs from the last hour
sudo journalctl -u hakuriver-host.service --since "1 hour ago"
```

## Multiple Runner Instances

For running multiple Runner instances on the same node:

```bash
# Create separate config files
cp ~/.hakuriver/config.toml ~/.hakuriver/runner1.toml
cp ~/.hakuriver/config.toml ~/.hakuriver/runner2.toml

# Edit ports and other settings in each config
vim ~/.hakuriver/runner1.toml  # Set runner_port = 8001
vim ~/.hakuriver/runner2.toml  # Set runner_port = 8002

# Create separate service files
hakuriver.init service --runner --config ~/.hakuriver/runner1.toml --output-dir .
mv hakuriver-runner.service hakuriver-runner1.service

hakuriver.init service --runner --config ~/.hakuriver/runner2.toml --output-dir .
mv hakuriver-runner.service hakuriver-runner2.service

# Install both services
sudo cp hakuriver-runner1.service hakuriver-runner2.service /etc/systemd/system/
sudo systemctl daemon-reload

# Start and enable both services
sudo systemctl enable --now hakuriver-runner1.service hakuriver-runner2.service
```

## Service Dependencies

### Runner Requiring Docker

Ensure the Runner service waits for Docker to be available:

```ini
[Unit]
Description=HakuRiver Runner Agent
After=network.target docker.service
Requires=docker.service
```

## Systemd Socket Activation

For advanced setups, you can use socket activation to start services on demand:

```ini
# hakuriver-host.socket
[Unit]
Description=HakuRiver Host Socket

[Socket]
ListenStream=8000
Accept=no

[Install]
WantedBy=sockets.target
```

```ini
# hakuriver-host.service
[Unit]
Description=HakuRiver Host Server
Requires=hakuriver-host.socket

[Service]
Type=notify
ExecStart=<python_path> -m hakuriver.cli.host --config <config_path>
...
```

## Task Execution with systemd

HakuRiver Runners use systemd to execute tasks when `--container NULL` is specified:

```bash
hakuriver.client --target node1 --container NULL -- command arg1 arg2
```

The Runner creates a transient scope unit using `systemd-run --scope`:

```bash
systemd-run --scope --property=User=<runner_user> --unit=hakuriver-task-<id> \
  --description=HakuRiver Task <id> --property=CPUQuota=<quota> \
  --property=MemoryMax=<limit> -- command arg1 arg2
```

### Configuring systemd Task Execution

For the systemd fallback execution mode to work correctly:

1. Ensure the Runner user has sudo access to systemd-run:
   ```bash
   # Add to /etc/sudoers via visudo
   runner_user ALL=(ALL) NOPASSWD: /usr/bin/systemd-run, /usr/bin/systemctl
   ```

2. Verify systemd-run is available:
   ```bash
   which systemd-run
   ```

3. Test systemd-run directly:
   ```bash
   sudo systemd-run --scope --unit=test-unit -- echo "test"
   systemctl status test-unit.scope
   ```

## Troubleshooting

### Permission Issues

```
Failed to start hakuriver-host.service: Access denied
```

Solution:
- Check that the service file specifies the correct user
- Verify WorkingDirectory permissions
- Check Python executable permissions

### Configuration Path Issues

```
Configuration file not found
```

Solution:
- Use absolute paths for config files
- Verify the config file exists and is readable
- Check WorkingDirectory in the service file

### Dependency Failures

```
Failed to start hakuriver-runner.service: Unit docker.service not found
```

Solution:
- Correct the dependency name
- Use `Wants=` instead of `Requires=` for optional dependencies
- Verify the required service exists and is enabled

## Best Practices

1. **Use Environment Files**: For sensitive variables, use environment files:
   ```ini
   [Service]
   EnvironmentFile=/etc/hakuriver/env
   ```

2. **Set Resource Limits**: Always define appropriate resource limits to prevent services from consuming all resources.

3. **Enable Service Accounting**: For better monitoring:
   ```bash
   sudo systemctl set-property hakuriver-host.service CPUAccounting=true MemoryAccounting=true
   ```

4. **Implement Service Notifications**: For important services, implement email notifications on failure:
   ```ini
   [Service]
   OnFailure=email-admin@%n.service
   ```

5. **Regular Log Review**: Set up regular review of journald logs to catch issues early.

6. **Service Hardening**: Improve security by adding restrictions:
   ```ini
   [Service]
   ProtectSystem=strict
   ProtectHome=read-only
   PrivateTmp=true
   NoNewPrivileges=true
   ```

## Next Steps

After setting up HakuRiver with systemd:

1. Consider [security measures](security.md) for your deployment
2. Set up monitoring for systemd services 
3. Configure log rotation for journal logs