# Troubleshooting Guide

Common issues and solutions for KohakuRiver.

---

## Connection Issues

### Runner Not Registering

| Symptom | Cause | Solution |
|---------|-------|----------|
| Runner not in `node list` | Wrong HOST_ADDRESS | Check runner config `HOST_ADDRESS` |
| Connection refused | Host not running | Start Host: `systemctl start kohakuriver-host` |
| Network error | Firewall | Open port 8000 for runners |

**Debug:**
```bash
# On runner: test connectivity
curl http://<host_ip>:8000/health

# Check runner logs
journalctl -u kohakuriver-runner -f
```

### Runner Shows Offline

| Symptom | Cause | Solution |
|---------|-------|----------|
| Status: offline | Runner crashed | Restart runner service |
| Heartbeat timeout | Network issues | Check connectivity |
| Last heartbeat old | Runner stopped | Start runner service |

---

## Task Issues

### Task Stuck in Pending

| Cause | Solution |
|-------|----------|
| No target specified | Add `-t <node>` |
| Target node offline | Check `node list` |
| Invalid target | Verify node name |

### Task Failed Immediately

| Cause | Solution |
|-------|----------|
| Container not found | Check container exists: `docker tar list` |
| Invalid command | Verify command syntax |
| Resource issue | Check disk space |

**Debug:**
```bash
kohakuriver task status <task_id>
kohakuriver task logs <task_id>
journalctl -u kohakuriver-runner -f
```

### Task Output Empty

| Cause | Solution |
|-------|----------|
| Script errors to stderr | Check `task logs` for stderr |
| Buffering | Add `flush=True` in Python |
| Quick exit | Script may have failed early |

---

## VPS Issues

### Cannot Connect to VPS

| Symptom | Cause | Solution |
|---------|-------|----------|
| Connection refused | VPS not running | Check `vps status <id>` |
| Permission denied | Wrong SSH key | Verify key matches creation |
| Timeout | Proxy issue | Check Host SSH proxy logs |

**Debug:**
```bash
# Check VPS status
kohakuriver vps status <task_id>

# Check SSH port
kohakuriver vps list

# Check Host logs for proxy errors
journalctl -u kohakuriver-host | grep ssh
```

### VPS Fails to Start

| Cause | Solution |
|-------|----------|
| No SSH in container | [Prepare container for VPS](../3.%20user-guides/3.%20vps-tasks/3.%20container-prep.md) |
| Port conflict | Runner will retry with different port |
| Docker error | Check runner logs |

---

## Docker Issues

### Container Sync Failed

| Cause | Solution |
|-------|----------|
| Tarball not found | Run `docker tar create <name>` |
| Shared storage issue | Verify `SHARED_DIR` accessible |
| Timeout | Increase `DOCKER_IMAGE_SYNC_TIMEOUT` |

### Cannot Create Container

| Cause | Solution |
|-------|----------|
| Image not found | Verify image name exists |
| Docker not running | Start Docker: `systemctl start docker` |
| Permission denied | Add user to docker group |

**Debug:**
```bash
# Test Docker on Host
docker pull python:3.12-alpine
docker images

# Check Host logs
journalctl -u kohakuriver-host | grep docker
```

---

## GPU Issues

### GPU Not Detected

| Cause | Solution |
|-------|----------|
| nvidia-ml-py not installed | `pip install nvidia-ml-py` |
| NVIDIA driver issue | Check `nvidia-smi` works |
| Runner not restarted | Restart runner after GPU setup |

### GPU Task Fails

| Cause | Solution |
|-------|----------|
| Invalid GPU ID | Check available GPUs in `node list` |
| Container missing CUDA | Use CUDA-enabled container |
| Driver mismatch | Match CUDA version to driver |

**Debug:**
```bash
# Test GPU visibility
kohakuriver task submit "nvidia-smi" -t node1::0 --container cuda-env

# Check CUDA
kohakuriver task submit "python -c 'import torch; print(torch.cuda.is_available())'" \
  -t node1::0 --container cuda-env
```

---

## Network/Permission Issues

### Firewall Configuration

| Port | Service | Required By |
|------|---------|-------------|
| 8000 | Host API | Runners, Clients |
| 8001 | Runner API | Host only |
| 8002 | SSH Proxy | Clients |

```bash
# UFW examples
sudo ufw allow 8000/tcp    # Host API
sudo ufw allow 8002/tcp    # SSH Proxy
```

### Permission Errors

| Error | Solution |
|-------|----------|
| Docker permission denied | Add user to docker group |
| Shared storage denied | Check mount permissions |
| Database error | Ensure `/var/lib/kohakuriver` writable |

---

## Log Locations

| Component | Location |
|-----------|----------|
| Host service | `journalctl -u kohakuriver-host` |
| Runner service | `journalctl -u kohakuriver-runner` |
| Task stdout | `<shared_dir>/task_outputs/<task_id>.out` |
| Task stderr | `<shared_dir>/task_errors/<task_id>.err` |

---

## Quick Diagnostic Commands

```bash
# Cluster overview
kohakuriver status

# Node status
kohakuriver node list

# Task details
kohakuriver task status <id>
kohakuriver task logs <id>

# VPS status
kohakuriver vps status <id>

# Host health
curl http://localhost:8000/health

# Runner health
curl http://localhost:8001/health
```

---

## Common Error Messages

| Error | Meaning | Fix |
|-------|---------|-----|
| `Connection refused` | Service not running | Start the service |
| `Task not found` | Invalid task ID | Check `task list` |
| `Node offline` | Runner not connected | Check runner service |
| `Container not found` | Missing tarball | Create tarball |
| `Permission denied` | Auth/access issue | Check permissions |
