# Monitoring Tasks and Nodes

Effective monitoring is essential for managing your HakuRiver cluster. This guide explains how to monitor nodes, track tasks, and troubleshoot issues using both command-line tools and the web dashboard.

## Command-Line Monitoring

HakuRiver provides several commands to monitor your cluster from the command line.

### Node Monitoring

#### Listing Nodes

To see all registered nodes and their status:

```bash
hakuriver.client --list-nodes
```

This command shows:
- Hostname
- Status (online/offline)
- Total cores
- Available cores
- NUMA node count (if applicable)
- Last heartbeat time

#### Detailed Node Health

For more detailed information about a specific node or all nodes:

```bash
# Check all nodes
hakuriver.client --health

# Check a specific node
hakuriver.client --health node1
```

This provides:
- CPU usage percentage
- Memory usage (percentage and absolute)
- NUMA topology details
- Task allocation status
- Heartbeat timing information

### Task Monitoring

#### Checking Task Status

To check the status of a specific task:

```bash
hakuriver.client --status <task_id>
```

This shows:
- Command and arguments
- Current status (pending, running, completed, failed, etc.)
- Assigned node
- CPU/memory allocation
- Submission, start, and completion times
- Exit code (if completed)
- Error message (if failed)

#### Task Listing

To list all recent tasks:

```bash
hakuriver.client --list-tasks
```

#### Viewing Task Output

To view the standard output or error of a task:

```bash
# View standard output
hakuriver.client --stdout <task_id>

# View standard error
hakuriver.client --stderr <task_id>
```

You can also directly examine the log files in the shared directory:
- Standard output: `<shared_dir>/task_outputs/<task_id>.out`
- Standard error: `<shared_dir>/task_errors/<task_id>.err`

## Web Dashboard Monitoring

The HakuRiver web dashboard provides a visual interface for monitoring.

### Dashboard Overview

The main dashboard page shows:
- Cluster-wide resource usage (CPU, memory)
- Online and offline node counts
- Running, pending, completed, and failed task counts
- Resource usage graphs over time

### Node Monitoring

The Nodes page offers:
- Visual status indicators for each node
- Real-time CPU and memory usage
- NUMA topology visualization
- Resource allocation tracking
- Task assignment view

#### Node Detail View

Click on any node to see:
- Detailed resource allocation
- Running tasks on the node
- Per-NUMA node resource breakdown
- System information

### Task Monitoring

The Tasks page provides:
- Searchable task list
- Status filtering (running, completed, failed, etc.)
- Detailed task information
- Output and error log viewing
- Task action buttons (kill, pause, resume)

#### Task Detail View

Select any task to see:
- Complete command and arguments
- Resource allocation details
- Live output/error log view with auto-refresh
- Execution metrics (start time, duration, etc.)
- Error information (if applicable)

## Logs and Debugging

### System Logs

HakuRiver components write logs that can be accessed for debugging:

#### Host Logs

If running from systemd:
```bash
journalctl -u hakuriver-host.service
```

Or check the log file specified in your configuration.

#### Runner Logs

If running from systemd:
```bash
journalctl -u hakuriver-runner.service
```

Or check the log file specified in your configuration.

### Task Logs

All task execution logs are stored in the shared directory:
- Standard output: `<shared_dir>/task_outputs/<task_id>.out`
- Standard error: `<shared_dir>/task_errors/<task_id>.err`

## Resource Monitoring

### CPU Monitoring

Track CPU utilization across your cluster:

```bash
hakuriver.client --health | grep CPU
```

The web dashboard provides CPU utilization graphs for the entire cluster and individual nodes.

### Memory Monitoring

Monitor memory usage:

```bash
hakuriver.client --health | grep Memory
```

The web dashboard shows memory utilization over time and current usage.

### Disk Space Monitoring

Monitor the shared directory space:

```bash
df -h <shared_dir>
```

If using the web dashboard, you may want to add disk space monitoring as a custom extension.

## Alert Setup (External)

HakuRiver doesn't include a built-in alerting system, but you can set up external monitoring:

### Simple Shell Script Alert

```bash
#!/bin/bash
# Check if any nodes are offline
OFFLINE_NODES=$(hakuriver.client --list-nodes | grep offline | wc -l)
if [ $OFFLINE_NODES -gt 0 ]; then
  echo "Alert: $OFFLINE_NODES nodes are offline!" | mail -s "HakuRiver Alert" admin@example.com
fi
```

### Integration with Monitoring Systems

For more comprehensive monitoring, integrate with systems like:
- Prometheus + Grafana
- Nagios
- Zabbix

You can create exporters that fetch data from the HakuRiver API.

## Monitoring Best Practices

### Regular Status Checks

Set up a cron job to check cluster health regularly:

```
# Check cluster health every 15 minutes
*/15 * * * * hakuriver.client --health > /var/log/hakuriver_health.log
```

### Resource Thresholds

Define thresholds for when to add or remove nodes:
- High CPU usage (>80%) for extended periods
- High memory usage (>85%)
- Many pending tasks

### Log Rotation

Set up log rotation for HakuRiver logs:

```
# Example logrotate config
/var/log/hakuriver*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
}
```

### Dashboard Monitoring Wall

For larger installations, consider setting up a monitoring wall display:
- Always-on screen showing the web dashboard
- Visual indicators for cluster status
- Email alerts for critical issues

## Troubleshooting Common Issues

### Node Connection Issues

If a node shows as offline:

1. Check network connectivity:
   ```bash
   ping <node-hostname>
   ```

2. Verify the Runner is running:
   ```bash
   ssh <node-hostname>
   systemctl status hakuriver-runner.service
   ```

3. Check Runner logs for errors:
   ```bash
   journalctl -u hakuriver-runner.service
   ```

### Task Failures

For failed tasks:

1. Check the task error message:
   ```bash
   hakuriver.client --status <task_id>
   ```

2. Examine the stderr log:
   ```bash
   hakuriver.client --stderr <task_id>
   ```

3. Verify container environment:
   ```bash
   hakuriver.docker list-tars | grep <container-name>
   ```

### Resource Exhaustion

If nodes are overloaded:

1. Check current resource usage:
   ```bash
   hakuriver.client --health
   ```

2. Identify resource-intensive tasks:
   ```bash
   hakuriver.client --list-tasks | grep running
   ```

3. Consider killing or rescheduling tasks:
   ```bash
   hakuriver.client --kill <task_id>
   ```

### Docker Issues

If tasks fail due to Docker problems:

1. Check Docker service status on the Runner:
   ```bash
   systemctl status docker
   ```

2. Verify image synchronization:
   ```bash
   ssh <node-hostname>
   docker images | grep hakuriver
   ```

3. Check for available disk space:
   ```bash
   df -h /var/lib/docker
   ```

## Monitoring Script Examples

### Node Health Check Script

```bash
#!/bin/bash
# node_health_check.sh
# Monitors node health and sends alerts if issues are detected

# Get node health
HEALTH_OUTPUT=$(hakuriver.client --health)

# Check for offline nodes
OFFLINE_NODES=$(echo "$HEALTH_OUTPUT" | grep -c "status.*offline")
if [ $OFFLINE_NODES -gt 0 ]; then
  echo "Alert: $OFFLINE_NODES nodes are offline!" 
  # Add notification command here (email, Slack, etc.)
fi

# Check for high CPU usage
HIGH_CPU=$(echo "$HEALTH_OUTPUT" | awk '/cpu_percent/ && $2 > 90 {print $0}')
if [ ! -z "$HIGH_CPU" ]; then
  echo "Alert: High CPU usage detected!"
  echo "$HIGH_CPU"
  # Add notification command here
fi

# Check for high memory usage
HIGH_MEM=$(echo "$HEALTH_OUTPUT" | awk '/memory_percent/ && $2 > 90 {print $0}')
if [ ! -z "$HIGH_MEM" ]; then
  echo "Alert: High memory usage detected!"
  echo "$HIGH_MEM"
  # Add notification command here
fi
```

### Task Monitoring Script

```bash
#!/bin/bash
# task_monitor.sh
# Monitors for failed tasks and long-running tasks

# Get task list
TASKS_OUTPUT=$(hakuriver.client --list-tasks)

# Check for failed tasks
FAILED_TASKS=$(echo "$TASKS_OUTPUT" | grep -c "failed")
if [ $FAILED_TASKS -gt 0 ]; then
  echo "Alert: $FAILED_TASKS tasks have failed!"
  # Add notification command here
fi

# Check for tasks running longer than expected (24h)
LONG_TASKS=$(hakuriver.client --list-tasks | grep "running" | awk '{if ($8 - $7 > 86400) print $0}')
if [ ! -z "$LONG_TASKS" ]; then
  echo "Alert: Some tasks have been running for more than 24 hours!"
  echo "$LONG_TASKS"
  # Add notification command here
fi
```

## Next Steps

- Learn more about [task submission](task-submission.md)
- Understand [container workflow](container-workflow.md)
- Explore [web dashboard](web-dashboard.md) features