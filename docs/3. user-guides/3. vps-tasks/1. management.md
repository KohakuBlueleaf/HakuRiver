# VPS Task Management Guide

VPS tasks launch persistent, interactive Docker containers with SSH access - like on-demand virtual private servers on your cluster nodes.

---

## Overview

### What is a VPS Task?

A VPS task is a running Docker container configured for SSH access:

| Characteristic | Description |
|----------------|-------------|
| **Persistent** | Runs until explicitly stopped |
| **Interactive** | Access via SSH |
| **Key-based auth** | Uses SSH public keys |
| **Dynamic ports** | SSH port assigned automatically |

---

## CLI Commands

```bash
kohakuriver vps list              # List VPS instances
kohakuriver vps status <id>       # Detailed status
kohakuriver vps create            # Create new VPS
kohakuriver vps connect <id>      # SSH connect to VPS
kohakuriver vps stop <id>         # Stop VPS
kohakuriver vps restart <id>      # Restart VPS
kohakuriver vps pause <id>        # Pause VPS
kohakuriver vps resume <id>       # Resume paused VPS
```

---

## Creating a VPS

### Basic Usage

```bash
kohakuriver vps create [OPTIONS]
```

### SSH Key Options

| Option | Description |
|--------|-------------|
| (default) | Use `~/.ssh/id_ed25519.pub` or `~/.ssh/id_rsa.pub` |
| `--public-key-file PATH` | Use specific public key file |
| `--public-key-string KEY` | Provide key as string |
| `--gen-ssh-key` | Generate new keypair |
| `--no-ssh-key` | Passwordless root login |

### Resource Options

| Option | Short | Description |
|--------|-------|-------------|
| `--target` | `-t` | Target node[:numa][::gpus] |
| `--cores` | `-c` | CPU cores (default: 1) |
| `--memory` | `-m` | Memory limit (e.g., 4G) |
| `--container` | | Container environment name |
| `--privileged` | | Run with Docker --privileged |
| `--mount` | | Additional mounts (repeatable) |

### Examples

**Basic VPS with auto-select:**

```bash
kohakuriver vps create --cores 2 --memory 4G
```

Uses default SSH key and lets Host select a suitable node.

**Target specific node:**

```bash
kohakuriver vps create -t nodeA --cores 4 --container my-dev-env
```

**GPU VPS:**

```bash
kohakuriver vps create -t nodeC::0,1 --cores 8 --memory 16G --container my-cuda-vps
```

**Generate new SSH key:**

```bash
kohakuriver vps create --gen-ssh-key --key-out-file ~/.ssh/vps_key
```

Generates a new keypair and saves it to the specified path.

---

## Connecting to VPS

### Using kohakuriver vps connect

```bash
kohakuriver vps connect <task_id>
```

This automatically:
1. Looks up VPS connection info
2. Connects through the SSH proxy
3. Uses the appropriate SSH key

### With Custom Key

```bash
kohakuriver vps connect <task_id> --key ~/.ssh/custom_key
```

### Manual SSH

You can also connect manually if you know the node and port:

```bash
ssh -p <port> root@<runner_node>
```

---

## Listing VPS Instances

### Active VPS Only

```bash
kohakuriver vps list
```

Shows: Task ID, Status, Node, Resources, SSH Port

### Include Stopped

```bash
kohakuriver vps list --all
```

---

## Managing VPS Lifecycle

### Check Status

```bash
kohakuriver vps status <task_id>
```

Shows detailed information including:
- Container name
- Assigned node
- SSH port
- Resources allocated
- Timestamps

### Stop VPS

```bash
kohakuriver vps stop <task_id>
```

Terminates the VPS container.

### Restart VPS

```bash
kohakuriver vps restart <task_id>
```

Useful when:
- NVIDIA docker breaks (nvml error)
- Container becomes unresponsive
- Need to apply configuration changes

### Pause/Resume

```bash
kohakuriver vps pause <task_id>
kohakuriver vps resume <task_id>
```

Pausing suspends the container without stopping it.

---

## SSH Key Management

### Default Keys

KohakuRiver checks these locations automatically:
1. `~/.ssh/id_ed25519.pub`
2. `~/.ssh/id_rsa.pub`

### Generated Keys

When using `--gen-ssh-key`:

```bash
kohakuriver vps create --gen-ssh-key
```

Keys are saved to:
- Private: `~/.ssh/kohakuriver_vps_<task_id>`
- Public: `~/.ssh/kohakuriver_vps_<task_id>.pub`

Custom output path:

```bash
kohakuriver vps create --gen-ssh-key --key-out-file ~/.ssh/my_vps
```

---

## VPS Lifecycle States

```
┌─────────┐    ┌───────────┐    ┌─────────┐
│ PENDING │───▶│ ASSIGNING │───▶│ RUNNING │
└─────────┘    └───────────┘    └─────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    ▼                ▼                ▼
               ┌─────────┐    ┌─────────┐    ┌─────────┐
               │ PAUSED  │    │ STOPPED │    │  LOST   │
               └─────────┘    └─────────┘    └─────────┘
```

| Status | Description |
|--------|-------------|
| `pending` | Waiting to be assigned |
| `assigning` | Being assigned to Runner |
| `running` | Active and accessible via SSH |
| `paused` | Container paused |
| `stopped` | Terminated by user |
| `lost` | Runner lost contact |

---

## Best Practices

| Practice | Description |
|----------|-------------|
| **Use dedicated keys** | Generate keys per VPS for security |
| **Set resource limits** | Always specify `--cores` and `--memory` |
| **Stop when done** | Free resources for other users |
| **Use prepared images** | Ensure container has SSH server |

---

## Next Steps

1. [SSH access details](2.%20ssh-access.md)
2. [Container preparation for VPS](3.%20container-prep.md)
3. [Common use cases](4.%20common-use-cases.md)
