# Preparing Containers for VPS Tasks

VPS containers need SSH server installed and configured. This guide shows how to prepare images using the KohakuRiver container workflow.

---

## Requirements

For a container to work as VPS:

| Requirement | Description |
|-------------|-------------|
| SSH server | `openssh-server` or equivalent |
| Public key auth | Enabled in sshd_config |
| Root login | Allowed (or configure user) |
| SSH daemon start | Mechanism to start sshd |

---

## Quick Setup

### Step 1: Create Container

```bash
kohakuriver docker container create ubuntu:22.04 my-vps-base
```

### Step 2: Install SSH Server

```bash
kohakuriver docker container shell my-vps-base
```

Inside container:

```bash
apt-get update
apt-get install -y openssh-server nano
mkdir -p /run/sshd

# Optional: generate host keys
ssh-keygen -A

exit
```

### Step 3: Configure SSH

Get shell again:

```bash
kohakuriver docker container shell my-vps-base
```

Edit `/etc/ssh/sshd_config`:

```bash
nano /etc/ssh/sshd_config
```

Ensure these settings:

```
PubkeyAuthentication yes
PermitRootLogin yes
PasswordAuthentication no
```

Exit container.

### Step 4: Package

```bash
kohakuriver docker tar create my-vps-base
```

---

## Distribution-Specific Commands

### Ubuntu/Debian

```bash
apt-get update
apt-get install -y openssh-server
mkdir -p /run/sshd
```

### Alpine

```bash
apk update
apk add --no-cache openssh
ssh-keygen -A
```

### CentOS/RHEL

```bash
yum install -y openssh-server
ssh-keygen -A
```

---

## Complete Example: Development VPS

```bash
# 1. Create from Python base
kohakuriver docker container create python:3.11-slim py-dev-vps

# 2. Install everything
kohakuriver docker container shell py-dev-vps
```

Inside container:

```bash
# Update and install
apt-get update
apt-get install -y \
    openssh-server \
    git \
    vim \
    htop \
    curl \
    build-essential

# Setup SSH
mkdir -p /run/sshd
ssh-keygen -A

# Configure SSH
sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# Install Python packages
pip install ipython numpy pandas matplotlib

# Cleanup
apt-get clean
rm -rf /var/lib/apt/lists/*

exit
```

Package:

```bash
kohakuriver docker tar create py-dev-vps
```

Use:

```bash
kohakuriver vps create -t node1 --container py-dev-vps --cores 2 --memory 4G
```

---

## GPU VPS Setup

For GPU-enabled VPS:

```bash
# Use CUDA base image
kohakuriver docker container create nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04 cuda-vps

# Install SSH + CUDA tools
kohakuriver docker container shell cuda-vps
```

Inside:

```bash
apt-get update
apt-get install -y openssh-server
mkdir -p /run/sshd
ssh-keygen -A

# Configure SSH
sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# Install ML tools
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118

apt-get clean
exit
```

Package and use with GPU target:

```bash
kohakuriver docker tar create cuda-vps
kohakuriver vps create -t node1::0,1 --container cuda-vps --cores 8 --memory 16G
```

---

## SSH Configuration Reference

### Minimal sshd_config Changes

```bash
# Allow root login with key
PermitRootLogin yes

# Enable key authentication
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys

# Disable password (security)
PasswordAuthentication no
PermitEmptyPasswords no
```

### Apply Changes

If sshd_config already exists, use sed:

```bash
sed -i 's/#PermitRootLogin .*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/#PubkeyAuthentication .*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
sed -i 's/#PasswordAuthentication .*/PasswordAuthentication no/' /etc/ssh/sshd_config
```

---

## Considerations

### Root vs Non-Root User

KohakuRiver injects keys into `/root/.ssh/authorized_keys` by default.

For non-root access:
1. Create user in container
2. Set up user's .ssh directory
3. Configure `PermitRootLogin no` if desired
4. Modify VPS startup to use different user

### Container Entrypoint

KohakuRiver replaces the container's CMD/ENTRYPOINT to:
1. Inject SSH keys
2. Start sshd

Ensure your base image doesn't have conflicting startup scripts.

### Driver Compatibility

For GPU VPS, ensure CUDA libraries in container are compatible with Runner's NVIDIA driver version.

---

## Verification Checklist

Before packaging:

- [ ] SSH server installed
- [ ] `/run/sshd` directory exists
- [ ] Host keys generated (`ssh-keygen -A`)
- [ ] `PermitRootLogin yes` in sshd_config
- [ ] `PubkeyAuthentication yes` in sshd_config
- [ ] `PasswordAuthentication no` in sshd_config
- [ ] Package caches cleaned

---

## Next Steps

1. [VPS management](1.%20management.md)
2. [SSH access](2.%20ssh-access.md)
3. [Common use cases](4.%20common-use-cases.md)
