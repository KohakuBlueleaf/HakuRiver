# HakuRiver - å…±äº«å®¹å™¨å¢é›†

| [English](./README.md) | [ä¸­æ–‡ (ä½ åœ¨é€™è£¡)](./README.zh.md) |
| :------ | :--- |

[![æˆæ¬Š](https://img.shields.io/badge/License-Apache_2.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

![HakuRiver logo svg](image/logo.svg)

**HakuRiver** æ˜¯ä¸€å€‹è¼•é‡ç´šã€è‡ªè¨—ç®¡çš„å¢é›†ç®¡ç†ç³»çµ±ï¼Œå°ˆç‚ºåœ¨è¨ˆç®—ç¯€é»é–“åˆ†é…å‘½ä»¤åˆ—ä»»å‹™è€Œè¨­è¨ˆã€‚å®ƒä¸»è¦åˆ©ç”¨ **Docker** ä¾†ç®¡ç†å¯é‡ç¾çš„ä»»å‹™ç’°å¢ƒï¼Œè®“ä½¿ç”¨è€…èƒ½å°‡å®¹å™¨è¦–ç‚ºä¾¿æ”œå¼ã€Œè™›æ“¬ç’°å¢ƒã€ã€‚HakuRiver å”èª¿é€™äº›å®¹å™¨åŒ–ç’°å¢ƒçš„å»ºç«‹ã€æ‰“åŒ…ï¼ˆé€é tarballï¼‰ã€åˆ†ç™¼å’Œåœ¨ç¯€é»é–“çš„åŸ·è¡Œã€‚

å®ƒæä¾›è³‡æºåˆ†é…ï¼ˆCPU/è¨˜æ†¶é«”/GPU é™åˆ¶ï¼‰ã€å¤šç¯€é»/NUMA/GPU ä»»å‹™æäº¤å’Œç‹€æ…‹è¿½è¹¤åŠŸèƒ½ï¼Œéå¸¸é©åˆç ”ç©¶å¯¦é©—å®¤ã€ä¸­å°å‹åœ˜éšŠã€å®¶åº­å¯¦é©—å®¤æˆ–é–‹ç™¼ç’°å¢ƒï¼Œé€™äº›ç’°å¢ƒéœ€è¦ç°¡å–®ã€å¯é‡ç¾çš„åˆ†æ•£å¼ä»»å‹™åŸ·è¡Œï¼Œè€Œä¸éœ€æ‰¿æ“”è¤‡é›œ HPC æ’ç¨‹å™¨çš„é¡å¤–è² æ“”ã€‚

## HakuRiver ç°¡ä»‹

### å•é¡ŒèƒŒæ™¯

ç ”ç©¶äººå“¡å’Œå°å‹åœ˜éšŠåœ¨ä½¿ç”¨å°‘é‡è¨ˆç®—ç¯€é»ï¼ˆé€šå¸¸ 3-8 å°æ©Ÿå™¨ï¼‰æ™‚ï¼Œç¶“å¸¸é¢è‡¨å°·å°¬çš„ä¸­é–“åœ°å¸¶ï¼š

- **æ©Ÿå™¨å¤ªå¤š**ï¼Œç„¡æ³•æœ‰æ•ˆåœ°é€é SSH å’Œ Shell è…³æœ¬æ‰‹å‹•ç®¡ç†
- **æ©Ÿå™¨å¤ªå°‘**ï¼Œé›£ä»¥æ¥å—éƒ¨ç½²è¤‡é›œ HPC æ’ç¨‹å™¨ï¼ˆå¦‚ Slurmï¼‰çš„é¡å¤–é–‹éŠ·
- **å®¹å™¨ç·¨æ’ç³»çµ±**ï¼ˆå¦‚ Kubernetesï¼‰å°æ–¼ç°¡å–®çš„ä»»å‹™åˆ†ç™¼è€Œè¨€**éæ–¼è¤‡é›œ**

æ‚¨æ“æœ‰é€™äº›å¼·å¤§çš„è¨ˆç®—è³‡æºï¼Œå»æ²’æœ‰é«˜æ•ˆæ–¹æ³•åœ¨ä¸å¢åŠ å¤§é‡é‹ç¶­é–‹éŠ·çš„æƒ…æ³ä¸‹ï¼Œå°‡å®ƒå€‘ä½œç‚ºçµ±ä¸€çš„è¨ˆç®—è³‡æºä½¿ç”¨ã€‚

### æ ¸å¿ƒæ¦‚å¿µï¼šå°‡ç¯€é»è¦–ç‚ºä¸€å°å¤§å‹é›»è…¦

HakuRiver é€éä»¥ä¸‹é—œéµè¨­è¨ˆåŸå‰‡ï¼Œè®“æ‚¨å°‡å°å‹å¢é›†è¦–ç‚ºå–®ä¸€å¼·å¤§é›»è…¦ï¼š

- **è¼•é‡ç´šè³‡æºç®¡ç†**ï¼šä»¥æœ€å°‘çš„è¨­ç½®åœ¨ç¯€é»é–“åˆ†ç™¼å‘½ä»¤åˆ—ä»»å‹™
- **ç’°å¢ƒä¸€è‡´æ€§**ï¼šä½¿ç”¨ Docker å®¹å™¨ä½œç‚ºå¯æ”œå¼è™›æ“¬ç’°å¢ƒï¼Œè€Œéè¤‡é›œçš„æ‡‰ç”¨ç¨‹å¼éƒ¨ç½²
- **ç„¡ç¸«åŒæ­¥**ï¼šè‡ªå‹•å°‡å®¹å™¨ç’°å¢ƒåˆ†ç™¼åˆ°åŸ·è¡Œç¯€é»ï¼Œç„¡éœ€åœ¨æ¯å€‹ç¯€é»ä¸Šæ‰‹å‹•è¨­ç½®
- **ç†Ÿæ‚‰çš„å·¥ä½œæµç¨‹**ï¼šé€éç°¡å–®çš„ä»‹é¢æäº¤ä»»å‹™ï¼Œå°±åƒåœ¨æœ¬æ©ŸåŸ·è¡Œå‘½ä»¤ä¸€æ¨£

> HakuRiver ä¸­çš„ Docker ä½œç‚ºä¸€ç¨®å¯å‹•æ…‹èª¿æ•´å’Œè‡ªå‹•åŒæ­¥çš„è™›æ“¬ç’°å¢ƒã€‚æ‚¨å¯ä»¥åŸ·è¡Œæ•¸åå€‹ä½¿ç”¨ç›¸åŒå®¹å™¨ç’°å¢ƒçš„ä»»å‹™ï¼Œä½†åœ¨å®Œå…¨ä¸åŒçš„ç¯€é»ä¸ŠåŸ·è¡Œå®ƒå€‘ã€‚

### é‹ä½œåŸç†

1. **ç’°å¢ƒç®¡ç†**ï¼šä½¿ç”¨ `hakuriver.docker` å‘½ä»¤å’Œäº’å‹•å¼ shellï¼ˆ`hakuriver.docker-shell`ï¼‰åœ¨ä¸»æ©Ÿç¯€é»ä¸Šå»ºç«‹å’Œè‡ªè¨‚ Docker å®¹å™¨ã€‚
2. **æ‰“åŒ…èˆ‡åˆ†ç™¼**ï¼šä½¿ç”¨ `hakuriver.docker create-tar` å°‡ç’°å¢ƒæ‰“åŒ…ç‚º tarball ä¸¦å­˜å„²åœ¨å…±äº«å„²å­˜ä¸­ã€‚
3. **è‡ªå‹•åŒæ­¥**ï¼šåŸ·è¡Œç¯€é»åœ¨åŸ·è¡Œä»»å‹™å‰è‡ªå‹•å¾å…±äº«å„²å­˜ç²å–æ‰€éœ€ç’°å¢ƒã€‚
4. **å¹³è¡ŒåŸ·è¡Œ**ï¼šæäº¤å–®ä¸€å‘½ä»¤æˆ–æ‰¹æ¬¡åœ¨å¤šå€‹ç¯€é»ä¸ŠåŸ·è¡Œï¼Œæ¯å€‹ä»»å‹™åœ¨è‡ªå·±çš„å®¹å™¨å¯¦ä¾‹ä¸­éš”é›¢ï¼ˆæˆ–é€šé systemd ç›´æ¥åŸ·è¡Œï¼‰ã€‚

é€™ç¨®æ–¹æ³•ç¬¦åˆä»¥ä¸‹ç†å¿µï¼š

> å°æ–¼å°å‹æœ¬åœ°å¢é›†ï¼Œæ‡‰å„ªå…ˆé¸æ“‡ã€Œè¼•é‡ã€ç°¡å–®ã€æ°å¥½è¶³å¤ ã€çš„è§£æ±ºæ–¹æ¡ˆã€‚æ‚¨ä¸éœ€è¦å°‡æ¯å€‹å‘½ä»¤æ‰“åŒ…æˆè¤‡é›œçš„ Dockerfile - Docker åœ¨é€™è£¡çš„ç›®çš„æ˜¯ç’°å¢ƒç®¡ç†å’ŒåŒæ­¥ã€‚

HakuRiver å»ºç«‹åœ¨å°å‹æœ¬åœ°å¢é›†çš„å¯¦éš›å‡è¨­åŸºç¤ä¸Šï¼š

- ç¯€é»å¯ä»¥è¼•æ˜“å»ºç«‹ç¶²è·¯é€šè¨Š
- å…±äº«å„²å­˜éš¨æ™‚å¯ç”¨
- ç„¡é ˆèªè­‰ç³»çµ±æˆ–èªè­‰è¤‡é›œæ€§å¯ä»¥æœ€å°åŒ–
- åœ¨é€™ç¨®è¦æ¨¡ä¸‹ï¼Œé«˜å¯ç”¨æ€§å’Œå®¹éŒ¯èƒ½åŠ›ä¸é‚£éº¼é—œéµ

é€éå°ˆæ³¨æ–¼å°è¦æ¨¡è¨ˆç®—çš„å¯¦éš›éœ€æ±‚ï¼ŒHakuRiver æä¾›äº†å¤šç¯€é»ä»»å‹™åŸ·è¡Œçš„ã€Œæ°åˆ°å¥½è™•ã€è§£æ±ºæ–¹æ¡ˆï¼Œç„¡éœ€æ‰¿æ“”ä¼æ¥­ç´šç³»çµ±çš„ç®¡ç†è² æ“”ã€‚

---

## ğŸ¤” HakuRiver é©ç”¨èˆ‡ä¸é©ç”¨çš„å ´æ™¯

| HakuRiver é©ç”¨æ–¼...                                                                                                             | HakuRiver ä¸é©ç”¨æ–¼...                                                                                                                    |
| :------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------- |
| âœ… ç®¡ç†å°å‹å¢é›†ä¸­çš„å‘½ä»¤åˆ—ä»»å‹™/æŒ‡ä»¤ç¢¼ï¼ˆé€šå¸¸ < 10-20 å€‹ç¯€é»ï¼‰ã€‚                                                                   | âŒ æ›¿ä»£å¤§å‹å¢é›†ä¸ŠåŠŸèƒ½è±å¯Œçš„ HPC æ’ç¨‹å™¨ï¼ˆå¦‚ Slurmã€PBSã€LSFï¼‰ã€‚                                                                         |
| âœ… **åœ¨ç”± HakuRiver ç®¡ç†çš„å¯é‡ç¾ Docker å®¹å™¨ç’°å¢ƒä¸­åŸ·è¡Œä»»å‹™ã€‚**                                                                      | âŒ å”èª¿è¤‡é›œçš„å¤šæœå‹™æ‡‰ç”¨ç¨‹å¼ï¼ˆå¦‚ Kubernetes æˆ– Docker Composeï¼‰ã€‚                                                                        |
| âœ… **åœ¨ä¸»æ©Ÿä¸Šé€²è¡Œäº’å‹•å¼ç’°å¢ƒè¨­ç½®ï¼Œä¸¦å°‡é€™äº›ç’°å¢ƒæ‰“åŒ…ç‚ºä¾¿æ”œå¼ tarball é€²è¡Œåˆ†ç™¼ã€‚**                                                    | âŒ è‡ªå‹•ç®¡ç†å®¹å™¨*å…§éƒ¨*çš„è¤‡é›œè»Ÿé«”ç›¸ä¾æ€§ï¼ˆä½¿ç”¨è€…é€éä¸»æ©Ÿçš„ shell è¨­ç½®ç’°å¢ƒï¼‰ã€‚                                                          |
| âœ… **æ–¹ä¾¿åœ°åœ¨ç¯€é»/NUMA å€åŸŸ/GPU ä¸Šæäº¤ç¨ç«‹çš„å‘½ä»¤åˆ—ä»»å‹™æˆ–æ‰¹æ¬¡å¹³è¡Œä»»å‹™ã€‚**                                                              | âŒ è¤‡é›œçš„ä»»å‹™ç›¸ä¾æ€§ç®¡ç†æˆ–å·¥ä½œæµç¨‹å”èª¿ï¼ˆè«‹ä½¿ç”¨ Airflowã€Prefectã€Snakemakeã€Nextflowï¼‰ã€‚                                                  |
| âœ… å€‹äººã€ç ”ç©¶å¯¦é©—å®¤ã€å°å‹åœ˜éšŠæˆ–å®¶åº­å¯¦é©—å®¤éœ€è¦*ç°¡å–®*çš„å¤šç¯€é»ä»»å‹™ç®¡ç†ç³»çµ±ã€‚                                                          | âŒ éƒ¨ç½²æˆ–ç®¡ç†é«˜åº¦å¯ç”¨ã€ä»»å‹™é—œéµå‹çš„ç”Ÿç”¢*æœå‹™*ã€‚                                                                                               |
| âœ… æä¾›è¼•é‡ç´šç³»çµ±ï¼Œåœ¨å—æ§ç’°å¢ƒä¸­åˆ†æ•£å¼åŸ·è¡Œä»»å‹™æ™‚éœ€è¦æœ€å°‘çš„ç¶­è­·é–‹éŠ·ã€‚                                                            | âŒ éœ€è¦å¼·å¤§å…§å»ºèªè­‰å’Œæˆæ¬Šå±¤çš„é«˜å®‰å…¨æ€§ã€å¤šç§Ÿæˆ¶ç’°å¢ƒã€‚                                                                                 |
| âœ… ä½¿ç”¨å…§å»ºçš„ `hakurun` å·¥å…·åœ¨å¢é›†æäº¤*å‰*é€²è¡Œæœ¬åœ°åƒæ•¸æƒæã€‚                                                                  | âŒ ç”¨å¢é›†æäº¤æ›¿ä»£ `hakurun` æœ¬èº« â€“ å®ƒå€‘æœå‹™æ–¼ä¸åŒç›®çš„ï¼ˆæœ¬åœ°åŸ·è¡Œ vs åˆ†æ•£å¼åŸ·è¡Œï¼‰ã€‚                                                  |

---

## âœ¨ åŠŸèƒ½ç‰¹è‰²

* **ç®¡ç† Docker ç’°å¢ƒå·¥ä½œæµç¨‹ï¼š**
    * åœ¨ä¸»æ©Ÿä¸Šè¨­ç½®æŒä¹…æ€§åŸºç¤å®¹å™¨ï¼ˆ`hakuriver.docker create-container`ï¼‰ã€‚
    * èˆ‡ä¸»æ©Ÿå®¹å™¨äº’å‹•/å®‰è£è»Ÿé«”ï¼ˆ`hakuriver.docker-shell`ï¼‰ã€‚
    * å°‡ç’°å¢ƒæäº¤ä¸¦æ‰“åŒ…æˆç‰ˆæœ¬åŒ– tarballï¼ˆ`hakuriver.docker create-tar`ï¼‰ã€‚
    * å°‡ tarball æ”¾ç½®åœ¨å…±äº«å„²å­˜ç©ºé–“ä¾›åŸ·è¡Œç¯€é»ä½¿ç”¨ã€‚
* **å®¹å™¨åŒ–ä»»å‹™åŸ·è¡Œï¼š** ä»»å‹™åœ¨ç”± HakuRiver ç®¡ç†çš„æŒ‡å®š Docker ç’°å¢ƒä¸­åŸ·è¡Œã€‚
* **è‡ªå‹•åŒ–ç’°å¢ƒåŒæ­¥ï¼š** åŸ·è¡Œç¯€é»åœ¨åŸ·è¡Œä»»å‹™å‰è‡ªå‹•æª¢æŸ¥ä¸¦å¾å…±äº«å„²å­˜åŒæ­¥æ‰€éœ€çš„å®¹å™¨ tarball ç‰ˆæœ¬ã€‚
* **Systemd å‚™ç”¨åŸ·è¡Œï¼š** é¸é …ï¼ˆ`--container NULL`ï¼‰ä½¿ç”¨ç³»çµ±çš„æœå‹™ç®¡ç†å™¨ï¼ˆ`systemd-run --scope`ï¼‰ç›´æ¥åœ¨ç¯€é»ä¸ŠåŸ·è¡Œä»»å‹™ï¼Œç”¨æ–¼ç³»çµ±ç´šå­˜å–æˆ–ä¸éœ€è¦ Docker æ™‚ã€‚
* **CPU/RAM è³‡æºåˆ†é…ï¼š** ä»»å‹™å¯è«‹æ±‚ CPU æ ¸å¿ƒï¼ˆ`--cores`ï¼‰å’Œè¨˜æ†¶é«”é™åˆ¶ï¼ˆ`--memory`ï¼‰ï¼Œé©ç”¨æ–¼ Docker å’Œ Systemd ä»»å‹™ã€‚
* **NUMA ç¯€é»å®šä½ï¼š** å¯é¸æ“‡å°‡ *systemd-run* ä»»å‹™ç¶å®šåˆ°ç‰¹å®š NUMA ç¯€é»ï¼ˆ`--target node:numa_id`ï¼‰ã€‚ï¼ˆDocker ä¸­çš„ NUMA æ”¯æ´ä»åœ¨é–‹ç™¼ä¸­ï¼‰ã€‚
* **GPU è³‡æºåˆ†é…ï¼ˆæ–°åŠŸèƒ½ï¼ï¼‰ï¼š** åœ¨ç›®æ¨™ç¯€é»ä¸Šè«‹æ±‚ç‰¹å®š GPU è¨­å‚™ï¼ˆ`--target node::gpu_id1,gpu_id2...`ï¼‰ç”¨æ–¼ Docker ä»»å‹™ã€‚åŸ·è¡Œç¯€é»é€šéå¿ƒè·³å ±å‘Šå¯ç”¨ GPUã€‚
* **å¤šç¯€é»/NUMA/GPU ä»»å‹™æäº¤ï¼š** æäº¤å–®ä¸€è«‹æ±‚ï¼ˆ`hakuriver.client`ï¼‰åœ¨å¤šå€‹æŒ‡å®šç¯€é»ã€ç‰¹å®š NUMA ç¯€é»æˆ–ç‰¹å®š GPU è¨­å‚™ä¸ŠåŸ·è¡Œç›¸åŒå‘½ä»¤ã€‚
* **æŒä¹…æ€§ä»»å‹™å’Œç¯€é»è¨˜éŒ„ï¼š** ä¸»æ©Ÿç¶­è­·ä¸€å€‹ SQLite è³‡æ–™åº«ï¼Œè¨˜éŒ„ç¯€é»ï¼ˆåŒ…æ‹¬æª¢æ¸¬åˆ°çš„ NUMA æ‹“æ’²å’Œ GPU è³‡è¨Šï¼‰å’Œä»»å‹™ï¼ˆç‹€æ…‹ã€ç›®æ¨™ã€è³‡æºã€æ—¥èªŒã€ä½¿ç”¨çš„å®¹å™¨ï¼‰ã€‚
* **ç¯€é»å¥åº·å’Œè³‡æºæ„ŸçŸ¥ï¼š** åŸºæœ¬å¿ƒè·³æª¢æ¸¬é›¢ç·šåŸ·è¡Œç¯€é»ã€‚åŸ·è¡Œç¯€é»å ±å‘Šæ•´é«” CPU/è¨˜æ†¶é«”ä½¿ç”¨æƒ…æ³ã€NUMA æ‹“æ’²å’Œ GPU è©³æƒ…ã€‚
* **ç¶²é å„€è¡¨æ¿ï¼ˆå¯¦é©—æ€§ï¼‰ï¼š** Vue.js å‰ç«¯ç”¨æ–¼è¦–è¦ºåŒ–ç›£æ§ã€ä»»å‹™æäº¤ï¼ˆåŒ…æ‹¬å¤šç›®æ¨™å’Œå®¹å™¨/GPU é¸æ“‡ï¼‰ã€ç‹€æ…‹æª¢æŸ¥å’Œçµ‚æ­¢ä»»å‹™ã€‚åŒ…æ‹¬åŸºæ–¼ Web çš„çµ‚ç«¯æ©Ÿå­˜å–ä¸»æ©Ÿå®¹å™¨å’Œæ—¥èªŒæª¢è¦–æ¨¡æ…‹ã€‚
* **ç¨ç«‹åƒæ•¸å±•é–‹å·¥å…·ï¼ˆ`hakurun`ï¼‰ï¼š** ç”¨æ–¼åœ¨æäº¤åˆ°å¢é›†å‰é€²è¡Œæœ¬åœ°åƒæ•¸æƒæçš„å·¥å…·ã€‚

---

## ğŸš€ å¿«é€Ÿå…¥é–€æŒ‡å—

### å‰ç½®éœ€æ±‚

* Python >= 3.10
* ä¸»æ©Ÿå’Œæ‰€æœ‰åŸ·è¡Œç¯€é»å‡å¯å­˜å–çš„å…±äº«æª”æ¡ˆç³»çµ±ã€‚
* **ä¸»æ©Ÿç¯€é»ï¼š** å·²å®‰è£ Docker Engineï¼ˆç”¨æ–¼ç®¡ç†ç’°å¢ƒå’Œå»ºç«‹ tarballï¼‰ã€‚
* **åŸ·è¡Œç¯€é»ï¼š** å·²å®‰è£ **Docker Engine**ï¼ˆç”¨æ–¼åŸ·è¡Œå®¹å™¨åŒ–ä»»å‹™ï¼‰ã€‚`numactl` ç‚ºå¯é¸ï¼ˆåƒ…åœ¨ä½¿ç”¨ systemd/NUMA å‚™ç”¨æ™‚éœ€è¦ï¼‰ã€‚`pynvml` å’Œ NVIDIA é©…å‹•ç¨‹å¼ç‚ºå¯é¸ï¼ˆåƒ…åœ¨éœ€è¦ GPU å ±å‘Š/åˆ†é…æ™‚éœ€è¦ï¼‰ã€‚åŸ·è¡Œç¯€é»ä½¿ç”¨è€…å¯èƒ½éœ€è¦ç„¡å¯†ç¢¼ `sudo` å­˜å–æ¬Šé™ï¼Œå–æ±ºæ–¼ Docker è¨­ç½®ï¼ˆ`docker` å‘½ä»¤ï¼‰æˆ–ä½¿ç”¨ systemd å‚™ç”¨æ™‚ï¼ˆ`systemd-run`ã€`systemctl`ï¼‰ã€‚
* **Docker Engine**ï¼šé™¤äº†å®‰è£å¤–ï¼Œæ‚¨ä¸éœ€è¦ä»»ä½•é¡å¤–çš„ Docker é…ç½®ï¼Œä½†è«‹ç¢ºä¿ data-root å’Œå„²å­˜é©…å‹•ç¨‹å¼è¨­ç½®æ­£ç¢ºã€‚HakuRiver ä½¿ç”¨é è¨­çš„ Docker å„²å­˜é©…å‹•ç¨‹å¼å’Œ data-rootï¼ˆ`/var/lib/docker`ï¼‰ï¼Œä½†å¦‚æœ‰éœ€è¦å¯åœ¨ Docker å®ˆè­·ç¨‹å¼é…ç½®ä¸­è®Šæ›´ã€‚åŸ·è¡Œ `docker run hello-world` ç¢ºèª Docker é‹ä½œæ­£å¸¸ã€‚

### æ­¥é©Ÿ

1. **å®‰è£ HakuRiver**ï¼ˆåœ¨ä¸»æ©Ÿã€åŸ·è¡Œç¯€é»å’Œå®¢æˆ¶ç«¯æ©Ÿå™¨ä¸Šï¼‰ï¼š
   ```bash
   # ä½¿ç”¨ pipï¼ˆæ¨è–¦ï¼‰
   python -m pip install hakuriver
   # åŒ…å« GPU ç›£æ§æ”¯æ´ï¼ˆéœ€è¦ pynvml å’Œ nvidia é©…å‹•ç¨‹å¼ï¼‰
   # python -m pip install "hakuriver[gpu]"

   # æˆ–å¾åŸå§‹ç¢¼å®‰è£ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰
   python -m pip install git+https://github.com/KohakuBlueleaf/HakuRiver.git
   # å¾åŸå§‹ç¢¼å®‰è£ GPU æ”¯æ´
   # python -m pip install "git+https://github.com/KohakuBlueleaf/HakuRiver.git#egg=hakuriver[gpu]"

   # æˆ–å…‹éš†ä¸¦æœ¬åœ°å®‰è£
   # git clone https://github.com/KohakuBlueleaf/HakuRiver.git
   # cd HakuRiver
   # pip install .
   # æœ¬åœ°å®‰è£ GPU æ”¯æ´
   # pip install ".[gpu]"
   ```

2. **é…ç½® HakuRiver**ï¼ˆåœ¨ä¸»æ©Ÿã€åŸ·è¡Œç¯€é»å’Œå®¢æˆ¶ç«¯ä¸Šï¼‰ï¼š
   * å»ºç«‹é è¨­é…ç½®æª”ï¼š
     ```bash
     hakuriver.init config
     ```
   * ç·¨è¼¯é…ç½®æª”ï¼ˆ`~/.hakuriver/config.toml`ï¼‰ï¼š
     ```bash
     vim ~/.hakuriver/config.toml
     ```
   * **é‡è¦**ï¼šè¨­ç½® `host_reachable_address` ç‚ºåŸ·è¡Œç¯€é»/å®¢æˆ¶ç«¯å¯å­˜å–çš„ä¸»æ©Ÿ IP/ä¸»æ©Ÿåã€‚
   * **é‡è¦**ï¼šè¨­ç½® `runner_address` ç‚ºä¸»æ©Ÿå¯å­˜å–çš„åŸ·è¡Œç¯€é» IP/ä¸»æ©Ÿåï¼ˆæ¯å€‹åŸ·è¡Œç¯€é»å¿…é ˆå”¯ä¸€ï¼‰ã€‚
   * **é‡è¦**ï¼šè¨­ç½® `shared_dir` ç‚ºå…±äº«å„²å­˜çš„çµ•å°è·¯å¾‘ï¼ˆä¾‹å¦‚ `/mnt/shared/hakuriver`ï¼‰ã€‚ç¢ºä¿æ­¤ç›®éŒ„å­˜åœ¨ä¸”å¯ç”±åŸ·è¡Œ HakuRiver å…ƒä»¶çš„ä½¿ç”¨è€…å¯«å…¥ã€‚
   * æ ¹æ“šéœ€è¦èª¿æ•´å…¶ä»–è¨­ç½®ï¼Œå¦‚é€£æ¥åŸ ã€Docker é è¨­å€¼ã€`numactl_path`ï¼ˆå¦‚ä½¿ç”¨ Systemd/NUMA å‚™ç”¨ï¼‰ã€`local_temp_dir` ç­‰ã€‚ï¼ˆè©³è¦‹ä¸‹æ–¹é…ç½®éƒ¨åˆ†ï¼‰ã€‚

3. **å•Ÿå‹•ä¸»æ©Ÿä¼ºæœå™¨**ï¼ˆåœ¨ç®¡ç†ç¯€é»ä¸Šï¼‰ï¼š
   ```bash
   hakuriver.host
   # ï¼ˆå¯é¸ï¼‰ä½¿ç”¨ç‰¹å®šé…ç½®ï¼šhakuriver.host --config /path/to/host.toml
   ```
   * **å°æ–¼ Systemdï¼š**
     ```bash
     hakuriver.init service --host [--config /path/to/host.toml]
     sudo systemctl restart hakuriver-host.service
     sudo systemctl enable hakuriver-host.service
     ```

4. **å•Ÿå‹•åŸ·è¡Œç¯€é»ä»£ç†**ï¼ˆåœ¨æ¯å€‹è¨ˆç®—ç¯€é»ä¸Šï¼‰ï¼š
   ```bash
   # ç¢ºä¿ Docker æ­£åœ¨åŸ·è¡Œä¸”ä½¿ç”¨è€…å¯ä»¥å­˜å–ï¼Œæˆ–ä½¿ç”¨ç„¡å¯†ç¢¼ sudo åŸ·è¡Œ Docker/Systemd å‘½ä»¤ã€‚
   # å¦‚ä½¿ç”¨ GPUï¼Œç¢ºä¿å·²å®‰è£ pynvml ä¸¦è¼‰å…¥é©…å‹•ç¨‹å¼ã€‚
   hakuriver.runner
   # ï¼ˆå¯é¸ï¼‰ä½¿ç”¨ç‰¹å®šé…ç½®ï¼šhakuriver.runner --config /path/to/runner.toml
   ```
   * **å°æ–¼ Systemdï¼š**
     ```bash
     hakuriver.init service --runner [--config /path/to/runner.toml]
     sudo systemctl restart hakuriver-runner.service
     sudo systemctl enable hakuriver-runner.service
     ```

5. **ï¼ˆå¯é¸ï¼‰æº–å‚™ Docker ç’°å¢ƒ**ï¼ˆåœ¨å®¢æˆ¶ç«¯/ä¸»æ©Ÿä¸Šï¼‰ï¼š
   * åœ¨ä¸»æ©Ÿä¸Šå»ºç«‹åŸºç¤å®¹å™¨ï¼š`hakuriver.docker create-container python:3.12-slim my-py312-env`
   * äº’å‹•å¼å®‰è£è»Ÿé«”ï¼š`hakuriver.docker-shell my-py312-env`ï¼ˆç„¶å¾Œ `pip install ...`ã€`apt install ...`ã€`exit`ï¼‰
   * æ‰“åŒ…ç’°å¢ƒï¼š`hakuriver.docker create-tar my-py312-env`ï¼ˆåœ¨å…±äº«å„²å­˜ä¸­å»ºç«‹ tarballï¼‰

6. **æäº¤æ‚¨çš„ç¬¬ä¸€å€‹ä»»å‹™**ï¼ˆå¾å®¢æˆ¶ç«¯æ©Ÿå™¨ï¼‰ï¼š
   ```bash
   # ä½¿ç”¨é è¨­ Docker ç’°å¢ƒåœ¨ node1 ä¸Šæäº¤ç°¡å–®çš„ echo å‘½ä»¤
   hakuriver.client --target node1 -- echo "Hello HakuRiver!"

   # åœ¨ node2 ä¸Šä½¿ç”¨è‡ªè¨‚ç’°å¢ƒå’Œ 2 æ ¸å¿ƒåŸ·è¡Œ Python æŒ‡ä»¤ç¢¼
   # ï¼ˆå‡è¨­ myscript.py åœ¨å…±äº«ç›®éŒ„ä¸­ï¼Œå¯é€é /shared å­˜å–ï¼‰
   hakuriver.client --target node2 --cores 2 --container my-py312-env -- python /shared/myscript.py --input /shared/data.csv

   # åœ¨ node3 ä¸Šä½¿ç”¨ GPU 0 å’Œ 1 æäº¤ GPU ä»»å‹™
   hakuriver.client --target node3::0,1 --container my-cuda-env -- python /shared/train_gpu_model.py

   # ç›´æ¥åœ¨ node4 ä¸ŠåŸ·è¡Œç³»çµ±å‘½ä»¤ï¼ˆç„¡ Dockerï¼‰
   hakuriver.client --target node4 --container NULL -- df -h /
   ```
   æ³¨æ„å‘½ä»¤å’Œåƒæ•¸å‰çš„ `--` åˆ†éš”ç¬¦ã€‚

7. **ç›£æ§å’Œç®¡ç†**ï¼š
   * åˆ—å‡ºç¯€é»ï¼š`hakuriver.client --list-nodes`
   * æª¢æŸ¥ä»»å‹™ç‹€æ…‹ï¼š`hakuriver.client --status <task_id>`
   * çµ‚æ­¢ä»»å‹™ï¼š`hakuriver.client --kill <task_id>`
   * æš«åœ/æ¢å¾©ä»»å‹™ï¼š`hakuriver.client pause <task_id>`ã€`hakuriver.client resume <task_id>`ï¼ˆå¦‚åŸ·è¡Œç¯€é»æ”¯æ´ï¼‰
   * ï¼ˆå¯é¸ï¼‰å­˜å– Web UIï¼ˆè¦‹å‰ç«¯éƒ¨åˆ†ï¼‰ã€‚

æœ¬æŒ‡å—æä¾›åŸºæœ¬æ­¥é©Ÿã€‚åƒè€ƒä¸‹æ–¹ç« ç¯€ç²å–æœ‰é—œé…ç½®ã€Docker å·¥ä½œæµç¨‹å’Œé€²éšç”¨æ³•çš„è©³ç´°èªªæ˜ã€‚

---

## ğŸ—ï¸ æ¶æ§‹æ¦‚è¿°
![](image/README/HakuRiverArch.jpg)

* **ä¸»æ©Ÿï¼ˆ`hakuriver.host`ï¼‰ï¼š** ä¸­å¤®å”èª¿å™¨ï¼ˆFastAPIï¼‰ã€‚
  * ç®¡ç†ç¯€é»è¨»å†Šï¼ˆåŒ…æ‹¬ NUMA æ‹“æ’²ã€GPU è³‡è¨Šï¼‰ã€‚
  * ç®¡ç† **Docker ç’°å¢ƒ**ï¼šå»ºç«‹/å•Ÿå‹•/åœæ­¢/åˆªé™¤æŒä¹…æ€§ä¸»æ©Ÿå®¹å™¨ï¼Œæäº¤/å»ºç«‹åœ¨å…±äº«å„²å­˜ä¸­çš„ç‰ˆæœ¬åŒ– tarballã€‚
  * æä¾› **WebSocket çµ‚ç«¯æ©Ÿ** å­˜å–å—ç®¡ç†çš„ä¸»æ©Ÿå®¹å™¨ã€‚
  * é€éå¿ƒè·³è¿½è¹¤ç¯€é»ç‹€æ…‹/è³‡æºã€‚
  * åœ¨ SQLite è³‡æ–™åº«ä¸­å„²å­˜ç¯€é»/ä»»å‹™è³‡è¨Šã€‚
  * æ¥æ”¶ä»»å‹™æäº¤ï¼ˆåŒ…æ‹¬å¤šç›®æ¨™ã€å®¹å™¨/GPU é¸æ“‡ï¼‰ã€‚
  * é©—è­‰ç›®æ¨™ï¼Œå°‡ä»»å‹™åˆ†é…çµ¦åŸ·è¡Œç¯€é»ï¼ˆæä¾› Docker æ˜ åƒæ¨™ç±¤æˆ–æŒ‡å®š systemd å‚™ç”¨ï¼‰ã€‚
* **åŸ·è¡Œç¯€é»ï¼ˆ`hakuriver.runner`ï¼‰ï¼š** è¨ˆç®—ç¯€é»ä¸Šçš„ä»£ç†ï¼ˆFastAPIï¼‰ã€‚
  * éœ€è¦å®‰è£ **Docker Engine**ã€‚`systemd` å’Œ `numactl` ç‚ºå¯é¸ç›¸ä¾æ€§ï¼Œç”¨æ–¼ systemd å‚™ç”¨ã€‚`pynvml` ç‚ºå¯é¸ï¼Œç”¨æ–¼ GPU ç›£æ§ã€‚
  * å‘ä¸»æ©Ÿè¨»å†Šï¼ˆå ±å‘Šæ ¸å¿ƒæ•¸ã€RAMã€NUMA è³‡è¨Šã€GPU è³‡è¨Šã€URLï¼‰ã€‚
  * ç™¼é€å®šæœŸå¿ƒè·³ï¼ˆåŒ…æ‹¬ CPU/è¨˜æ†¶é«”/GPU ä½¿ç”¨æƒ…æ³ã€æº«åº¦ï¼‰ã€‚
  * **åŸ·è¡Œä»»å‹™ï¼š**
    * **ä¸»è¦æ–¹å¼ï¼ˆDockerï¼‰ï¼š** æª¢æŸ¥å…±äº«å„²å­˜ä¸­æ˜¯å¦æœ‰æ‰€éœ€çš„å®¹å™¨ tarballï¼Œå¦‚éœ€è¦å‰‡åŒæ­¥ï¼ˆ`docker load`ï¼‰ï¼Œé€é `docker run --rm` ä½¿ç”¨æŒ‡å®šæ˜ åƒã€è³‡æºé™åˆ¶ï¼ˆ`--cpus`ã€`--memory`ã€`--gpus`ï¼‰å’Œæ›è¼‰åŸ·è¡Œä»»å‹™ã€‚
    * **å‚™ç”¨æ–¹å¼ï¼ˆSystemdï¼‰ï¼š** å¦‚æŒ‡å®š `--container NULL`ï¼Œå‰‡é€é `sudo systemd-run --scope` åŸ·è¡Œä»»å‹™ï¼Œè¨­å®šè³‡æºé™åˆ¶ï¼ˆ`CPUQuota`ã€`MemoryMax`ï¼‰å’Œå¯é¸çš„ `numactl` ç¶å®šï¼ˆ`--target node:numa_id`ï¼‰ã€‚
  * å‘ä¸»æ©Ÿå ±å‘Šä»»å‹™ç‹€æ…‹æ›´æ–°ã€‚
  * è™•ç†ä¾†è‡ªä¸»æ©Ÿçš„çµ‚æ­¢/æš«åœ/æ¢å¾©ä¿¡è™Ÿï¼ˆè½‰æ›ç‚º `docker kill/pause/unpause` æˆ– `systemctl stop/kill`ï¼‰ã€‚
  * **éœ€è¦ç„¡å¯†ç¢¼ `sudo`** ç”¨æ–¼ `systemctl`ï¼ˆå¦‚ä½¿ç”¨ systemd å‚™ç”¨ï¼‰æˆ–å¯èƒ½ç”¨æ–¼ `docker` å‘½ä»¤ï¼Œå–æ±ºæ–¼è¨­ç½®ã€‚
* **å®¢æˆ¶ç«¯ï¼ˆ`hakuriver.client`ã€`hakuriver.docker`ã€`hakuriver.docker-shell`ï¼‰ï¼š** CLI å·¥å…·ã€‚
  * èˆ‡ä¸»æ©Ÿé€šè¨Šæäº¤ä»»å‹™ï¼ˆæŒ‡å®šå‘½ä»¤ã€åƒæ•¸ã€è³‡æºã€**Docker å®¹å™¨åç¨±**å’Œ**ä¸€å€‹æˆ–å¤šå€‹ç›®æ¨™**ï¼ŒåŒ…æ‹¬ç¯€é»ã€NUMA æˆ– GPUï¼‰ã€‚
  * æŸ¥è©¢ä»»å‹™/ç¯€é»ç‹€æ…‹ï¼Œç²å–å¥åº·è³‡è¨Šã€‚
  * çµ‚æ­¢/æš«åœ/æ¢å¾©ä»»å‹™ã€‚
  * ç®¡ç†ä¸»æ©Ÿç«¯ Docker å®¹å™¨å’Œç’°å¢ƒ tarballã€‚
  * å­˜å–ä¸»æ©Ÿå®¹å™¨çš„äº’å‹•å¼ shellã€‚
* **å‰ç«¯ï¼š** å¯é¸çš„ç¶²é  UIï¼Œæä¾›é¡ä¼¼å®¢æˆ¶ç«¯çš„è¦–è¦ºåŒ–æ¦‚è¦½å’Œäº’å‹•åŠŸèƒ½ã€‚
* **è³‡æ–™åº«ï¼š** ä¸»æ©Ÿé€é Peewee ä½¿ç”¨ SQLite å„²å­˜ç¯€é»æ¸…å–®ï¼ˆåŒ…æ‹¬ NUMA æ‹“æ’²ã€GPU è³‡è¨Šï¼‰å’Œä»»å‹™è©³æƒ…ï¼ˆåŒ…æ‹¬ç›®æ¨™ NUMA IDã€æ‰€éœ€ GPUã€æ‰¹æ¬¡ IDã€ä½¿ç”¨çš„å®¹å™¨ï¼‰ã€‚
* **å„²å­˜ï¼š**
  * **å…±äº«ï¼ˆ`shared_dir`ï¼‰ï¼š** æ›è¼‰åœ¨ä¸»æ©Ÿå’Œæ‰€æœ‰åŸ·è¡Œç¯€é»ä¸Šã€‚ç”¨æ–¼ **å®¹å™¨ tarball**ã€ä»»å‹™è¼¸å‡ºæ—¥èªŒï¼ˆ`*.out`ã€`*.err`ï¼‰ä»¥åŠå¯èƒ½çš„å…±äº«æŒ‡ä»¤ç¢¼/è³‡æ–™ï¼ˆåœ¨ Docker ä»»å‹™ä¸­æ›è¼‰ç‚º `/shared`ï¼‰ã€‚
  * **æœ¬åœ°è‡¨æ™‚ï¼ˆ`local_temp_dir`ï¼‰ï¼š** ç¯€é»ç‰¹å®šçš„å¿«é€Ÿå„²å­˜ï¼Œè·¯å¾‘ä½œç‚º `HAKURIVER_LOCAL_TEMP_DIR` ç’°å¢ƒè®Šæ•¸æ³¨å…¥åˆ°ä»»å‹™ä¸­ï¼ˆåœ¨ Docker ä»»å‹™ä¸­æ›è¼‰ç‚º `/local_temp`ï¼‰ã€‚

HakuRiver çš„é€šè¨Šæµç¨‹åœ–ï¼š
![](image/README/HakuRiverFlow.jpg)

---

## ğŸ³ åŸºæ–¼ Docker çš„ç’°å¢ƒå·¥ä½œæµç¨‹

HakuRiver ä½¿ç”¨ Docker å®¹å™¨ä½œç‚ºä¾¿æ”œå¼ã€Œè™›æ“¬ç’°å¢ƒã€ã€‚ä»¥ä¸‹æ˜¯å…¸å‹å·¥ä½œæµç¨‹ï¼Œç”±å®¢æˆ¶ç«¯ä¸Šçš„ `hakuriver.docker` å‘½ä»¤è§¸ç™¼ï¼ˆèˆ‡ä¸»æ©Ÿé€šè¨Šï¼‰æˆ–ç”±åŸ·è¡Œç¯€é»è‡ªå‹•è§¸ç™¼ï¼š

1. **æº–å‚™åŸºç¤ç’°å¢ƒï¼ˆç”±ä¸»æ©ŸåŸ·è¡Œï¼‰ï¼š**
   * ä½¿ç”¨ `hakuriver.docker create-container <image> <env_name>` å¾åŸºç¤æ˜ åƒï¼ˆå¦‚ `ubuntu:latest`ã€`python:3.11`ï¼‰åœ¨ä¸»æ©Ÿä¸Šå»ºç«‹æŒä¹…å®¹å™¨ã€‚
   * å¦‚æœå®¹å™¨å·²åœæ­¢ï¼Œä½¿ç”¨ `hakuriver.docker start-container <env_name>` å•Ÿå‹•ã€‚
   * ä½¿ç”¨ `hakuriver.docker-shell <env_name>` ç²å–å®¹å™¨å…§çš„äº’å‹•å¼ shellã€‚å®‰è£å¿…è¦çš„å¥—ä»¶ï¼ˆ`apt install ...`ã€`pip install ...`ï¼‰ï¼Œé…ç½®æª”æ¡ˆç­‰ã€‚

2. **æ‰“åŒ…ç’°å¢ƒï¼ˆç”±ä¸»æ©ŸåŸ·è¡Œï¼‰ï¼š**
   * ç’°å¢ƒè¨­ç½®å®Œæˆå¾Œï¼Œä½¿ç”¨ `hakuriver.docker create-tar <env_name>`ã€‚
   * é€™æœƒå°‡å®¹å™¨ç‹€æ…‹æäº¤åˆ°æ–°çš„ Docker æ˜ åƒï¼ˆ`hakuriver/<env_name>:base`ï¼‰ï¼Œä¸¦å°‡å…¶å„²å­˜ç‚ºå¸¶æ™‚é–“æˆ³çš„ `.tar` æª”æ¡ˆåœ¨é…ç½®çš„ `shared_dir/hakuriver-containers/` ä¸­ã€‚åŒä¸€ç’°å¢ƒçš„èˆŠ tarball æœƒè‡ªå‹•æ¸…ç†ã€‚

3. **åŸ·è¡Œç¯€é»åŒæ­¥ï¼ˆè‡ªå‹•ï¼‰ï¼š**
   * ç•¶æäº¤ä»»å‹™åˆ°åŸ·è¡Œç¯€é»ä¸¦æŒ‡å®š `--container <env_name>` æ™‚ï¼ŒåŸ·è¡Œç¯€é»æœƒæª¢æŸ¥å…¶æœ¬åœ° Docker æ˜ åƒã€‚
   * å¦‚æœæ‰€éœ€æ˜ åƒï¼ˆ`hakuriver/<env_name>:base`ï¼‰ç¼ºå¤±æˆ–æ¯” `shared_dir` ä¸­çš„æœ€æ–° tarball èˆŠï¼ŒåŸ·è¡Œç¯€é»æœƒè‡ªå‹•å¾å…±äº«å„²å­˜è¼‰å…¥æœ€æ–°çš„ `.tar` æª”æ¡ˆã€‚

4. **ä»»å‹™åŸ·è¡Œï¼ˆåœ¨åŸ·è¡Œç¯€é»ä¸Šï¼‰ï¼š**
   * åŸ·è¡Œç¯€é»ä½¿ç”¨ `docker run --rm ...` åœ¨å¾å·²åŒæ­¥çš„ `hakuriver/<env_name>:base` æ˜ åƒå»ºç«‹çš„*è‡¨æ™‚*å®¹å™¨ä¸­åŸ·è¡Œæäº¤çš„å‘½ä»¤ã€‚
   * æ‡‰ç”¨è³‡æºé™åˆ¶ï¼ˆ`--cpus`ã€`--memory`ã€`--gpus`ï¼‰ã€å…±äº«ç›®éŒ„ï¼ˆ`/shared`ï¼‰ã€æœ¬åœ°è‡¨æ™‚ç›®éŒ„ï¼ˆ`/local_temp`ï¼‰å’Œä»»ä½•é¡å¤–æ›è¼‰ã€‚

æ­¤å·¥ä½œæµç¨‹ç¢ºä¿ä»»å‹™åœ¨æ‰€æœ‰ç¯€é»ä¸Šä»¥ä¸€è‡´çš„ã€é é…ç½®çš„ç’°å¢ƒåŸ·è¡Œï¼Œç„¡éœ€åœ¨æ¯å€‹åŸ·è¡Œç¯€é»ä¸Šé€²è¡Œæ‰‹å‹•è¨­ç½®ï¼Œåªéœ€å®‰è£ Docker å¼•æ“å’Œç›¸é—œé©…å‹•ç¨‹å¼ï¼ˆå¦‚ç”¨æ–¼ GPUï¼‰ã€‚

---

## `hakurun`ï¼šæœ¬åœ°åƒæ•¸å±•é–‹å·¥å…·

`hakurun` æ˜¯ä¸€å€‹**æœ¬åœ°è¼”åŠ©å·¥å…·**ï¼Œç”¨æ–¼åœ¨æäº¤åˆ° HakuRiver å¢é›†*å‰*æ¸¬è©¦å…·æœ‰å¤šç¨®åƒæ•¸çµ„åˆçš„å‘½ä»¤æˆ– Python æŒ‡ä»¤ç¢¼ã€‚å®ƒ**ä¸**èˆ‡å¢é›†æœ¬èº«äº’å‹•ã€‚

* **åƒæ•¸å±•é–‹ï¼š**
  * `span:{start..end}` -> æ•´æ•¸ï¼ˆä¾‹å¦‚ `span:{1..3}` -> `1`ã€`2`ã€`3`ï¼‰
  * `span:[a,b,c]` -> åˆ—è¡¨é …ç›®ï¼ˆä¾‹å¦‚ `span:[foo,bar]` -> `"foo"`ã€`"bar"`ï¼‰
* **åŸ·è¡Œï¼š** åŸ·è¡Œæ‰€æœ‰å±•é–‹åƒæ•¸çš„ç¬›å¡çˆ¾ç©ã€‚ä½¿ç”¨ `--parallel` é€éæœ¬åœ°å­è™•ç†å¹³è¡ŒåŸ·è¡Œçµ„åˆã€‚
* **ç›®æ¨™ï¼š** åŸ·è¡Œ Python æ¨¡çµ„ï¼ˆ`mymod`ï¼‰ã€å‡½æ•¸ï¼ˆ`mymod:myfunc`ï¼‰æˆ–å¯åŸ·è¡Œæª”ï¼ˆ`python script.py`ã€`my_executable`ï¼‰ã€‚

**ç¯„ä¾‹ï¼ˆ`demo_hakurun.py`ï¼‰ï¼š**

```python
# demo_hakurun.py
import sys, time, random, os
time.sleep(random.random() * 0.1)
# åˆ—å°å¾ hakurun æ¥æ”¶çš„åƒæ•¸ï¼ˆsys.argv[0] æ˜¯æŒ‡ä»¤ç¢¼åç¨±ï¼‰
print(f"Args: {sys.argv[1:]}, PID: {os.getpid()}")
```

```bash
# æœ¬åœ°ä¸¦è¡ŒåŸ·è¡Œ 2 * 1 * 2 = 4 å€‹ä»»å‹™
hakurun --parallel python ./demo_hakurun.py span:{1..2} fixed_arg span:[input_a,input_b]
```

ä½¿ç”¨ `hakurun` ç”Ÿæˆå‘½ä»¤ï¼Œä¹‹å¾Œå¯ä»¥ä½¿ç”¨ `hakuriver.client` å€‹åˆ¥æˆ–æ‰¹æ¬¡æäº¤ï¼Œä»¥åœ¨å¢é›†ä¸Šçš„ç‰¹å®š Docker ç’°å¢ƒ*å…§*åŸ·è¡Œã€‚

---

## ğŸ”§ é…ç½® - HakuRiver

* å»ºç«‹é è¨­é…ç½®ï¼š`hakuriver.init config`ã€‚é€™æœƒå»ºç«‹ `~/.hakuriver/config.toml`ã€‚
* æŸ¥çœ‹ä¸¦ç·¨è¼¯é è¨­é…ç½®ï¼ˆ`src/hakuriver/utils/default_config.toml` é¡¯ç¤ºé è¨­å€¼ï¼‰ã€‚
* ä»»ä½• `hakuriver.*` å‘½ä»¤å¯ç”¨ `--config /path/to/custom.toml` è¦†è“‹ã€‚
* **éœ€è¦æª¢è¦–/ç·¨è¼¯çš„é—œéµè¨­ç½®ï¼š**
  * `[network] host_reachable_address`ï¼š**å¿…é ˆ**æ˜¯åŸ·è¡Œç¯€é»å’Œå®¢æˆ¶ç«¯å¯å­˜å–çš„ä¸»æ©Ÿ IP/ä¸»æ©Ÿåã€‚
  * `[network] runner_address`ï¼š**å¿…é ˆ**æ˜¯ä¸»æ©Ÿå¯å­˜å–çš„åŸ·è¡Œç¯€é» IP/ä¸»æ©Ÿåã€‚ï¼ˆæ¯å€‹åŸ·è¡Œç¯€é»éœ€å”¯ä¸€ï¼‰ã€‚
  * `[paths] shared_dir`ï¼šå…±äº«å„²å­˜çš„çµ•å°è·¯å¾‘ï¼ˆå¿…é ˆåœ¨ä¸»æ©Ÿå’ŒåŸ·è¡Œç¯€é»ä¸Šå­˜åœ¨ä¸”å¯å¯«å…¥ï¼‰ã€‚**å°æ—¥èªŒå’Œå®¹å™¨ tarball è‡³é—œé‡è¦ã€‚**
  * `[paths] local_temp_dir`ï¼šæœ¬åœ°è‡¨æ™‚å„²å­˜çš„çµ•å°è·¯å¾‘ï¼ˆå¿…é ˆåœ¨åŸ·è¡Œç¯€é»ä¸Šå­˜åœ¨ä¸”å¯å¯«å…¥ï¼‰ã€‚æ³¨å…¥åˆ°å®¹å™¨ä¸­ä½œç‚º `/local_temp`ã€‚
  * `[paths] numactl_path`ï¼šåŸ·è¡Œç¯€é»ä¸Š `numactl` å¯åŸ·è¡Œæª”çš„çµ•å°è·¯å¾‘ï¼ˆåƒ…åœ¨ä½¿ç”¨ systemd å‚™ç”¨æ™‚éœ€è¦ï¼‰ã€‚
  * `[docker] container_dir`ï¼š`shared_dir` å…§ç”¨æ–¼å®¹å™¨ tarball çš„å­ç›®éŒ„ã€‚
  * `[docker] default_container_name`ï¼šä»»å‹™æäº¤æ™‚æœªæŒ‡å®š `--container` çš„é è¨­ç’°å¢ƒåç¨±ã€‚
  * `[docker] initial_base_image`ï¼šä¸»æ©Ÿå•Ÿå‹•æ™‚é è¨­ tarball ä¸å­˜åœ¨æ™‚ä½¿ç”¨çš„å…¬å…± Docker æ˜ åƒã€‚
  * `[docker] tasks_privileged`ï¼šåŸ·è¡Œç‰¹æ¬Šå®¹å™¨çš„é è¨­è¨­ç½®ã€‚
  * `[docker] additional_mounts`ï¼šä»»å‹™çš„é è¨­ã€Œä¸»æ©Ÿ:å®¹å™¨ã€æ›è¼‰åˆ—è¡¨ã€‚
  * `[database] db_file`ï¼šä¸»æ©Ÿ SQLite è³‡æ–™åº«çš„è·¯å¾‘ã€‚ç¢ºä¿ç›®éŒ„å­˜åœ¨ã€‚

---

## ğŸ’» ä½¿ç”¨æ–¹æ³• - HakuRiver å¢é›† (CLI)

æœ¬ç¯€è©³è¿°è¨­ç½®ã€ç®¡ç†ç’°å¢ƒå’ŒåŸ·è¡Œä»»å‹™çš„æ ¸å¿ƒå‘½ä»¤ã€‚

### åˆå§‹è¨­ç½®

éµå¾ªä¸Šæ–¹çš„**å¿«é€Ÿå…¥é–€æŒ‡å—**é€²è¡Œå®‰è£ã€é…ç½®å’Œå•Ÿå‹•ä¸»æ©Ÿ/åŸ·è¡Œç¯€é»ã€‚

### ç®¡ç† Docker ç’°å¢ƒ

HakuRiver å…è¨±æ‚¨ç›´æ¥åœ¨ä¸»æ©Ÿä¸Šç®¡ç† Docker ç’°å¢ƒï¼Œæ‰“åŒ…å®ƒå€‘ï¼Œä¸¦é€éå…±äº«å„²å­˜åˆ†ç™¼ï¼Œä½¿ç”¨ `hakuriver.docker` å’Œ `hakuriver.docker-shell` å‘½ä»¤ã€‚

**Docker ç®¡ç†å‘½ä»¤åƒè€ƒï¼š**

| æ“ä½œ                          | å‘½ä»¤ç¯„ä¾‹                                                      | å‚™è¨»                                                             |
| :---------------------------- | :----------------------------------------------------------- | :-------------------------------------------------------------- |
| åˆ—å‡ºä¸»æ©Ÿå®¹å™¨                  | `hakuriver.docker list-containers`                            | é¡¯ç¤ºä¸»æ©Ÿä¸Šçš„æŒä¹…å®¹å™¨ã€‚                                          |
| å»ºç«‹ä¸»æ©Ÿå®¹å™¨                  | `hakuriver.docker create-container <image> <env_name>`        | å¾ `<image>` åœ¨ä¸»æ©Ÿä¸Šå»ºç«‹å®¹å™¨ã€‚                                 |
| å•Ÿå‹•ä¸»æ©Ÿå®¹å™¨                  | `hakuriver.docker start-container <env_name>`                 | å¦‚å·²åœæ­¢å‰‡å•Ÿå‹•å®¹å™¨ã€‚                                            |
| åœæ­¢ä¸»æ©Ÿå®¹å™¨                  | `hakuriver.docker stop-container <env_name>`                  | åœæ­¢å®¹å™¨ã€‚                                                      |
| äº’å‹•å¼ Shell                  | `hakuriver.docker-shell <env_name>`                           | é–‹å•Ÿä¸»æ©Ÿå®¹å™¨å…§çš„äº’å‹•å¼ shellã€‚                                  |
| å»ºç«‹/æ›´æ–° Tarball             | `hakuriver.docker create-tar <env_name>`                      | æäº¤å®¹å™¨ï¼Œåœ¨ `shared_dir` ä¸­å»ºç«‹/æ›´æ–° tarballã€‚                 |
| åˆ—å‡ºå¯ç”¨ Tarball              | `hakuriver.docker list-tars`                                  | é¡¯ç¤º `shared_dir` ä¸­æ‰“åŒ…çš„ç’°å¢ƒã€‚                                |
| åˆªé™¤ä¸»æ©Ÿå®¹å™¨                  | `hakuriver.docker delete-container <env_name>`                | å¾ä¸»æ©Ÿåˆªé™¤æŒä¹…å®¹å™¨ï¼ˆtarball ä¿ç•™ï¼‰ã€‚                            |

### æäº¤å’Œç®¡ç†ä»»å‹™

ä½¿ç”¨ `hakuriver.client` èˆ‡å¢é›†äº’å‹•ä¸¦æäº¤ä»»å‹™ã€‚

**ä»»å‹™æäº¤ç¯„ä¾‹ï¼š**

* **åœ¨ node1 ä¸Šä½¿ç”¨è‡ªè¨‚ Python ç’°å¢ƒåŸ·è¡ŒæŒ‡ä»¤ç¢¼ï¼š**
  ```bash
  hakuriver.client --target node1 --container my-py311-env -- python /shared/analyze_data.py --input data.csv
  ```
  *ï¼ˆå‡è¨­ `analyze_data.py` åœ¨å®¹å™¨å…§çš„ `/shared/analyze_data.py` å¯å­˜å–ï¼Œé€šå¸¸æ˜ å°„åˆ°æ‚¨çš„ `shared_dir`ï¼‰*

* **ä½¿ç”¨é è¨­ç’°å¢ƒåœ¨å¤šå€‹ç¯€é»ä¸ŠåŸ·è¡Œå‘½ä»¤ï¼š**
  ```bash
  hakuriver.client --target node1 --target node3 --cores 2 --memory 512M -- my_processing_tool --verbose /shared/input_file
  ```
  *ï¼ˆä½¿ç”¨é…ç½®ä¸­çš„ `default_container_name`ï¼Œæ¯å€‹ä»»å‹™åˆ†é… 2 æ ¸å¿ƒå’Œ 512MB RAMï¼‰*

* **ç›´æ¥åœ¨ node2 ä¸ŠåŸ·è¡Œç³»çµ±å‘½ä»¤ï¼ˆç„¡ Dockerï¼‰ï¼š**
  ```bash
  hakuriver.client --target node2 --container NULL -- df -h /
  ```

* **åœ¨ node1 çš„ NUMA ç¯€é» 0 ä¸ŠåŸ·è¡Œ Systemd ä»»å‹™ï¼š**
  ```bash
  hakuriver.client --target node1:0 --container NULL --cores 4 -- ./run_numa_benchmark.sh
  ```

* **åœ¨ node3 ä¸Šä½¿ç”¨è¨­å‚™ 0 å’Œ 1 åŸ·è¡Œ GPU ä»»å‹™ï¼š**
  ```bash
  hakuriver.client --target node3::0,1 --container my-cuda-env -- python /shared/train_gpu_model.py
  ```
  *ï¼ˆæ³¨æ„ï¼šGPU åˆ†é…ç›®å‰éœ€è¦ Docker å®¹å™¨ç’°å¢ƒï¼Œä¸æ”¯æ´ Systemd å‚™ç”¨ï¼‰*

**ä»»å‹™ç®¡ç†å‘½ä»¤åƒè€ƒï¼š**

| æ“ä½œ                             | å‘½ä»¤ç¯„ä¾‹                                                                               | å‚™è¨»                                                                |
| :------------------------------- | :------------------------------------------------------------------------------------- | :----------------------------------------------------------------- |
| åˆ—å‡ºç¯€é»                         | `hakuriver.client --list-nodes`                                                        | é¡¯ç¤ºç‹€æ…‹ã€æ ¸å¿ƒæ•¸ã€NUMAã€GPU æ‘˜è¦ã€‚                                  |
| ç¯€é»å¥åº·                         | `hakuriver.client --health [<node>]`                                                   | ç‰¹å®šç¯€é»æˆ–æ‰€æœ‰ç¯€é»çš„è©³ç´°çµ±è¨ˆè³‡æ–™ï¼ˆåŒ…æ‹¬ GPUï¼‰ã€‚                      |
| æäº¤ä»»å‹™                         | `hakuriver.client [é¸é …] -- å‘½ä»¤ [åƒæ•¸...]`                                            | æäº¤ä»»å‹™ã€‚è¦‹ä¸Šæ–¹ç¯„ä¾‹å’Œä¸‹æ–¹é¸é …ã€‚                                    |
| æª¢æŸ¥ç‹€æ…‹                         | `hakuriver.client --status <task_id>`                                                  | é¡¯ç¤ºè©³ç´°ç‹€æ…‹ï¼ˆåŒ…æ‹¬ç›®æ¨™ã€æ‰¹æ¬¡ IDã€å®¹å™¨ã€GPUï¼‰ã€‚                      |
| çµ‚æ­¢ä»»å‹™                         | `hakuriver.client --kill <task_id>`                                                    | è«‹æ±‚çµ‚æ­¢ï¼ˆDocker/systemdï¼‰ã€‚                                        |
| æš«åœä»»å‹™                         | `hakuriver.client pause <task_id>`                                                     | è«‹æ±‚æš«åœï¼ˆDocker/systemdï¼‰ã€‚éœ€è¦åŸ·è¡Œç¯€é»æ”¯æ´ã€‚                      |
| æ¢å¾©ä»»å‹™                         | `hakuriver.client resume <task_id>`                                                    | è«‹æ±‚æ¢å¾©ï¼ˆDocker/systemdï¼‰ã€‚éœ€è¦åŸ·è¡Œç¯€é»æ”¯æ´ã€‚                      |
| æäº¤ + ç­‰å¾…                      | `hakuriver.client --wait ...`                                                          | ç­‰å¾…æäº¤çš„ä»»å‹™å®Œæˆã€‚                                                |
| çµåˆ `hakurun`ï¼ˆå¤šå€‹ä»»å‹™ï¼‰       | `hakurun hakuriver.client --container <env> -- python script.py span:{1..10}`          | æäº¤ 10 å€‹ç¨ç«‹çš„ HakuRiver ä»»å‹™ã€‚                                   |
| çµåˆ `hakurun`ï¼ˆå–®å€‹ä»»å‹™ï¼‰       | `hakuriver.client --container <env> -- hakurun --parallel python proc.py span:{A..Z}`  | æäº¤ 1 å€‹åœ¨å…§éƒ¨åŸ·è¡Œ `hakurun` çš„ HakuRiver ä»»å‹™ã€‚                   |

**`hakuriver.client` ä»»å‹™æäº¤é¸é …ï¼š**

| é¸é …                          | æè¿°                                                                                                                |
| :---------------------------- | :------------------------------------------------------------------------------------------------------------------ |
| `--target <node[:n][::g]>`   | **å¿…éœ€ã€‚** æŒ‡å®šç›®æ¨™ã€‚å¯é‡è¤‡ä»¥æŒ‡å®šå¤šå€‹ç›®æ¨™ã€‚<br>`node`ï¼šä¸»æ©Ÿåã€‚<br>`:n`ï¼šå¯é¸ NUMA ç¯€é» IDã€‚<br>`::g`ï¼šå¯é¸é€—è™Ÿåˆ†éš”çš„ GPU IDï¼ˆä¾‹å¦‚ `::0` æˆ– `::0,1,3`ï¼‰ã€‚GPU ç›®æ¨™éœ€è¨­ç½® `--container`ã€‚ |
| `--cores N`                  | æ¯å€‹ä»»å‹™å¯¦ä¾‹éœ€è¦çš„ CPU æ ¸å¿ƒæ•¸ã€‚                                                                                      |
| `--memory å¤§å°`              | æ¯å€‹ä»»å‹™å¯¦ä¾‹çš„è¨˜æ†¶é«”é™åˆ¶ï¼ˆä¾‹å¦‚ `512M`ã€`4G`ï¼‰ã€‚ä½¿ç”¨ 1000 é€²ä½å–®ä½ï¼ˆKã€Mã€Gï¼‰ã€‚                                      |
| `--env KEY=VALUE`            | åœ¨ä»»å‹™ç’°å¢ƒä¸­è¨­ç½®ç’°å¢ƒè®Šæ•¸ï¼ˆå¯é‡è¤‡ï¼‰ã€‚                                                                                |
| `--container åç¨±`           | HakuRiver å®¹å™¨ç’°å¢ƒåç¨±ã€‚ä½¿ç”¨ `NULL` è¡¨ç¤º Systemd å‚™ç”¨ï¼ˆç„¡ Dockerï¼‰ã€‚é è¨­ç‚ºä¸»æ©Ÿé…ç½®ã€‚                                |
| `--privileged`               | ä»¥ `--privileged` åŸ·è¡Œ Docker å®¹å™¨ï¼ˆè¦†è“‹é è¨­å€¼ï¼Œè¬¹æ…ä½¿ç”¨ï¼‰ã€‚                                                         |
| `--mount ä¸»æ©Ÿè·¯å¾‘:å®¹å™¨è·¯å¾‘`   | é¡å¤–çš„ä¸»æ©Ÿç›®éŒ„æ›è¼‰åˆ° Docker ä»»å‹™å®¹å™¨ä¸­ï¼ˆå¯é‡è¤‡ï¼Œè¦†è“‹é è¨­å€¼ï¼‰ã€‚                                                      |
| `--wait`                     | ç­‰å¾…æäº¤çš„ä»»å‹™å®Œæˆå¾Œå†é€€å‡ºã€‚                                                                                        |
| `--poll-interval ç§’`         | ä½¿ç”¨ `--wait` æ™‚ç‹€æ…‹æª¢æŸ¥çš„é–“éš”ï¼ˆç§’ï¼‰ã€‚                                                                              |

---

## ğŸŒ ä½¿ç”¨æ–¹æ³• - å‰ç«¯ Web UIï¼ˆå¯¦é©—æ€§ï¼‰

| æ¦‚è¦½                                           | ç¯€é»åˆ—è¡¨å’Œä»»å‹™åˆ—è¡¨                                                                             | å¾ç®¡ç†å™¨ UI æäº¤ä»»å‹™                            |
| ---------------------------------------------- | ---------------------------------------------------------------------------------------------- | ----------------------------------------------- |
| ![1744643963836](image/README/1744643963836.png) | ![1744643981874](image/README/1744643981874.png) ![1744643997740](image/README/1744643997740.png) | ![1744644009190](image/README/1744644009190.png) |

HakuRiver åŒ…å«ä¸€å€‹å¯é¸çš„ Vue.js å„€è¡¨æ¿ï¼Œç”¨æ–¼è¦–è¦ºåŒ–ç›£æ§å’Œç®¡ç†ã€‚

**å‰ç½®éœ€æ±‚ï¼š**

* Node.js å’Œ npm/yarn/pnpmã€‚
* å¯å¾é‹è¡Œå‰ç«¯é–‹ç™¼ä¼ºæœå™¨çš„ä½ç½®å­˜å–çš„é‹è¡Œä¸­ HakuRiver ä¸»æ©Ÿã€‚

**è¨­ç½®ï¼š**

```bash
cd frontend
npm install
```

**åŸ·è¡Œï¼ˆé–‹ç™¼ï¼‰ï¼š**

1. ç¢ºä¿ä¸»æ©Ÿæ­£åœ¨é‹è¡Œï¼ˆä¾‹å¦‚ `http://127.0.0.1:8000`ï¼‰ã€‚
2. å•Ÿå‹• Vite é–‹ç™¼ä¼ºæœå™¨ï¼š
   ```bash
   npm run dev
   ```
3. é–‹å•Ÿæä¾›çš„ URLï¼ˆä¾‹å¦‚ `http://localhost:5173`ï¼‰ã€‚
4. é–‹ç™¼ä¼ºæœå™¨å°‡ `/api` è«‹æ±‚ä»£ç†åˆ°ä¸»æ©Ÿï¼ˆè¦‹ `vite.config.js`ï¼‰ã€‚
5. **åŠŸèƒ½ï¼š**
   * æŸ¥çœ‹ç¯€é»åˆ—è¡¨ã€ç‹€æ…‹ã€è³‡æºã€NUMA æ‹“æ’²å’Œ **GPU è©³æƒ…**ã€‚
   * æŸ¥çœ‹ä»»å‹™åˆ—è¡¨ã€è©³æƒ…ï¼ˆåŒ…æ‹¬æ‰¹æ¬¡ IDã€ç›®æ¨™ NUMAã€æ‰€éœ€ GPUã€å®¹å™¨ï¼‰ã€‚
   * ä½¿ç”¨è¡¨å–®æäº¤æ–°ä»»å‹™ï¼ˆå…è¨± **å¤šç›®æ¨™** é¸æ“‡ï¼ŒåŒ…æ‹¬ç¯€é»ã€NUMA å’Œ **GPU é¸æ“‡**ï¼Œä»¥åŠ **Docker å®¹å™¨** é¸æ“‡ï¼‰ã€‚
   * çµ‚æ­¢/æš«åœ/æ¢å¾©åŸ·è¡Œä¸­çš„ä»»å‹™ã€‚
   * æŸ¥çœ‹ä»»å‹™ stdout/stderr æ—¥èªŒï¼ˆé€éæ—¥èªŒæ¨¡æ…‹è¦–çª—ï¼‰ã€‚
   * é€éçµ‚ç«¯æ¨¡æ…‹è¦–çª—å­˜å–ä¸»æ©Ÿå®¹å™¨çš„äº’å‹•å¼çµ‚ç«¯ã€‚

**å»ºç½®ï¼ˆç”Ÿç”¢ï¼‰ï¼š**

1. å»ºç½®éœæ…‹æª”æ¡ˆï¼š
   ```bash
   npm run build
   ```
2. ä½¿ç”¨ä»»ä½•éœæ…‹ç¶²é ä¼ºæœå™¨ï¼ˆNginxã€Apache ç­‰ï¼‰æä¾› `frontend/dist` çš„å…§å®¹ã€‚
3. **é‡è¦ï¼š** é…ç½®æ‚¨çš„ç”Ÿç”¢ç¶²é ä¼ºæœå™¨ä»¥ä»£ç† API è«‹æ±‚ï¼ˆä¾‹å¦‚å° `/api/*` çš„è«‹æ±‚ï¼‰åˆ°å¯¦éš›é‹è¡Œçš„ HakuRiver ä¸»æ©Ÿåœ°å€å’Œé€£æ¥åŸ ï¼Œæˆ–åœ¨å»ºç½®å‰ä¿®æ”¹ `src/services/api.js` ä»¥ä½¿ç”¨ä¸»æ©Ÿçš„çµ•å° URLã€‚

---

## ğŸ“ æœªä¾†å·¥ä½œ / å¾…è¾¦äº‹é …

* **Docker å…§çš„ NUMA æ„ŸçŸ¥ï¼š** å¯¦ç¾æ©Ÿåˆ¶ï¼Œæ ¹æ“š `--target node:numa_id` èªæ³•å°‡ NUMA ç¶å®šåå¥½ï¼ˆ`--cpuset-cpus`ã€`--cpuset-mems`ï¼‰å‚³éçµ¦ `docker run`ã€‚
* **åŸºæœ¬æ’ç¨‹ç­–ç•¥ï¼š** æ¢ç´¢å…¶ä»–ç°¡å–®ä½†æœ‰ç”¨çš„é¸é …ï¼Œè€Œä¸åƒ…åƒ…æ˜¯ç°¡å–®çš„ã€Œæœ€å…ˆé©åˆã€ç¯€é»é¸æ“‡ã€‚ä¾‹å¦‚è¼ªè©¢ã€æœ€ä½è² è¼‰ã€åŸºæ–¼å„ªå…ˆç´šç­‰ã€‚

## ğŸ™ è‡´è¬

* Gemini 2.5 proï¼šåŸºæœ¬å¯¦ç¾å’Œåˆå§‹ README ç”Ÿæˆã€‚
* Gemini 2.5 flashï¼šREADME/æ–‡ä»¶æ”¹é€²ã€‚
* Claude 3.7 Sonnetï¼šå„ªåŒ– logo SVG ç¨‹å¼ç¢¼ã€‚